<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4720px" preserveAspectRatio="none" style="width:1518px;height:4720px;" version="1.1" viewBox="0 0 1518 4720" width="1518px" zoomAndPan="magnify"><defs><filter height="300%" id="f1ki1haweeiur" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="357" x="581.5" y="23.5352">6.2.1. Trigger Settlement Event (createSettlement)</text><rect fill="#FFB6C1" height="4675.3672" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="75" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="90.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="4675.3672" style="stroke: #A80036; stroke-width: 1.0;" width="422.5" x="318.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="467.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="4675.3672" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1113" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1116" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="4467.0801" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="126" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="4213.7324" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="396" y="400.6348"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="289.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="445.2559"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="304.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="1019.1953"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="2445.8496" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="1648.2012"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="474.5664"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1048.5059"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1741.1328"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1848.375"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="353.5215" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1956.3066"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2339.1387"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2549.9336"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2697.4863"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2927.9023"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3397.666"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3535.5293"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3672.7715"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3810.6348"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3940.877"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="4452.0801" style="stroke: #000000; stroke-width: 2.0;" width="1494" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="225.6602" style="stroke: #000000; stroke-width: 2.0;" width="515" x="37" y="749.9141"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="201.7949" style="stroke: #000000; stroke-width: 2.0;" width="509" x="43" y="1339.1641"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="3005.0977" style="stroke: #000000; stroke-width: 2.0;" width="1474" x="23" y="1594.2695"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="2249.3652" style="stroke: #000000; stroke-width: 2.0;" width="894" x="593" y="1663.2012"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="661.8691" style="stroke: #000000; stroke-width: 2.0;" width="869" x="613" y="2658.8652"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="309.7266" style="stroke: #000000; stroke-width: 2.0;" width="825" x="603" y="3334.7344"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="278.416" style="stroke: #000000; stroke-width: 2.0;" width="805" x="613" y="3359.0449"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="131" x2="131" y1="137.2871" y2="4623.3672"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="400.5" x2="400.5" y1="137.2871" y2="4623.3672"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="680" x2="680" y1="137.2871" y2="4623.3672"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1170" x2="1170" y1="137.2871" y2="4623.3672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="79" y="134.334">Hub Employee</text><ellipse cx="131" cy="63.7988" fill="#FEFECE" filter="url(#f1ki1haweeiur)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M131,71.7988 L131,98.7988 M118,79.7988 L144,79.7988 M131,98.7988 L118,113.7988 M131,98.7988 L144,113.7988 " fill="none" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="79" y="4635.9023">Hub Employee</text><ellipse cx="131" cy="4648.8555" fill="#FEFECE" filter="url(#f1ki1haweeiur)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M131,4656.8555 L131,4683.8555 M118,4664.8555 L144,4664.8555 M131,4683.8555 L118,4698.8555 M131,4683.8555 L144,4698.8555 " fill="none" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="322.5" y="134.334">Settlement Service API</text><path d="M380.5,92.7988 L380.5,116.7988 M380.5,104.7988 L397.5,104.7988 " fill="none" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="409.5" cy="104.7988" fill="#FEFECE" filter="url(#f1ki1haweeiur)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="322.5" y="4635.9023">Settlement Service API</text><path d="M380.5,4642.8555 L380.5,4666.8555 M380.5,4654.8555 L397.5,4654.8555 " fill="none" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="409.5" cy="4654.8555" fill="#FEFECE" filter="url(#f1ki1haweeiur)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="623" y="134.334">Settlement DAO</text><ellipse cx="680" cy="104.7988" fill="#FEFECE" filter="url(#f1ki1haweeiur)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="668" x2="692" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="623" y="4635.9023">Settlement DAO</text><ellipse cx="680" cy="4654.8555" fill="#FEFECE" filter="url(#f1ki1haweeiur)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="668" x2="692" y1="4668.8555" y2="4668.8555"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1122" y="134.334">Central Store</text><path d="M1152,84.7988 C1152,74.7988 1170,74.7988 1170,74.7988 C1170,74.7988 1188,74.7988 1188,84.7988 L1188,110.7988 C1188,120.7988 1170,120.7988 1170,120.7988 C1170,120.7988 1152,120.7988 1152,110.7988 L1152,84.7988 " fill="#FEFECE" filter="url(#f1ki1haweeiur)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1152,84.7988 C1152,94.7988 1170,94.7988 1170,94.7988 C1170,94.7988 1188,94.7988 1188,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1122" y="4635.9023">Central Store</text><path d="M1152,4648.8555 C1152,4638.8555 1170,4638.8555 1170,4638.8555 C1170,4638.8555 1188,4638.8555 1188,4648.8555 L1188,4674.8555 C1188,4684.8555 1170,4684.8555 1170,4684.8555 C1170,4684.8555 1152,4684.8555 1152,4674.8555 L1152,4648.8555 " fill="#FEFECE" filter="url(#f1ki1haweeiur)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1152,4648.8555 C1152,4658.8555 1170,4658.8555 1170,4658.8555 C1170,4658.8555 1188,4658.8555 1188,4648.8555 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="4467.0801" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="126" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="4213.7324" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="396" y="400.6348"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="289.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="445.2559"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="304.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="1019.1953"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="2445.8496" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="675" y="1648.2012"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="474.5664"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1048.5059"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1741.1328"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1848.375"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="353.5215" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="1956.3066"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2339.1387"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2549.9336"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2697.4863"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="2927.9023"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3397.666"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3535.5293"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3672.7715"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3810.6348"/><rect fill="#FFFFFF" filter="url(#f1ki1haweeiur)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1165" y="3940.877"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4452.0801" style="stroke: #000000; stroke-width: 2.0;" width="1494" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Trigger Settlement Event</text><path d="M141,176.5977 L141,369.5977 L396,369.5977 L396,186.5977 L386,176.5977 L141,176.5977 " fill="#FFFF00" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M386,176.5977 L386,186.5977 L396,186.5977 L386,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="163" y="209.4766">"settlementModelName": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="163" y="224.7871">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="163" y="240.0977">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="255.4082">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="270.7188">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="179" y="286.0293">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="301.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="316.6504">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="331.9609">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="347.2715">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="362.582">}</text><polygon fill="#A80036" points="384,396.6348,394,400.6348,384,404.6348,388,400.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="136" x2="390" y1="400.6348" y2="400.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="143" y="395.8926">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="156" y="395.8926">POST - /settlements</text><polygon fill="#A80036" points="663,441.2559,673,445.2559,663,449.2559,667,445.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406" x2="669" y1="445.2559" y2="445.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="432.8584">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="426" y="425.2031">Request settlementModel</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="426" y="440.5137">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="503" y="440.5137">2001</text><polygon fill="#A80036" points="1153,470.5664,1163,474.5664,1153,478.5664,1157,474.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="474.5664" y2="474.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="692" y="469.8242">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="705" y="469.8242">Retrieve settlementModel</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="944,487.5664,1396,487.5664,1406,582.5664,1396,678.5664,944,678.5664,934,582.5664,944,487.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="946" y="504.1348">SELECT sg.name settlementGranularity, si.name settlementInterchange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="962" y="519.4453">sd.name settlementDelay, sm.ledgerAccountTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="962" y="534.7559">sm.currencyId, sm.requireLiquidityCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="946" y="550.0664">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="986" y="550.0664">settlementModel</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1103" y="550.0664">sm</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="946" y="565.377">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="978" y="565.377">settlementGranularity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1131" y="565.377">sg</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="946" y="580.6875">ON sg.settlementGranularityId = sm.settlementGranularityId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="946" y="595.998">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="978" y="595.998">settlementInterchange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="1136" y="595.998">si</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="946" y="611.3086">ON si.settlementInterchangeId = sm.settlementInterchangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="946" y="626.6191">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="978" y="626.6191">settlementDelay</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1092" y="626.6191">sd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="946" y="641.9297">ON sd.settlementDelayId = sm.settlementDelayId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="946" y="657.2402">WHERE name = {settlementModelName}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="946" y="672.5508">AND isActive = 1</text><polygon fill="#A80036" points="696,701.6035,686,705.6035,696,709.6035,692,705.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="705.6035" y2="705.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="702" y="700.8613">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="715" y="700.8613">Return data</text><polygon fill="#A80036" points="417,730.9141,407,734.9141,417,738.9141,413,734.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411" x2="679" y1="734.9141" y2="734.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="423" y="730.1719">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="436" y="730.1719">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="187" x="481" y="730.1719">settlementModelData (smd)</text><path d="M37,749.9141 L121,749.9141 L121,756.9141 L111,766.9141 L37,766.9141 L37,749.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="225.6602" style="stroke: #000000; stroke-width: 2.0;" width="515" x="37" y="749.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="52" y="763.4824">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="212" x="136" y="762.5488">[smd.settlementGranularity != 'NET' ||</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="275" x="136" y="775.5039">smd.settlementInterchange != 'MULTILATERAL' ||</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="136" y="788.459">smd.settlementDelay != 'DEFERRED']</text><path d="M411,796.0898 L411,821.0898 L538,821.0898 L538,806.0898 L528,796.0898 L411,796.0898 " fill="#D3D3D3" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M528,796.0898 L528,806.0898 L538,806.0898 L528,796.0898 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="417" y="813.6582">Log ERROR event</text><path d="M47,835.4004 L47,936.4004 L387,936.4004 L387,845.4004 L377,835.4004 L47,835.4004 " fill="#FFFF00" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,835.4004 L377,845.4004 L387,845.4004 L377,835.4004 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="852.9688">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="69" y="868.2793">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="85" y="883.5898">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="85" y="898.9004">"errorDescription": "Invalid settlement model"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="914.2109">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="929.5215">}</text><polygon fill="#A80036" points="147,963.5742,137,967.5742,147,971.5742,143,967.5742" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="141" x2="395" y1="967.5742" y2="967.5742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="153" y="962.832">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="166" y="962.832">Respond HTTP - 4xx (Client error)</text><polygon fill="#A80036" points="663,1015.1953,673,1019.1953,663,1023.1953,667,1019.1953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406" x2="669" y1="1019.1953" y2="1019.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="1006.7979">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="426" y="999.1426">Request settlementWindow(s)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="426" y="1014.4531">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="503" y="1014.4531">2001</text><polygon fill="#A80036" points="1153,1044.5059,1163,1048.5059,1153,1052.5059,1157,1048.5059" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="1048.5059" y2="1048.5059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="692" y="1043.7637">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="705" y="1043.7637">Retrieve settlementWindow(s)</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="896,1061.5059,1444,1061.5059,1454,1164.5059,1444,1268.5059,896,1268.5059,886,1164.5059,896,1061.5059" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="530" x="898" y="1078.0742">SELECT DISTINCT sw.settlementWindowId, sw.currentStateChangeId, sw.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="898" y="1093.3848">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="938" y="1093.3848">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1067" y="1093.3848">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="898" y="1108.6953">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="930" y="1108.6953">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1144" y="1108.6953">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="898" y="1124.0059">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="898" y="1139.3164">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="930" y="1139.3164">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1112" y="1139.3164">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="898" y="1154.627">ON swc.settlementWindowId = sw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="898" y="1169.9375">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="930" y="1169.9375">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="1197" y="1169.9375">swcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="898" y="1185.248">ON swcsc.settlementWindowContentStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="441" x="898" y="1200.5586">WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="898" y="1215.8691">AND swc.ledgerAccountType = smd.ledgerAccountType</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="898" y="1231.1797">AND swc.currencyId = ISNULL(smd.currencyId, swc.currencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="544" x="898" y="1246.4902">AND swsc.settlementWindowStateId IN ('CLOSED', 'ABORTED', 'PENDING_SETTLEMENT')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="898" y="1261.8008">AND swcsc.settlementWindowStateId IN ('CLOSED', 'ABORTED')</text><polygon fill="#A80036" points="696,1290.8535,686,1294.8535,696,1298.8535,692,1294.8535" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="1294.8535" y2="1294.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="702" y="1290.1113">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="715" y="1290.1113">Return data</text><polygon fill="#A80036" points="417,1320.1641,407,1324.1641,417,1328.1641,413,1324.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411" x2="679" y1="1324.1641" y2="1324.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423" y="1319.4219">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="445" y="1319.4219">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="490" y="1319.4219">windowsData</text><path d="M43,1339.1641 L127,1339.1641 L127,1346.1641 L117,1356.1641 L43,1356.1641 L43,1339.1641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="201.7949" style="stroke: #000000; stroke-width: 2.0;" width="509" x="43" y="1339.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="58" y="1352.7324">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="332" x="142" y="1351.7988">[payload.settlementWindows.length != windowsData.length]</text><path d="M411,1361.4746 L411,1386.4746 L538,1386.4746 L538,1371.4746 L528,1361.4746 L411,1361.4746 " fill="#D3D3D3" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M528,1361.4746 L528,1371.4746 L538,1371.4746 L528,1361.4746 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="417" y="1379.043">Log ERROR event</text><path d="M53,1400.7852 L53,1501.7852 L387,1501.7852 L387,1410.7852 L377,1400.7852 L53,1400.7852 " fill="#FFFF00" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,1400.7852 L377,1410.7852 L387,1410.7852 L377,1400.7852 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="59" y="1418.3535">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="75" y="1433.6641">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="91" y="1448.9746">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="91" y="1464.2852">"errorDescription": "Invalid window(s) found"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="75" y="1479.5957">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="59" y="1494.9063">}</text><polygon fill="#A80036" points="147,1528.959,137,1532.959,147,1536.959,143,1532.959" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="141" x2="395" y1="1532.959" y2="1532.959"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="153" y="1528.2168">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="175" y="1528.2168">Respond HTTP - 4xx (Client error)</text><path d="M411,1552.959 L411,1577.959 L667,1577.959 L667,1562.959 L657,1552.959 L411,1552.959 " fill="#D3D3D3" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M657,1552.959 L657,1562.959 L667,1562.959 L657,1552.959 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="417" y="1570.5273">All preliminary validations succeeded</text><path d="M23,1594.2695 L179,1594.2695 L179,1601.2695 L169,1611.2695 L23,1611.2695 L23,1594.2695 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3005.0977" style="stroke: #000000; stroke-width: 2.0;" width="1474" x="23" y="1594.2695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="38" y="1607.8379">Main processing</text><polygon fill="#A80036" points="663,1644.2012,673,1648.2012,663,1652.2012,667,1648.2012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406" x2="669" y1="1648.2012" y2="1648.2012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="1635.8037">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="435" y="1628.1484">Create settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="435" y="1643.459">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="512" y="1643.459">2001</text><path d="M593,1663.2012 L758,1663.2012 L758,1670.2012 L748,1680.2012 L593,1680.2012 L593,1663.2012 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2249.3652" style="stroke: #000000; stroke-width: 2.0;" width="894" x="593" y="1663.2012"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="608" y="1676.7695">DB TRANSACTION</text><path d="M690,1685.5117 L690,1710.5117 L935,1710.5117 L935,1695.5117 L925,1685.5117 L690,1685.5117 " fill="#D3D3D3" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M925,1685.5117 L925,1695.5117 L935,1695.5117 L925,1685.5117 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="696" y="1703.0801">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="716" y="1703.0801">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="872" y="1703.0801">= now()</text><polygon fill="#A80036" points="1153,1737.1328,1163,1741.1328,1153,1745.1328,1157,1741.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="1741.1328" y2="1741.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="1736.3906">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="714" y="1736.3906">Insert new settlement</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="1008,1754.1328,1331,1754.1328,1341,1773.1328,1331,1792.1328,1008,1792.1328,998,1773.1328,1008,1754.1328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1010" y="1770.7012">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1094" y="1770.7012">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1170" y="1770.7012">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="1010" y="1786.0117">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="696,1815.0645,686,1819.0645,696,1823.0645,692,1819.0645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="1819.0645" y2="1819.0645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="1814.3223">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="724" y="1814.3223">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="769" y="1814.3223">settlementId</text><polygon fill="#A80036" points="1153,1844.375,1163,1848.375,1153,1852.375,1157,1848.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="1848.375" y2="1848.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="1843.6328">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="714" y="1843.6328">Associate settlement windows with the settlement</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="872,1891.375,1467,1891.375,1477,1910.375,1467,1929.375,872,1929.375,862,1910.375,872,1891.375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="874" y="1907.9434">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="958" y="1907.9434">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="1159" y="1907.9434">(settlementId, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="534" x="874" y="1923.2539">VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})</text><polygon fill="#A80036" points="1153,1952.3066,1163,1956.3066,1153,1960.3066,1157,1956.3066" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="1956.3066" y2="1956.3066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="1951.5645">16</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="714" y="1951.5645">Populate settlementParticipantCurrency with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="894,1969.3066,1446,1969.3066,1456,2126.3066,1446,2283.3066,894,2283.3066,884,2126.3066,894,1969.3066" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="896" y="1985.875">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="980" y="1985.875">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="924" y="2001.1855">(settlementId, participantCurrencyId, createdDate, netAmount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="548" x="896" y="2016.4961">SELECT ssw.settlementId, participantCurrencyId, {transactionTimestamp}, SUM(amount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="896" y="2031.8066">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="936" y="2031.8066">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1137" y="2031.8066">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="896" y="2047.1172">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="928" y="2047.1172">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1057" y="2047.1172">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="896" y="2062.4277">ON sw.settlementWindowId = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="896" y="2077.7383">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="928" y="2077.7383">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1110" y="2077.7383">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="896" y="2093.0488">ON swc.settlementWindowId = sw.settlementWindowId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="896" y="2108.3594">JOIN</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="133" x="928" y="2108.3594">ledgerAccountType</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1065" y="2108.3594">lat</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="356" x="896" y="2123.6699">ON lat.ledgerAccountTypeId = swc.ledgerAccountTypeId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="896" y="2138.9805">AND lat.isSettleable = 1</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="896" y="2154.291">JOIN</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="928" y="2154.291">ledgerEntryType</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1046" y="2154.291">let</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="896" y="2169.6016">ON let.ledgerAccountTypeId = lat.ledgerAccountTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="896" y="2184.9121">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="928" y="2184.9121">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1142" y="2184.9121">sca</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="451" x="896" y="2200.2227">ON sca.settlementWindowContentId = swc.settlementWindowContentId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="896" y="2215.5332">AND sca.ledgerEntryTypeId = let.ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="896" y="2230.8438">WHERE ssw.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="896" y="2246.1543">AND swc.ledgerAccountTypeId = {smd.ledgerAccountTypeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="896" y="2261.4648">AND swc.currencyId = ISNULL({smd.currencyId}, swc.currencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="896" y="2276.7754">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="696,2305.8281,686,2309.8281,696,2313.8281,692,2309.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="2309.8281" y2="2309.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="2305.0859">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="724" y="2305.0859">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="824" y="2305.0859">settlementParticipantCurrencyIdList</text><polygon fill="#A80036" points="1153,2335.1387,1163,2339.1387,1153,2343.1387,1157,2339.1387" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="2339.1387" y2="2339.1387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2334.3965">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="714" y="2334.3965">Insert initial settlement accounts state 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="923,2352.1387,1416,2352.1387,1426,2386.1387,1416,2421.1387,923,2421.1387,913,2386.1387,923,2352.1387" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="925" y="2368.707">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="1009" y="2368.707">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="461" x="953" y="2384.0176">(settlementParticipantCurrencyId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="450" x="925" y="2399.3281">VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="953" y="2414.6387">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="696,2443.6914,686,2447.6914,696,2451.6914,692,2447.6914" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="2447.6914" y2="2447.6914"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="2442.9492">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="724" y="2442.9492">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="824" y="2442.9492">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="727" y1="2507.623" y2="2507.623"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="727" x2="727" y1="2507.623" y2="2520.623"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="686" x2="727" y1="2520.623" y2="2520.623"/><polygon fill="#A80036" points="696,2516.623,686,2520.623,696,2524.623,692,2520.623" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2487.5703">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="714" y="2472.2598">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="714" y="2487.5703">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="714" y="2502.8809">issue the following update in one knex command</text><polygon fill="#A80036" points="1153,2545.9336,1163,2549.9336,1153,2553.9336,1157,2549.9336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="2549.9336" y2="2549.9336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2545.1914">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="714" y="2545.1914">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="918,2592.9336,1422,2592.9336,1432,2618.9336,1422,2645.9336,918,2645.9336,908,2618.9336,918,2592.9336" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="920" y="2609.502">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="974" y="2609.502">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="920" y="2624.8125">SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="500" x="920" y="2640.123">WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}</text><path d="M613,2658.8652 L972,2658.8652 L972,2665.8652 L962,2675.8652 L613,2675.8652 L613,2658.8652 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="661.8691" style="stroke: #000000; stroke-width: 2.0;" width="869" x="613" y="2658.8652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="314" x="628" y="2672.4336">Populate settlement content aggregation state</text><polygon fill="#A80036" points="1153,2693.4863,1163,2697.4863,1153,2701.4863,1157,2697.4863" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="2697.4863" y2="2697.4863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2692.7441">22</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="714" y="2692.7441">Insert current content aggregation state change</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="942,2740.4863,1397,2740.4863,1407,2820.4863,1397,2901.4863,942,2901.4863,932,2820.4863,942,2740.4863" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="944" y="2757.0547">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="295" x="1028" y="2757.0547">settlementContentAggregationStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="381" x="960" y="2772.3652">(settlementContentAggregationId, settlementWindowStateId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="438" x="944" y="2787.6758">SELECT sca.settlementContentAggregationId, 'PENDING_SETTLEMENT'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="944" y="2802.9863">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="984" y="2802.9863">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1166" y="2802.9863">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="944" y="2818.2969">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="976" y="2818.2969">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1190" y="2818.2969">sca</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="451" x="944" y="2833.6074">ON sca.settlementWindowContentId = swc.settlementWindowContentId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="944" y="2848.918">^— no need to filter by sca.ledgerEntryTypeId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="6" x="1235" y="2848.918">?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="944" y="2864.2285">WHERE swc.settlementWindowId IN {payload.settlementWindows.idList}</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="944" y="2879.5391">AND swc.ledgerAccountTypeId = {smd.ledgerAccountTypeId}</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="944" y="2894.8496">AND swc.currencyId = ISNULL({smd.currencyId}, swc.currencyId)</text><polygon fill="#A80036" points="1153,2923.9023,1163,2927.9023,1153,2931.9023,1157,2927.9023" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="2927.9023" y2="2927.9023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="2923.1602">23</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="714" y="2923.1602">Update pointers to current state change ids (</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="33" x="995" y="2923.1602">knex</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1028" y="2923.1602">)</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="878,2970.9023,1462,2970.9023,1472,3142.9023,1462,3314.9023,878,3314.9023,868,3142.9023,878,2970.9023" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="880" y="2987.4707">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="934" y="2987.4707">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="880" y="3002.7813">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="920" y="3002.7813">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1134" y="3002.7813">sca</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="880" y="3018.0918">JOIN (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="896" y="3033.4023">SELECT scacs.settlementContentStateAggregationId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="518" x="912" y="3048.7129">MAX(scacs.settlementContentAggregationStateChangeId) AS currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="896" y="3064.0234">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="295" x="936" y="3064.0234">settlementContentAggregationStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1235" y="3064.0234">scacs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="896" y="3079.334">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="928" y="3079.334">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="29" x="1142" y="3079.334">sca2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="526" x="896" y="3094.6445">ON sca2.settlementContentAggregationId = scacs.settlementContentAggregationId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="896" y="3109.9551">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="928" y="3109.9551">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1110" y="3109.9551">swc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="896" y="3125.2656">ON swc2.settlementWindowContentId = sca2.settlementWindowContentId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="456" x="896" y="3140.5762">WHERE swc2.settlementWindowId IN {payload.settlementWindows.idList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="896" y="3155.8867"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="896" y="3155.8867">AND swc2.ledgerAccountTypeId = {smd.ledgerAccountTypeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="896" y="3171.1973"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="420" x="896" y="3171.1973">AND swc2.currencyId = ISNULL({smd.currencyId}, swc2.currencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="896" y="3186.5078">GROUP BY settlementContentStateAggregationId) scasc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="580" x="880" y="3201.8184">ON scasc.settlementContentStateAggregationId = sca.settlementContentStateAggregationId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="880" y="3217.1289">SET currentStateChangeId = scasc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="880" y="3232.4395">WHERE settlementWindowContentId IN (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="896" y="3247.75">SELECT settlementWindowContentId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="896" y="3263.0605">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="936" y="3263.0605">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="420" x="896" y="3278.3711">WHERE settlementWindowId IN {payload.settlementWindows.idList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="896" y="3293.6816"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="356" x="896" y="3293.6816">AND ledgerAccountTypeId = {smd.ledgerAccountTypeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="896" y="3308.9922"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="896" y="3308.9922">AND currencyId = ISNULL({smd.currencyId}, currencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1244" y="3308.9922">)</text><path d="M603,3334.7344 L677,3334.7344 L677,3341.7344 L667,3351.7344 L603,3351.7344 L603,3334.7344 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="309.7266" style="stroke: #000000; stroke-width: 2.0;" width="825" x="603" y="3334.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="618" y="3348.3027">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="692" y="3347.3691">[</text><text fill="#FF0000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="696" y="3347.3691">foreach w in windowsData</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="844" y="3347.3691">]</text><path d="M613,3359.0449 L680,3359.0449 L680,3366.0449 L670,3376.0449 L613,3376.0449 L613,3359.0449 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="278.416" style="stroke: #000000; stroke-width: 2.0;" width="805" x="613" y="3359.0449"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="628" y="3372.6133">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="299" x="695" y="3371.6797">[if w.currentStateChangeId IN ('CLOSED', 'ABORTED')]</text><polygon fill="#A80036" points="1153,3393.666,1163,3397.666,1153,3401.666,1157,3397.666" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="3397.666" y2="3397.666"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="3392.9238">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="714" y="3392.9238">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="942,3410.666,1398,3410.666,1408,3444.666,1398,3479.666,942,3479.666,932,3444.666,942,3410.666" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="944" y="3427.2344">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1028" y="3427.2344">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="960" y="3442.5449">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="944" y="3457.8555">VALUES ({w.settlementWindowId}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="960" y="3473.166">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="696,3502.2188,686,3506.2188,696,3510.2188,692,3506.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="3506.2188" y2="3506.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="3501.4766">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="724" y="3501.4766">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="223" x="824" y="3501.4766">settlementWindowStateChangeId</text><polygon fill="#A80036" points="1153,3531.5293,1163,3535.5293,1153,3539.5293,1157,3535.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="3535.5293" y2="3535.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="3530.7871">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="714" y="3530.7871">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="971,3578.5293,1368,3578.5293,1378,3604.5293,1368,3631.5293,971,3631.5293,961,3604.5293,971,3578.5293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="973" y="3595.0977">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1027" y="3595.0977">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="973" y="3610.4082">SET currentStateChangeId = {settlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="973" y="3625.7188">WHERE settlementWindowId = {w.settlementWindowId}</text><polygon fill="#A80036" points="1153,3668.7715,1163,3672.7715,1153,3676.7715,1157,3672.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="3672.7715" y2="3672.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="3668.0293">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="714" y="3668.0293">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="985,3685.7715,1355,3685.7715,1365,3719.7715,1355,3754.7715,985,3754.7715,975,3719.7715,985,3685.7715" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="987" y="3702.3398">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1071" y="3702.3398">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1015" y="3717.6504">(settlementId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="987" y="3732.9609">VALUES ({settlementId}, ‘PENDING_SETTLEMENT’,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1015" y="3748.2715">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="696,3777.3242,686,3781.3242,696,3785.3242,692,3781.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="3781.3242" y2="3781.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="3776.582">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="724" y="3776.582">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="769" y="3776.582">settlementStateChangeId</text><polygon fill="#A80036" points="1153,3806.6348,1163,3810.6348,1153,3814.6348,1157,3810.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="3810.6348" y2="3810.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="3805.8926">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="714" y="3805.8926">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="996,3853.6348,1344,3853.6348,1354,3879.6348,1344,3906.6348,996,3906.6348,986,3879.6348,996,3853.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="998" y="3870.2031">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1052" y="3870.2031">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="998" y="3885.5137">SET currentStateChangeId = {settlementStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="998" y="3900.8242">WHERE settlementId = {settlementId}</text><polygon fill="#A80036" points="1153,3936.877,1163,3940.877,1153,3944.877,1157,3940.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="1159" y1="3940.877" y2="3940.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="692" y="3936.1348">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="714" y="3936.1348">Select account data for response</text><polygon fill="#FFFFE0" filter="url(#f1ki1haweeiur)" points="910,3953.877,1429,3953.877,1439,3995.877,1429,4037.877,910,4037.877,900,3995.877,910,3953.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="912" y="3970.4453">SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="912" y="3985.7559">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="952" y="3985.7559">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1163" y="3985.7559">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="912" y="4001.0664">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="944" y="4001.0664">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1084" y="4001.0664">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="912" y="4016.377">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="912" y="4031.6875">WHERE spc.settlementId = {settlementId}</text><polygon fill="#A80036" points="696,4060.7402,686,4064.7402,696,4068.7402,692,4064.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690" x2="1169" y1="4064.7402" y2="4064.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="702" y="4059.998">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="724" y="4059.998">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="769" y="4059.998">accountData</text><polygon fill="#A80036" points="417,4090.0508,407,4094.0508,417,4098.0508,413,4094.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411" x2="679" y1="4094.0508" y2="4094.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423" y="4089.3086">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="445" y="4089.3086">Construct and return result</text><path d="M33,4107.0508 L33,4561.0508 L387,4561.0508 L387,4117.0508 L377,4107.0508 L33,4107.0508 " fill="#FFFF00" filter="url(#f1ki1haweeiur)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,4107.0508 L377,4117.0508 L387,4117.0508 L377,4107.0508 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="4124.6191">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="55" y="4139.9297">"id": settlementId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="55" y="4155.2402">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="55" y="4170.5508">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="4185.8613">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="87" y="4201.1719">"id": windowsData.settlementWindowIdList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="87" y="4216.4824">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="87" y="4231.793">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="87" y="4247.1035">"createdDate": windowsData.createdDateList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="87" y="4262.4141">"changedDate": transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="4277.7246">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="55" y="4293.0352">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="55" y="4308.3457">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="4323.6563">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="87" y="4338.9668">"id": accountData.participantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="87" y="4354.2773">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="4369.5879">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="119" y="4384.8984">"id": accountData.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="119" y="4400.209">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="119" y="4415.5195">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="119" y="4430.8301">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="135" y="4446.1406">"amount": accountData.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="135" y="4461.4512">"currency": accountData.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="119" y="4476.7617">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="4492.0723">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="87" y="4507.3828">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="4522.6934">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="55" y="4538.0039">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="4553.3145">}</text><polygon fill="#A80036" points="147,4587.3672,137,4591.3672,147,4595.3672,143,4591.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="141" x2="395" y1="4591.3672" y2="4591.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="153" y="4586.625">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="175" y="4586.625">Respond HTTP - 201 (Created)</text><!--
@startuml
title 6.2.1. Trigger Settlement Event (createSettlement)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Trigger Settlement Event
activate OPERATOR
    note right of OPERATOR #yellow
        {
            "settlementModelName": "string",  
            "reason": "string",
            "settlementWindows": [
                {
                    "id": 1,
                },
                {
                    "id": 2,
                }
            ]
        }
    end note
    OPERATOR -> SSAPI: POST - /settlements
    activate SSAPI

    SSAPI-> SETTLE_DAO: Request settlementModel\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementModel
    activate DB
    hnote over DB #lightyellow
        SELECT sg.name settlementGranularity, si.name settlementInterchange,
            sd.name settlementDelay, sm.ledgerAccountTypeId,
            sm.currencyId, sm.requireLiquidityCheck
        FROM **settlementModel** sm
        JOIN **settlementGranularity** sg
        ON sg.settlementGranularityId = sm.settlementGranularityId
        JOIN **settlementInterchange** si
        ON si.settlementInterchangeId = sm.settlementInterchangeId
        JOIN **settlementDelay** sd
        ON sd.settlementDelayId = sm.settlementDelayId
        WHERE name = {settlementModelName}
        AND isActive = 1
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **settlementModelData (smd)**
    deactivate SETTLE_DAO

    break smd.settlementGranularity != 'NET' ||\nsmd.settlementInterchange != 'MULTILATERAL' ||\nsmd.settlementDelay != 'DEFERRED'
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid settlement model"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
    end
    
    SSAPI-> SETTLE_DAO: Request settlementWindow(s)\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementWindow(s)
    activate DB
    hnote over DB #lightyellow
        SELECT DISTINCT sw.settlementWindowId, sw.currentStateChangeId, sw.createdDate
        FROM **settlementWindow** sw
        JOIN **settlementWindowStateChange** swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        JOIN **settlementWindowContent** swc
        ON swc.settlementWindowId = sw.settlementWindowId
        JOIN **settlementWindowContentStateChange** swcsc
        ON swcsc.settlementWindowContentStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}
        AND swc.ledgerAccountType = smd.ledgerAccountType
        AND swc.currencyId = ISNULL(smd.currencyId, swc.currencyId)
        AND swsc.settlementWindowStateId IN ('CLOSED', 'ABORTED', 'PENDING_SETTLEMENT')
        AND swcsc.settlementWindowStateId IN ('CLOSED', 'ABORTED')
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **windowsData**
    deactivate SETTLE_DAO

    break payload.settlementWindows.length != windowsData.length
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid window(s) found"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
    end

    note right of SSAPI #lightgray
        All preliminary validations succeeded
    end note

    group Main processing
        SSAPI ->SETTLE_DAO: Create settlement\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Insert new settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlement** (reason, createdDate)
                VALUES ({payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementId**
            deactivate DB

            SETTLE_DAO -> DB: Associate settlement windows with the settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementSettlementWindow** (settlementId, settlementWindowId, createdDate)
                VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: <color #red>Populate settlementParticipantCurrency with aggregated data</color>
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrency**
                       (settlementId, participantCurrencyId, createdDate, netAmount)
                SELECT ssw.settlementId, participantCurrencyId, {transactionTimestamp}, SUM(amount)
                FROM **settlementSettlementWindow** ssw
                JOIN **settlementWindow** sw
                ON sw.settlementWindowId = ssw.settlementWindowId
                JOIN **settlementWindowContent** swc
                ON swc.settlementWindowId = sw.settlementWindowId
                <color #red>JOIN **ledgerAccountType** lat</color>
                <color #red>ON lat.ledgerAccountTypeId = swc.ledgerAccountTypeId</color>
                <color #red>AND lat.isSettleable = 1</color>
                <color #red>JOIN **ledgerEntryType** let</color>
                <color #red>ON let.ledgerAccountTypeId = lat.ledgerAccountTypeId</color>
                JOIN **settlementContentAggregation** sca
                ON sca.settlementWindowContentId = swc.settlementWindowContentId
                <color #red>AND sca.ledgerEntryTypeId = let.ledgerEntryTypeId</color>
                WHERE ssw.settlementId = {settlementId}
                AND swc.ledgerAccountTypeId = {smd.ledgerAccountTypeId}
                AND swc.currencyId = ISNULL({smd.currencyId}, swc.currencyId)
                GROUP BY settlementId, participantCurrencyId
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyIdList**
            deactivate DB

            SETTLE_DAO -> DB: Insert initial settlement accounts state 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                       (settlementParticipantCurrencyId, settlementStateId, reason, createdDate)
                VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB
            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}
                WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB

            group Populate settlement content aggregation state
                SETTLE_DAO -> DB: <color #red>Insert current content aggregation state change</color>
                activate DB
                hnote over DB #lightyellow
                    INSERT INTO **settlementContentAggregationStateChange**
                        (settlementContentAggregationId, settlementWindowStateId)
                    SELECT sca.settlementContentAggregationId, 'PENDING_SETTLEMENT'
                    FROM **settlementWindowContent** swc
                    JOIN **settlementContentAggregation** sca
                    <color #red>ON sca.settlementWindowContentId = swc.settlementWindowContentId</color>
                    <color #red>^— no need to filter by sca.ledgerEntryTypeId <b>?</b></color>
                    WHERE swc.settlementWindowId IN {payload.settlementWindows.idList}
                    <color #blue>AND swc.ledgerAccountTypeId = {smd.ledgerAccountTypeId}</color>
                    <color #blue>AND swc.currencyId = ISNULL({smd.currencyId}, swc.currencyId)</color>
                end hnote
                deactivate DB

                SETTLE_DAO -> DB: <color #red>Update pointers to current state change ids (<b>knex</b>)</color>
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlementContentAggregation**
                    FROM **settlementContentAggregation** sca
                    JOIN (
                        SELECT scacs.settlementContentStateAggregationId, 
                            MAX(scacs.settlementContentAggregationStateChangeId) AS currentStateChangeId
                        FROM **settlementContentAggregationStateChange** scacs
                        JOIN **settlementContentAggregation** sca2
                        ON sca2.settlementContentAggregationId = scacs.settlementContentAggregationId
                        JOIN **settlementWindowContent** swc2
                        ON swc2.settlementWindowContentId = sca2.settlementWindowContentId
                        WHERE swc2.settlementWindowId IN {payload.settlementWindows.idList}
                        <color #blue>AND swc2.ledgerAccountTypeId = {smd.ledgerAccountTypeId}</color>
                        <color #blue>AND swc2.currencyId = ISNULL({smd.currencyId}, swc2.currencyId)</color>
                        GROUP BY settlementContentStateAggregationId) scasc
                    ON scasc.settlementContentStateAggregationId = sca.settlementContentStateAggregationId
                    SET currentStateChangeId = scasc.currentStateChangeId
                    WHERE settlementWindowContentId IN (
                        SELECT settlementWindowContentId
                        FROM **settlementWindowContent**
                        WHERE settlementWindowId IN {payload.settlementWindows.idList}
                        <color #blue>AND ledgerAccountTypeId = {smd.ledgerAccountTypeId}</color>
                        <color #blue>AND currencyId = ISNULL({smd.currencyId}, currencyId)</color>)
                end hnote
                deactivate DB
            end

            loop <color #red>foreach w in windowsData</color>
                opt if w.currentStateChangeId IN ('CLOSED', 'ABORTED')
                    SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
                    activate DB
                    hnote over DB #lightyellow
                        INSERT INTO **settlementWindowStateChange**
                            (settlementWindowId, settlementWindowStateId, reason, createdDate)
                        VALUES ({w.settlementWindowId}, 'PENDING_SETTLEMENT',
                            {payload.reason}, {transactionTimestamp})
                    end hnote
                    SETTLE_DAO <- - DB: Return inserted **settlementWindowStateChangeId**
                    deactivate DB

                    SETTLE_DAO -> DB: Update pointers to current state change ids
                    activate DB
                    hnote over DB #lightyellow
                        UPDATE **settlementWindow**
                        SET currentStateChangeId = {settlementWindowStateChangeId}
                        WHERE settlementWindowId = {w.settlementWindowId}
                    end hnote
                    deactivate DB
                end
            end

            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementStateChange**
                       (settlementId, settlementStateId, reason, createdDate)
                VALUES ({settlementId}, ‘PENDING_SETTLEMENT’,
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlement**
                SET currentStateChangeId = {settlementStateChangeId}
                WHERE settlementId = {settlementId}
            end hnote
            deactivate DB
        end

        SETTLE_DAO -> DB: Select account data for response
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId
            FROM **settlementParticipantCurrency** spc
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {settlementId}
        end hnote
        SETTLE_DAO <- - DB: Return **accountData**
        deactivate DB

        SSAPI <- - SETTLE_DAO: Construct and return result
        deactivate SETTLE_DAO
        note left of SSAPI #yellow
            {
                "id": settlementId,
                "state": "PENDING_SETTLEMENT",
                "settlementWindows": [
                    {
                        "id": windowsData.settlementWindowIdList,
                        "state": "PENDING_SETTLEMENT",
                        "reason": payload.reason,
                        "createdDate": windowsData.createdDateList,
                        "changedDate": transactionTimestamp
                    }
                ],
                "participants": [
                    {
                        "id": accountData.participantId,
                        "accounts": [
                            {
                                "id": accountData.participantCurrencyId,
                                "state": "PENDING_SETTLEMENT",
                                "reason": payload.reason,
                                "netSettlementAmount": {
                                    "amount": accountData.netAmount,
                                    "currency": accountData.currencyId
                                }
                            }
                        ]
                    }
                ]
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)
    end
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.1
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>