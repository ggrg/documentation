<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4302px" preserveAspectRatio="none" style="width:1955px;height:4302px;" version="1.1" viewBox="0 0 1955 4302" width="1955px" zoomAndPan="magnify"><defs><filter height="300%" id="f1vebogwh8r8fh" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="413" x="772" y="23.5352">6.1.2. Close Settlement Window (closeSettlementWindow)</text><rect fill="#FFB6C1" height="4256.8164" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="55" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="70.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="4256.8164" style="stroke: #A80036; stroke-width: 1.0;" width="976" x="294.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="720.5" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="4256.8164" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1509.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1512.5" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="2017.6387" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="106" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="15" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="106" y="4172.8164"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="1886.7754" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="278.1504"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="150.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="4022.332"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="640" y="1974.4414"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="640" y="2233.8574"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="4040.5293" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="874" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1204.5" y="541.5664"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="698.7637" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1204.5" y="808.9824"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="868.4902" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1204.5" y="2613.584"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="59.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1204.5" y="3590.3164"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="59.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1204.5" y="3812.0898"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="570.877"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="901.9141"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="1024.4668"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="1147.709"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="1254.9512"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="1377.5039"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="2706.5156"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="2906.3105"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="3228.5898"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="3382.4531"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="3619.627"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="3841.4004"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="4033.5293" style="stroke: #000000; stroke-width: 2.0;" width="1931" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="162.4844" style="stroke: #000000; stroke-width: 2.0;" width="683" x="49" y="335.4609"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="3425.7656" style="stroke: #000000; stroke-width: 2.0;" width="1911" x="23" y="755.0508"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="655.4531" style="stroke: #000000; stroke-width: 2.0;" width="701.5" x="1142.5" y="823.9824"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="1804.4063" style="stroke: #000000; stroke-width: 2.0;" width="1366.5" x="557.5" y="2179.9258"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="352" x="800.5" y="2278.8574"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="1456.9902" style="stroke: #000000; stroke-width: 2.0;" width="1123.5" x="790.5" y="2520.3418"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="825.1797" style="stroke: #000000; stroke-width: 2.0;" width="761.5" x="1142.5" y="2628.584"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="473.2578" style="stroke: #000000; stroke-width: 2.0;" width="915.5" x="800.5" y="3497.0742"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="915.5" x="800.5" y="3706.248"/><rect fill="#FFFFFF" height="209.8184" style="stroke: none; stroke-width: 1.0;" width="915.5" x="800.5" y="3760.5137"/><rect fill="#FFFFFF" height="189.4844" style="stroke: none; stroke-width: 1.0;" width="1911" x="23" y="3991.332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="111" x2="111" y1="137.2871" y2="4204.8164"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="376.5" x2="376.5" y1="137.2871" y2="4204.8164"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="644.5" x2="644.5" y1="137.2871" y2="4204.8164"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="878.5" x2="878.5" y1="137.2871" y2="4204.8164"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1091.5" x2="1091.5" y1="137.2871" y2="4204.8164"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1209.5" x2="1209.5" y1="137.2871" y2="4204.8164"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1566.5" x2="1566.5" y1="137.2871" y2="4204.8164"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="59" y="134.334">Hub Employee</text><ellipse cx="111" cy="63.7988" fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M111,71.7988 L111,98.7988 M98,79.7988 L124,79.7988 M111,98.7988 L98,113.7988 M111,98.7988 L124,113.7988 " fill="none" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="59" y="4217.3516">Hub Employee</text><ellipse cx="111" cy="4230.3047" fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M111,4238.3047 L111,4265.3047 M98,4246.3047 L124,4246.3047 M111,4265.3047 L98,4280.3047 M111,4265.3047 L124,4280.3047 " fill="none" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="298.5" y="134.334">Settlement Service API</text><path d="M356.5,92.7988 L356.5,116.7988 M356.5,104.7988 L373.5,104.7988 " fill="none" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="385.5" cy="104.7988" fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="298.5" y="4217.3516">Settlement Service API</text><path d="M356.5,4224.3047 L356.5,4248.3047 M356.5,4236.3047 L373.5,4236.3047 " fill="none" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="385.5" cy="4236.3047" fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="147" x="571.5" y="81.3105"/><rect fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="147" x="567.5" y="85.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="620" y="105.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="574.5" y="122.334">settlement-window</text><rect fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="147" x="571.5" y="4203.8164"/><rect fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="147" x="567.5" y="4207.8164"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="620" y="4228.3516">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="574.5" y="4244.8398">settlement-window</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="131" x="810.5" y="117.8457">Settlement Window</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="849" y="134.334">Handler</text><ellipse cx="879" cy="88.3105" fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="875,76.3105,881,71.3105,879,76.3105,881,81.3105,875,76.3105" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="131" x="810.5" y="4217.3516">Settlement Window</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="849" y="4233.8398">Handler</text><ellipse cx="879" cy="4252.793" fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="875,4240.793,881,4235.793,879,4240.793,881,4245.793,875,4240.793" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="1045.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="1041.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="1048.5" y="122.334">topic-event</text><rect fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="1045.5" y="4203.8164"/><rect fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="1041.5" y="4207.8164"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="1048.5" y="4228.3516">topic-event</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1152.5" y="134.334">Settlement DAO</text><ellipse cx="1209.5" cy="104.7988" fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1197.5" x2="1221.5" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1152.5" y="4217.3516">Settlement DAO</text><ellipse cx="1209.5" cy="4236.3047" fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1197.5" x2="1221.5" y1="4250.3047" y2="4250.3047"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1518.5" y="134.334">Central Store</text><path d="M1548.5,84.7988 C1548.5,74.7988 1566.5,74.7988 1566.5,74.7988 C1566.5,74.7988 1584.5,74.7988 1584.5,84.7988 L1584.5,110.7988 C1584.5,120.7988 1566.5,120.7988 1566.5,120.7988 C1566.5,120.7988 1548.5,120.7988 1548.5,110.7988 L1548.5,84.7988 " fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1548.5,84.7988 C1548.5,94.7988 1566.5,94.7988 1566.5,94.7988 C1566.5,94.7988 1584.5,94.7988 1584.5,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1518.5" y="4217.3516">Central Store</text><path d="M1548.5,4230.3047 C1548.5,4220.3047 1566.5,4220.3047 1566.5,4220.3047 C1566.5,4220.3047 1584.5,4220.3047 1584.5,4230.3047 L1584.5,4256.3047 C1584.5,4266.3047 1566.5,4266.3047 1566.5,4266.3047 C1566.5,4266.3047 1548.5,4266.3047 1548.5,4256.3047 L1548.5,4230.3047 " fill="#FEFECE" filter="url(#f1vebogwh8r8fh)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1548.5,4230.3047 C1548.5,4240.3047 1566.5,4240.3047 1566.5,4240.3047 C1566.5,4240.3047 1584.5,4240.3047 1584.5,4230.3047 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="2017.6387" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="106" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="15" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="106" y="4172.8164"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="1886.7754" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="278.1504"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="150.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="4022.332"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="640" y="1974.4414"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="640" y="2233.8574"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="4040.5293" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="874" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1204.5" y="541.5664"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="698.7637" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1204.5" y="808.9824"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="868.4902" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1204.5" y="2613.584"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="59.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1204.5" y="3590.3164"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="59.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1204.5" y="3812.0898"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="570.877"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="901.9141"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="1024.4668"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="1147.709"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="1254.9512"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="1377.5039"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="2706.5156"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="2906.3105"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="3228.5898"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="3382.4531"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="3619.627"/><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1561.5" y="3841.4004"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4033.5293" style="stroke: #000000; stroke-width: 2.0;" width="1931" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Close Settlement Window</text><path d="M121,176.5977 L121,247.5977 L275,247.5977 L275,186.5977 L265,176.5977 L121,176.5977 " fill="#FFFF00" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M265,176.5977 L265,186.5977 L275,186.5977 L265,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="127" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="143" y="209.4766">"state": "CLOSED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="143" y="224.7871">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="127" y="240.0977">}</text><polygon fill="#A80036" points="360,274.1504,370,278.1504,360,282.1504,364,278.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="116" x2="366" y1="278.1504" y2="278.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="123" y="273.4082">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="136" y="273.4082">POST - /settlementWindows/{id}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="307.4609" y2="307.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="307.4609" y2="320.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="320.4609" y2="320.4609"/><polygon fill="#A80036" points="393,316.4609,383,320.4609,393,324.4609,389,320.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="302.7188">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="402" y="302.7188">Validate payload and requested state</text><path d="M49,335.4609 L133,335.4609 L133,342.4609 L123,352.4609 L49,352.4609 L49,335.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="162.4844" style="stroke: #000000; stroke-width: 2.0;" width="683" x="49" y="335.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="64" y="349.0293">break</text><path d="M387,357.7715 L387,458.7715 L718,458.7715 L718,367.7715 L708,357.7715 L387,357.7715 " fill="#FFFF00" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M708,357.7715 L708,367.7715 L718,367.7715 L708,357.7715 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="375.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="409" y="390.6504">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="425" y="405.9609">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="425" y="421.2715">"errorDescription": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="436.582">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="451.8926">}</text><polygon fill="#A80036" points="127,485.9453,117,489.9453,127,493.9453,123,489.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="121" x2="371" y1="489.9453" y2="489.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="133" y="485.2031">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="146" y="485.2031">Respond HTTP - 400 (Bad Request)</text><polygon fill="#A80036" points="1192.5,537.5664,1202.5,541.5664,1192.5,545.5664,1196.5,541.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1198.5" y1="541.5664" y2="541.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="529.1689">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="402" y="521.5137">Get requested settlementWindow and state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="536.8242">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="536.8242">2001</text><polygon fill="#A80036" points="1549.5,566.877,1559.5,570.877,1549.5,574.877,1553.5,570.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="570.877" y2="570.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1221.5" y="566.1348">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="1234.5" y="566.1348">Get settlementWindow state</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1345,613.877,1788,613.877,1798,662.877,1788,712.877,1345,712.877,1335,662.877,1345,613.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="1347" y="630.4453">SELECT sw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="1375" y="645.7559">swsc.reason, sw.createdDate, swsc.createdDate changedDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1347" y="661.0664">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1387" y="661.0664">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="1516" y="661.0664">AS sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1347" y="676.377">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1379" y="676.377">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="1593" y="676.377">AS swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="1347" y="691.6875">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1347" y="706.998">WHERE sw.settlementWindowId = {id}</text><polygon fill="#A80036" points="393,736.0508,383,740.0508,393,744.0508,389,740.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1208.5" y1="740.0508" y2="740.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="399" y="735.3086">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="412" y="735.3086">Return result</text><path d="M23,755.0508 L85,755.0508 L85,762.0508 L75,772.0508 L23,772.0508 L23,755.0508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3425.7656" style="stroke: #000000; stroke-width: 2.0;" width="1911" x="23" y="755.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="768.6191">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="373" x="100" y="767.6855">[settlementWindow found &amp;&amp; settlementWindowStateId == 'OPEN']</text><polygon fill="#A80036" points="1192.5,804.9824,1202.5,808.9824,1192.5,812.9824,1196.5,808.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1198.5" y1="808.9824" y2="808.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="796.585">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="402" y="788.9297">Terminate current window and open a new one</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="804.2402">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="804.2402">2001</text><path d="M1142.5,823.9824 L1596.5,823.9824 L1596.5,830.9824 L1586.5,840.9824 L1142.5,840.9824 L1142.5,823.9824 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="655.4531" style="stroke: #000000; stroke-width: 2.0;" width="701.5" x="1142.5" y="823.9824"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="409" x="1157.5" y="837.5508">DB TRANSACTION: Terminate window usage and initate next</text><path d="M1219,846.293 L1219,871.293 L1464,871.293 L1464,856.293 L1454,846.293 L1219,846.293 " fill="#D3D3D3" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1454,846.293 L1454,856.293 L1464,856.293 L1454,846.293 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1225" y="863.8613">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="1245" y="863.8613">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1401" y="863.8613">= now()</text><polygon fill="#A80036" points="1549.5,897.9141,1559.5,901.9141,1549.5,905.9141,1553.5,901.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="901.9141" y2="901.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1221.5" y="897.1719">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="1234.5" y="897.1719">Terminate requested window</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1332,914.9141,1800,914.9141,1810,940.9141,1800,967.9141,1332,967.9141,1322,940.9141,1332,914.9141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1334" y="931.4824">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1418" y="931.4824">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="1362" y="946.793">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="1334" y="962.1035">VALUES ({id}, 'PROCESSING', {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="1225.5,991.1563,1215.5,995.1563,1225.5,999.1563,1221.5,995.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1219.5" x2="1565.5" y1="995.1563" y2="995.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1231.5" y="990.4141">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="1244.5" y="990.4141">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="223" x="1289.5" y="990.4141">settlementWindowStateChangeId</text><polygon fill="#A80036" points="1549.5,1020.4668,1559.5,1024.4668,1549.5,1028.4668,1553.5,1024.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="1024.4668" y2="1024.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1221.5" y="1019.7246">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1243.5" y="1019.7246">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1368,1067.4668,1765,1067.4668,1775,1093.4668,1765,1120.4668,1368,1120.4668,1358,1093.4668,1368,1067.4668" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1370" y="1084.0352">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1424" y="1084.0352">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="1370" y="1099.3457">SET currentStateChangeId = {settlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="1370" y="1114.6563">WHERE settlementWindowId = {id}</text><polygon fill="#A80036" points="1549.5,1143.709,1559.5,1147.709,1549.5,1151.709,1553.5,1147.709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="1147.709" y2="1147.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1221.5" y="1142.9668">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="1243.5" y="1142.9668">Create new settlementWindow</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1391,1160.709,1741,1160.709,1751,1179.709,1741,1198.709,1391,1198.709,1381,1179.709,1391,1160.709" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1393" y="1177.2773">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1477" y="1177.2773">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1606" y="1177.2773">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="1393" y="1192.5879">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="1225.5,1221.6406,1215.5,1225.6406,1225.5,1229.6406,1221.5,1225.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1219.5" x2="1565.5" y1="1225.6406" y2="1225.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1231.5" y="1220.8984">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="1253.5" y="1220.8984">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="1298.5" y="1220.8984">settlementWindowId</text><polygon fill="#A80036" points="1549.5,1250.9512,1559.5,1254.9512,1549.5,1258.9512,1553.5,1254.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="1254.9512" y2="1254.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1221.5" y="1250.209">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1243.5" y="1250.209">Insert intial state for the created window</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1309,1267.9512,1824,1267.9512,1834,1293.9512,1824,1320.9512,1309,1320.9512,1299,1293.9512,1309,1267.9512" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1311" y="1284.5195">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1395" y="1284.5195">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="1339" y="1299.8301">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="511" x="1311" y="1315.1406">VALUES ({settlementWindowId}, 'OPEN', {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="1225.5,1344.1934,1215.5,1348.1934,1225.5,1352.1934,1221.5,1348.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1219.5" x2="1565.5" y1="1348.1934" y2="1348.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1231.5" y="1343.4512">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="1253.5" y="1343.4512">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="251" x="1298.5" y="1343.4512">newSettlementWindowStateChangeId</text><polygon fill="#A80036" points="1549.5,1373.5039,1559.5,1377.5039,1549.5,1381.5039,1553.5,1377.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="1377.5039" y2="1377.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1221.5" y="1372.7617">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1243.5" y="1372.7617">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1355,1420.5039,1777,1420.5039,1787,1446.5039,1777,1473.5039,1355,1473.5039,1345,1446.5039,1355,1420.5039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1357" y="1437.0723">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1411" y="1437.0723">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="418" x="1357" y="1452.3828">SET currentStateChangeId = {newSettlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="1357" y="1467.6934">WHERE settlementWindowId = {settlementWindowId}</text><polygon fill="#A80036" points="393,1503.7461,383,1507.7461,393,1511.7461,389,1507.7461" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1208.5" y1="1507.7461" y2="1507.7461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1503.0039">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="1503.0039">Return success</text><path d="M387,1520.7461 L387,1912.7461 L615,1912.7461 L615,1530.7461 L605,1520.7461 L387,1520.7461 " fill="#FFFF00" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M605,1520.7461 L605,1530.7461 L615,1530.7461 L605,1520.7461 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="1538.3145">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="1553.625">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="409" y="1568.9355">id: &lt;uuid&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="409" y="1584.2461">from: switch,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="409" y="1599.5566">to: switch,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="409" y="1614.8672">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="1630.1777">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="425" y="1645.4883">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="441" y="1660.7988">settlementWindowId: {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="1676.1094">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="1691.4199">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="1706.7305">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="1722.041">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="1737.3516">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="441" y="1752.6621">responseTo: null,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="441" y="1767.9727">type: setwin,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="441" y="1783.2832">action: close,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="1798.5938">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="1813.9043">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="457" y="1829.2148">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="1844.5254">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="1859.8359">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="1875.1465">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="1890.457">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="1905.7676">}</text><polygon fill="#A80036" points="628,1970.4414,638,1974.4414,628,1978.4414,632,1974.4414" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="634" y1="1974.4414" y2="1974.4414"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="1954.3887">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="411" y="1939.0781">Produce Settlement Window</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="411" y="1954.3887">event message</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="411" y="1969.6992">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="495" y="1969.6992">2003</text><path d="M85,2017.4414 L85,2134.4414 L363,2134.4414 L363,2027.4414 L353,2017.4414 L85,2017.4414 " fill="#FFFF00" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,2017.4414 L353,2027.4414 L363,2027.4414 L353,2017.4414 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="91" y="2035.0098">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="107" y="2050.3203">"id": settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="107" y="2065.6309">"state": 'OPEN',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="107" y="2080.9414">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="107" y="2096.252">"createdDate": transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="107" y="2111.5625">"changedDate": transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="91" y="2126.873">}</text><polygon fill="#A80036" points="122,2160.9258,112,2164.9258,122,2168.9258,118,2164.9258" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="116" x2="376" y1="2164.9258" y2="2164.9258"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="128" y="2160.1836">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="150" y="2160.1836">Respond HTTP - 201 (Created)</text><path d="M557.5,2179.9258 L867.5,2179.9258 L867.5,2186.9258 L857.5,2196.9258 L557.5,2196.9258 L557.5,2179.9258 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1804.4063" style="stroke: #000000; stroke-width: 2.0;" width="1366.5" x="557.5" y="2179.9258"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="265" x="572.5" y="2193.4941">Settlement Window Handler processing</text><polygon fill="#A80036" points="661,2229.8574,651,2233.8574,661,2237.8574,657,2233.8574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="655" x2="873" y1="2233.8574" y2="2233.8574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="667" y="2221.46">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="689" y="2213.8047">Consume Settlement Window</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="689" y="2229.1152">event message</text><path d="M800.5,2278.8574 L1015.5,2278.8574 L1015.5,2285.8574 L1005.5,2295.8574 L800.5,2295.8574 L800.5,2278.8574 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="352" x="800.5" y="2278.8574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="815.5" y="2292.4258">Persist Event Information</text><polygon fill="#A80036" points="1080,2338.4785,1090,2342.4785,1080,2346.4785,1084,2342.4785" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="884" x2="1086" y1="2342.4785" y2="2342.4785"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="891" y="2337.7363">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="913" y="2337.7363">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1vebogwh8r8fh)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="334" x="807.5" y="2350.4785"/><polygon fill="#EEEEEE" points="807.5,2350.4785,871.5,2350.4785,871.5,2357.4785,861.5,2367.4785,807.5,2367.4785,807.5,2350.4785" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="820.5" y="2365.0469">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="901.5" y="2384.0469">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="905.5" y="2399.3574"/><path d="M889,2448.4102 L889,2503.4102 L1253,2503.4102 L1253,2458.4102 L1243,2448.4102 L889,2448.4102 " fill="#D3D3D3" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1243,2448.4102 L1243,2458.4102 L1253,2458.4102 L1243,2448.4102 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="895" y="2465.9785">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13" x="915" y="2465.9785">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="932" y="2465.9785">= message.content.payload.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="895" y="2481.2891">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="915" y="2481.2891">windowContentReady</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1066" y="2481.2891">= false</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="895" y="2496.5996">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="23" x="915" y="2496.5996">iter</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="942" y="2496.5996">= 0</text><path d="M790.5,2520.3418 L864.5,2520.3418 L864.5,2527.3418 L854.5,2537.3418 L790.5,2537.3418 L790.5,2520.3418 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1456.9902" style="stroke: #000000; stroke-width: 2.0;" width="1123.5" x="790.5" y="2520.3418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="805.5" y="2533.9102">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="435" x="879.5" y="2532.9766">[iter &lt; Config.WIN_AGGREGATION_RETRY_COUNT &amp;&amp; !windowContentReady]</text><path d="M889,2542.6523 L889,2567.6523 L951,2567.6523 L951,2552.6523 L941,2542.6523 L889,2542.6523 " fill="#D3D3D3" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M941,2542.6523 L941,2552.6523 L951,2552.6523 L941,2542.6523 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="895" y="2560.2207">iter++</text><polygon fill="#A80036" points="1192.5,2609.584,1202.5,2613.584,1192.5,2617.584,1196.5,2613.584" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="884" x2="1198.5" y1="2613.584" y2="2613.584"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="891" y="2601.1865">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="913" y="2593.5313">Generate window content and aggregations</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="913" y="2608.8418">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="990" y="2608.8418">2001</text><path d="M1142.5,2628.584 L1611.5,2628.584 L1611.5,2635.584 L1601.5,2645.584 L1142.5,2645.584 L1142.5,2628.584 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="825.1797" style="stroke: #000000; stroke-width: 2.0;" width="761.5" x="1142.5" y="2628.584"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="424" x="1157.5" y="2642.1523">DB TRANSACTION: Generate window content and aggregations</text><path d="M1219,2650.8945 L1219,2675.8945 L1464,2675.8945 L1464,2660.8945 L1454,2650.8945 L1219,2650.8945 " fill="#D3D3D3" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1454,2650.8945 L1454,2660.8945 L1464,2660.8945 L1454,2650.8945 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1225" y="2668.4629">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="1245" y="2668.4629">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1401" y="2668.4629">= now()</text><polygon fill="#A80036" points="1549.5,2702.5156,1559.5,2706.5156,1549.5,2710.5156,1553.5,2706.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="2706.5156" y2="2706.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1221.5" y="2701.7734">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="1243.5" y="2701.7734">Determine window content and insert</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1256,2749.5156,1877,2749.5156,1887,2814.5156,1877,2879.5156,1256,2879.5156,1246,2814.5156,1256,2749.5156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1258" y="2766.084">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="1342" y="2766.084">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="351" x="1524" y="2766.084">(settlementWindowId, ledgerAccountTypeId, currencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="518" x="1258" y="2781.3945">SELECT DISTINCT {id} settlementWindowId, pc.ledgerAccountTypeId, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1258" y="2796.7051">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1298" y="2796.7051">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1424" y="2796.7051">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1258" y="2812.0156">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1290" y="2812.0156">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="1421" y="2812.0156">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1258" y="2827.3262">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1258" y="2842.6367">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1290" y="2842.6367">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1430" y="2842.6367">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="1258" y="2857.9473">ON pc.participantCurrencyId = tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="1258" y="2873.2578">WHERE tf.settlementWindowId = {id}</text><polygon fill="#A80036" points="1549.5,2902.3105,1559.5,2906.3105,1549.5,2910.3105,1553.5,2906.3105" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="2906.3105" y2="2906.3105"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1221.5" y="2901.5684">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="1243.5" y="2901.5684">Aggregate window data and insert</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1248,2949.3105,1884,2949.3105,1894,3075.3105,1884,3201.3105,1248,3201.3105,1238,3075.3105,1248,2949.3105" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1250" y="2965.8789">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1334" y="2965.8789">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="1548" y="2965.8789">(settlementWindowContentId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="533" x="1266" y="2981.1895">transferParticipantRoleTypeId, ledgerEntryTypeId, amount, settlementWindowStateId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="1250" y="2996.5">SELECT swc.settlementWindowContentId, pc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="1266" y="3011.8105">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount), 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1250" y="3027.1211">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1290" y="3027.1211">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1416" y="3027.1211">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1250" y="3042.4316">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1282" y="3042.4316">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="1413" y="3042.4316">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1250" y="3057.7422">ON tf.transferId = tp.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1250" y="3073.0527">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1282" y="3073.0527">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1422" y="3073.0527">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="1250" y="3088.3633">ON pc.participantCurrencyId = tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1250" y="3103.6738">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="1282" y="3103.6738">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1464" y="3103.6738">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="1250" y="3118.9844">ON swc.settlementWindowId = tf.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="1250" y="3134.2949">AND swc.ledgerAccountTypeId = pc.ledgerAccountTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="1250" y="3149.6055">AND swc.currencyId = pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="1250" y="3164.916">WHERE tf.settlementWindowId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="1250" y="3180.2266">GROUP BY swc.settlementWindowContentId, pc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="1266" y="3195.5371">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="1549.5,3224.5898,1559.5,3228.5898,1549.5,3232.5898,1553.5,3228.5898" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="3228.5898" y2="3228.5898"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1221.5" y="3223.8477">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1243.5" y="3223.8477">Insert initial window content state change</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1380,3271.5898,1753,3271.5898,1763,3313.5898,1753,3355.5898,1380,3355.5898,1370,3313.5898,1380,3271.5898" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1382" y="3288.1582">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="1466" y="3288.1582">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="1398" y="3303.4688">(settlementWindowContentId, settlementWindowStateId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="1382" y="3318.7793">SELECT swc.settlementWindowContentId, 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1382" y="3334.0898">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="1422" y="3334.0898">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1604" y="3334.0898">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="1382" y="3349.4004">WHERE swc.settlementWindowId = {id}</text><polygon fill="#A80036" points="1549.5,3378.4531,1559.5,3382.4531,1549.5,3386.4531,1553.5,3382.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="3382.4531" y2="3382.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1221.5" y="3377.7109">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="1243.5" y="3377.7109">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1481,3425.4531,1651,3425.4531,1661,3436.4531,1651,3448.4531,1481,3448.4531,1471,3436.4531,1481,3425.4531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1483" y="3442.0215">settlementWindowContent</text><polygon fill="#A80036" points="895,3478.0742,885,3482.0742,895,3486.0742,891,3482.0742" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="889" x2="1208.5" y1="3482.0742" y2="3482.0742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901" y="3477.332">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="923" y="3477.332">Return result</text><path d="M800.5,3497.0742 L867.5,3497.0742 L867.5,3504.0742 L857.5,3514.0742 L800.5,3514.0742 L800.5,3497.0742 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="473.2578" style="stroke: #000000; stroke-width: 2.0;" width="915.5" x="800.5" y="3497.0742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="815.5" y="3510.6426">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="51" x="882.5" y="3509.709">[success]</text><path d="M889,3519.3848 L889,3544.3848 L1088,3544.3848 L1088,3529.3848 L1078,3519.3848 L889,3519.3848 " fill="#D3D3D3" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1078,3519.3848 L1078,3529.3848 L1088,3529.3848 L1078,3519.3848 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="895" y="3536.9531">windowContentReady = true</text><polygon fill="#A80036" points="1192.5,3586.3164,1202.5,3590.3164,1192.5,3594.3164,1196.5,3590.3164" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="884" x2="1198.5" y1="3590.3164" y2="3590.3164"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="891" y="3577.9189">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="913" y="3570.2637">Close requested window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="913" y="3585.5742">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="990" y="3585.5742">2001</text><polygon fill="#A80036" points="1549.5,3615.627,1559.5,3619.627,1549.5,3623.627,1553.5,3619.627" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="3619.627" y2="3619.627"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1221.5" y="3614.8848">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="1243.5" y="3614.8848">Change window state to 'CLOSED'</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1437,3662.627,1696,3662.627,1706,3681.627,1696,3700.627,1437,3700.627,1427,3681.627,1437,3662.627" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1439" y="3679.1953">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1439" y="3694.5059">settlementWindow.currentStateChangeId</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="800.5" x2="1716" y1="3707.248" y2="3707.248"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="350" x="805.5" y="3717.8828">[failure &amp;&amp; iter &lt; Config.WIN_AGGREGATION_RETRY_COUNT]</text><path d="M889,3726.2031 L889,3751.2031 L1290,3751.2031 L1290,3736.2031 L1280,3726.2031 L889,3726.2031 " fill="#D3D3D3" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1280,3726.2031 L1280,3736.2031 L1290,3736.2031 L1280,3726.2031 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="895" y="3743.7715">sleep</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="935" y="3743.7715">Config.WIN_AGGREGATION_RETRY_INTERVAL seconds</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="800.5" x2="1716" y1="3761.5137" y2="3761.5137"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="45" x="805.5" y="3772.1484">[failure]</text><polygon fill="#A80036" points="1192.5,3808.0898,1202.5,3812.0898,1192.5,3816.0898,1196.5,3812.0898" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="884" x2="1198.5" y1="3812.0898" y2="3812.0898"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="891" y="3799.6924">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="913" y="3792.0371">Fail requested window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="913" y="3807.3477">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="990" y="3807.3477">2001</text><polygon fill="#A80036" points="1549.5,3837.4004,1559.5,3841.4004,1549.5,3845.4004,1553.5,3841.4004" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1214.5" x2="1555.5" y1="3841.4004" y2="3841.4004"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1221.5" y="3836.6582">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="1243.5" y="3836.6582">Change window state to 'FAILED'</text><polygon fill="#FFFFE0" filter="url(#f1vebogwh8r8fh)" points="1437,3884.4004,1696,3884.4004,1706,3903.4004,1696,3922.4004,1437,3922.4004,1427,3903.4004,1437,3884.4004" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1439" y="3900.9688">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1439" y="3916.2793">settlementWindow.currentStateChangeId</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="884" x2="926" y1="3949.332" y2="3949.332"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="926" x2="926" y1="3949.332" y2="3962.332"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="885" x2="926" y1="3962.332" y2="3962.332"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="885" x2="895" y1="3962.332" y2="3958.332"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="885" x2="895" y1="3962.332" y2="3966.332"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="891" y="3944.5898">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="913" y="3944.5898">Log ERROR event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1934" y1="3992.332" y2="3992.332"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="377" x2="424" y1="4009.6426" y2="4009.6426"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="4009.6426" y2="4022.6426"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="4022.6426" y2="4022.6426"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="393" y1="4022.6426" y2="4018.6426"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="393" y1="4022.6426" y2="4026.6426"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="4004.9004">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="411" y="4004.9004">Log ERROR event</text><path d="M33,4040.6426 L33,4141.6426 L363,4141.6426 L363,4050.6426 L353,4040.6426 L33,4040.6426 " fill="#FFFF00" filter="url(#f1vebogwh8r8fh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,4040.6426 L353,4050.6426 L363,4050.6426 L353,4040.6426 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="4058.2109">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="55" y="4073.5215">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="71" y="4088.832">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="71" y="4104.1426">"errorDescription": "Client error description"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="55" y="4119.4531">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="4134.7637">}</text><polygon fill="#A80036" points="127,4168.8164,117,4172.8164,127,4176.8164,123,4172.8164" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="121" x2="376" y1="4172.8164" y2="4172.8164"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="133" y="4168.0742">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="155" y="4168.0742">Respond HTTP - 4xx (Client error)</text><!--
@startuml
title 6.1.2. Close Settlement Window (closeSettlementWindow)

autonumber 

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
collections "topic-\nsettlement-window" as TOPIC_SET_WIN
control "Settlement Window\nHandler" as SET_WIN_HANDLER
collections "topic-event" as TOPIC_EVENT
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant TOPIC_SET_WIN
    participant SET_WIN_HANDLER
    participant TOPIC_EVENT
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Close Settlement Window
    activate OPERATOR
    activate SET_WIN_HANDLER
    note right of OPERATOR #yellow
        {
            "state": "CLOSED",
            "reason": <string>
        }
    end note

    OPERATOR -> SSAPI: POST - /settlementWindows/{id}
    activate SSAPI
    SSAPI -> SSAPI: Validate payload and requested state
    break
        note right of SSAPI #yellow
            {
                "errorInformation": {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid payload or state"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 400 (Bad Request)
    end
    SSAPI -> SETTLE_DAO: Get requested settlementWindow and state\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Get settlementWindow state
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId, 
               swsc.reason, sw.createdDate, swsc.createdDate changedDate
        FROM **settlementWindow** AS sw
        JOIN **settlementWindowStateChange** AS swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId = {id}
    end hnote
    deactivate DB
    SETTLE_DAO - -> SSAPI: Return result
    deactivate SETTLE_DAO

    alt settlementWindow found && settlementWindowStateId == 'OPEN'
        SSAPI -> SETTLE_DAO: Terminate current window and open a new one\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION: Terminate window usage and initate next</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Terminate requested window
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({id}, 'PROCESSING', {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementWindowStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {settlementWindowStateChangeId}
                WHERE settlementWindowId = {id}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Create new settlementWindow
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindow** (reason, createdDate)
                VALUES ({payload.reason}, {transactionTimestamp})
            end note
            SETTLE_DAO <- - DB: Return **settlementWindowId**
            deactivate DB

            SETTLE_DAO -> DB: Insert intial state for the created window
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({settlementWindowId}, 'OPEN', {payload.reason}, {transactionTimestamp})
            end note
            SETTLE_DAO <- - DB: Return **newSettlementWindowStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {newSettlementWindowStateChangeId}
                WHERE settlementWindowId = {settlementWindowId}
            end hnote
            deactivate DB
        end
        SSAPI <- - SETTLE_DAO: Return success
        deactivate SETTLE_DAO

        note right of SSAPI #yellow
            Message:
            {
                id: <uuid>
                from: switch,
                to: switch,
                type: application/json
                content: {
                    payload: {
                        settlementWindowId: {id}
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: null,
                        type: setwin,
                        action: close,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        SSAPI -> TOPIC_SET_WIN: Produce Settlement Window\nevent message\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_SET_WIN
        deactivate TOPIC_SET_WIN
        
        note left of SSAPI #yellow
            {
                "id": settlementWindowId,
                "state": 'OPEN',
                "reason": payload.reason,
                "createdDate": transactionTimestamp,
                "changedDate": transactionTimestamp
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)
        deactivate SSAPI
        deactivate OPERATOR

        group Settlement Window Handler processing
            TOPIC_SET_WIN <- SET_WIN_HANDLER: Consume Settlement Window\nevent message
            activate TOPIC_SET_WIN
            deactivate TOPIC_SET_WIN
    
            group Persist Event Information
                |||
                SET_WIN_HANDLER -> TOPIC_EVENT: Publish event information
                ref over SET_WIN_HANDLER, TOPIC_EVENT:  Event Handler Consume\n
                |||
            end
            note right of SET_WIN_HANDLER #lightgray
                let **id** = message.content.payload.settlementWindowId
                let **windowContentReady** = false
                let **iter** = 0
            end note

            loop iter < Config.WIN_AGGREGATION_RETRY_COUNT && !windowContentReady
                note right of SET_WIN_HANDLER #lightgray
                    iter++
                end note

                SET_WIN_HANDLER -> SETTLE_DAO: Generate window content and aggregations\n<color #FF0000><b>Error code:</b> 2001</color>
                activate SETTLE_DAO
                group <color #blue>DB TRANSACTION: Generate window content and aggregations</color>
                    note right of SETTLE_DAO #lightgray
                        let **transactionTimestamp** = now()
                    end note

                    SETTLE_DAO -> DB: Determine window content and insert
                    activate DB
                    hnote over DB #lightyellow
                        INSERT INTO **settlementWindowContent** (settlementWindowId, ledgerAccountTypeId, currencyId)
                        SELECT DISTINCT {id} settlementWindowId, pc.ledgerAccountTypeId, pc.currencyId
                        FROM **transferFulfilment** tf
                        JOIN **transferParticipant** tp
                        ON tp.transferId = tf.transferId
                        JOIN **participantCurrency** pc
                        ON pc.participantCurrencyId = tp.participantCurrencyId
                        WHERE tf.settlementWindowId = {id}
                    end hnote
                    deactivate DB

                    SETTLE_DAO -> DB: Aggregate window data and insert
                    activate DB
                    hnote over DB #lightyellow
                        INSERT INTO **settlementContentAggregation** (settlementWindowContentId, participantCurrencyId, 
                            transferParticipantRoleTypeId, ledgerEntryTypeId, amount, settlementWindowStateId)
                        SELECT swc.settlementWindowContentId, pc.participantCurrencyId,
                            tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount), 'CLOSED'
                        FROM **transferFulfilment** tf
                        JOIN **transferParticipant** tp
                        ON tf.transferId = tp.transferId
                        JOIN **participantCurrency** pc
                        ON pc.participantCurrencyId = tp.participantCurrencyId
                        JOIN **settlementWindowContent** swc
                        ON swc.settlementWindowId = tf.settlementWindowId
                        AND swc.ledgerAccountTypeId = pc.ledgerAccountTypeId
                        AND swc.currencyId = pc.currencyId
                        WHERE tf.settlementWindowId = {id}
                        GROUP BY swc.settlementWindowContentId, pc.participantCurrencyId, 
                            tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId
                    end hnote
                    deactivate DB

                    SETTLE_DAO -> DB: Insert initial window content state change
                    activate DB
                    hnote over DB #lightyellow
                        INSERT INTO **settlementWindowContentStateChange**
                            (settlementWindowContentId, settlementWindowStateId)
                        SELECT swc.settlementWindowContentId, 'CLOSED'
                        FROM **settlementWindowContent** swc
                        WHERE swc.settlementWindowId = {id}
                    end hnote
                    deactivate DB

                    SETTLE_DAO -> DB: Update pointers to current state change ids
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindowContent
                    end hnote
                    deactivate DB
                end
                SETTLE_DAO - -> SET_WIN_HANDLER: Return result
                deactivate SETTLE_DAO

                opt success
                    note right of SET_WIN_HANDLER #lightgray
                        windowContentReady = true
                    end note
                    SET_WIN_HANDLER -> SETTLE_DAO: Close requested window\n<color #FF0000><b>Error code:</b> 2001</color>
                    activate SETTLE_DAO
                    SETTLE_DAO -> DB: Change window state to 'CLOSED'
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindowStateChange
                        settlementWindow.currentStateChangeId
                    end hnote
                    deactivate DB
                    deactivate SETTLE_DAO
                else failure && iter < Config.WIN_AGGREGATION_RETRY_COUNT
                    note right of SET_WIN_HANDLER #lightgray
                        **sleep** Config.WIN_AGGREGATION_RETRY_INTERVAL seconds
                    end note
                else failure
                    SET_WIN_HANDLER -> SETTLE_DAO: Fail requested window\n<color #FF0000><b>Error code:</b> 2001</color>
                    activate SETTLE_DAO
                    SETTLE_DAO -> DB: Change window state to 'FAILED'
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindowStateChange
                        settlementWindow.currentStateChangeId
                    end hnote
                    deactivate DB
                    deactivate SETTLE_DAO

                    SET_WIN_HANDLER ->> SET_WIN_HANDLER: Log ERROR event
                end
            end
        end
    else
        SSAPI ->> SSAPI: Log ERROR event
        activate SSAPI
        note left of SSAPI #yellow
            {
                "errorInformation": {
                    "errorCode": <integer>,
                    "errorDescription": "Client error description"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
        deactivate SSAPI
        activate OPERATOR
    end
    deactivate OPERATOR
    deactivate SET_WIN_HANDLER
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.1
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>