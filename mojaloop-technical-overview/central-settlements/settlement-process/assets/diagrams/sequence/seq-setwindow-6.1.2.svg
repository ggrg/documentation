<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2862px" preserveAspectRatio="none" style="width:1414px;height:2862px;" version="1.1" viewBox="0 0 1414 2862" width="1414px" zoomAndPan="magnify"><defs><filter height="300%" id="f1hw8f7sh8mdpi" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="413" x="501.5" y="23.5352">6.1.2. Close Settlement Window (closeSettlementWindow)</text><rect fill="#FFB6C1" height="2817.2051" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="51" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="66.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="2817.2051" style="stroke: #A80036; stroke-width: 1.0;" width="454.5" x="294.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="459.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="2817.2051" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="988" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="991" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="2585.918" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="2455.0547" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="278.1504"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="683" y="541.5664"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="1745.7383" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="683" y="808.9824"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="570.877"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="901.9141"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1024.4668"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1147.709"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1254.9512"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1377.5039"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1761.1621"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1960.957"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="2283.2363"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="2437.0996"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="2593.918" style="stroke: #000000; stroke-width: 2.0;" width="1390" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="162.4844" style="stroke: #000000; stroke-width: 2.0;" width="687" x="45" y="335.4609"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="1986.1543" style="stroke: #000000; stroke-width: 2.0;" width="1370" x="23" y="755.0508"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="655.4531" style="stroke: #000000; stroke-width: 2.0;" width="701" x="621" y="823.9824"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="825.1797" style="stroke: #000000; stroke-width: 2.0;" width="762" x="621" y="1683.2305"/><rect fill="#FFFFFF" height="186.4844" style="stroke: none; stroke-width: 1.0;" width="1370" x="23" y="2554.7207"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="107" x2="107" y1="137.2871" y2="2765.2051"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="376.5" x2="376.5" y1="137.2871" y2="2765.2051"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="688" x2="688" y1="137.2871" y2="2765.2051"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1045" x2="1045" y1="137.2871" y2="2765.2051"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="55" y="134.334">Hub Employee</text><ellipse cx="107" cy="63.7988" fill="#FEFECE" filter="url(#f1hw8f7sh8mdpi)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M107,71.7988 L107,98.7988 M94,79.7988 L120,79.7988 M107,98.7988 L94,113.7988 M107,98.7988 L120,113.7988 " fill="none" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="55" y="2777.7402">Hub Employee</text><ellipse cx="107" cy="2790.6934" fill="#FEFECE" filter="url(#f1hw8f7sh8mdpi)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M107,2798.6934 L107,2825.6934 M94,2806.6934 L120,2806.6934 M107,2825.6934 L94,2840.6934 M107,2825.6934 L120,2840.6934 " fill="none" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="298.5" y="134.334">Settlement Service API</text><path d="M356.5,92.7988 L356.5,116.7988 M356.5,104.7988 L373.5,104.7988 " fill="none" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="385.5" cy="104.7988" fill="#FEFECE" filter="url(#f1hw8f7sh8mdpi)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="298.5" y="2777.7402">Settlement Service API</text><path d="M356.5,2784.6934 L356.5,2808.6934 M356.5,2796.6934 L373.5,2796.6934 " fill="none" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="385.5" cy="2796.6934" fill="#FEFECE" filter="url(#f1hw8f7sh8mdpi)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="631" y="134.334">Settlement DAO</text><ellipse cx="688" cy="104.7988" fill="#FEFECE" filter="url(#f1hw8f7sh8mdpi)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="676" x2="700" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="631" y="2777.7402">Settlement DAO</text><ellipse cx="688" cy="2796.6934" fill="#FEFECE" filter="url(#f1hw8f7sh8mdpi)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="676" x2="700" y1="2810.6934" y2="2810.6934"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="997" y="134.334">Central Store</text><path d="M1027,84.7988 C1027,74.7988 1045,74.7988 1045,74.7988 C1045,74.7988 1063,74.7988 1063,84.7988 L1063,110.7988 C1063,120.7988 1045,120.7988 1045,120.7988 C1045,120.7988 1027,120.7988 1027,110.7988 L1027,84.7988 " fill="#FEFECE" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1027,84.7988 C1027,94.7988 1045,94.7988 1045,94.7988 C1045,94.7988 1063,94.7988 1063,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="997" y="2777.7402">Central Store</text><path d="M1027,2790.6934 C1027,2780.6934 1045,2780.6934 1045,2780.6934 C1045,2780.6934 1063,2780.6934 1063,2790.6934 L1063,2816.6934 C1063,2826.6934 1045,2826.6934 1045,2826.6934 C1045,2826.6934 1027,2826.6934 1027,2816.6934 L1027,2790.6934 " fill="#FEFECE" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1027,2790.6934 C1027,2800.6934 1045,2800.6934 1045,2800.6934 C1045,2800.6934 1063,2800.6934 1063,2790.6934 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="2585.918" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="2455.0547" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="278.1504"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="683" y="541.5664"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="1745.7383" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="683" y="808.9824"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="570.877"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="901.9141"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1024.4668"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1147.709"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1254.9512"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1377.5039"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1761.1621"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="1960.957"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="2283.2363"/><rect fill="#FFFFFF" filter="url(#f1hw8f7sh8mdpi)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1040" y="2437.0996"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2593.918" style="stroke: #000000; stroke-width: 2.0;" width="1390" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Close Settlement Window</text><path d="M117,176.5977 L117,247.5977 L271,247.5977 L271,186.5977 L261,176.5977 L117,176.5977 " fill="#FFFF00" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M261,176.5977 L261,186.5977 L271,186.5977 L261,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="123" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="139" y="209.4766">"state": "CLOSED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="139" y="224.7871">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="123" y="240.0977">}</text><polygon fill="#A80036" points="360,274.1504,370,278.1504,360,282.1504,364,278.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="112" x2="366" y1="278.1504" y2="278.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="119" y="273.4082">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="132" y="273.4082">POST - /settlementWindows/{id}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="307.4609" y2="307.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="307.4609" y2="320.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="320.4609" y2="320.4609"/><polygon fill="#A80036" points="393,316.4609,383,320.4609,393,324.4609,389,320.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="302.7188">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="402" y="302.7188">Validate payload and requested state</text><path d="M45,335.4609 L129,335.4609 L129,342.4609 L119,352.4609 L45,352.4609 L45,335.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="162.4844" style="stroke: #000000; stroke-width: 2.0;" width="687" x="45" y="335.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="60" y="349.0293">break</text><path d="M387,357.7715 L387,458.7715 L718,458.7715 L718,367.7715 L708,357.7715 L387,357.7715 " fill="#FFFF00" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M708,357.7715 L708,367.7715 L718,367.7715 L708,357.7715 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="375.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="409" y="390.6504">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="425" y="405.9609">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="425" y="421.2715">"errorDescription": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="436.582">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="451.8926">}</text><polygon fill="#A80036" points="123,485.9453,113,489.9453,123,493.9453,119,489.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="117" x2="371" y1="489.9453" y2="489.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="129" y="485.2031">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="142" y="485.2031">Respond HTTP - 400 (Bad Request)</text><polygon fill="#A80036" points="671,537.5664,681,541.5664,671,545.5664,675,541.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="677" y1="541.5664" y2="541.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="529.1689">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="402" y="521.5137">Get requested settlementWindow and state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="536.8242">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="536.8242">2001</text><polygon fill="#A80036" points="1028,566.877,1038,570.877,1028,574.877,1032,570.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1034" y1="570.877" y2="570.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="700" y="566.1348">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="713" y="566.1348">Get settlementWindow state</text><polygon fill="#FFFFE0" filter="url(#f1hw8f7sh8mdpi)" points="823,613.877,1266,613.877,1276,662.877,1266,712.877,823,712.877,813,662.877,823,613.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="825" y="630.4453">SELECT sw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="853" y="645.7559">swsc.reason, sw.createdDate, swsc.createdDate changedDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="825" y="661.0664">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="865" y="661.0664">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="994" y="661.0664">AS sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="825" y="676.377">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="857" y="676.377">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="1071" y="676.377">AS swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="825" y="691.6875">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="825" y="706.998">WHERE sw.settlementWindowId = {id}</text><polygon fill="#A80036" points="393,736.0508,383,740.0508,393,744.0508,389,740.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="687" y1="740.0508" y2="740.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="399" y="735.3086">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="412" y="735.3086">Return result</text><path d="M23,755.0508 L85,755.0508 L85,762.0508 L75,772.0508 L23,772.0508 L23,755.0508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1986.1543" style="stroke: #000000; stroke-width: 2.0;" width="1370" x="23" y="755.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="768.6191">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="373" x="100" y="767.6855">[settlementWindow found &amp;&amp; settlementWindowStateId == 'OPEN']</text><polygon fill="#A80036" points="671,804.9824,681,808.9824,671,812.9824,675,808.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="677" y1="808.9824" y2="808.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="796.585">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="402" y="788.9297">Close current window and open a new one</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="804.2402">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="804.2402">2001</text><path d="M621,823.9824 L786,823.9824 L786,830.9824 L776,840.9824 L621,840.9824 L621,823.9824 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="655.4531" style="stroke: #000000; stroke-width: 2.0;" width="701" x="621" y="823.9824"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="636" y="837.5508">DB TRANSACTION</text><path d="M698,846.293 L698,871.293 L943,871.293 L943,856.293 L933,846.293 L698,846.293 " fill="#D3D3D3" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M933,846.293 L933,856.293 L943,856.293 L933,846.293 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="704" y="863.8613">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="724" y="863.8613">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="880" y="863.8613">= now()</text><polygon fill="#A80036" points="1028,897.9141,1038,901.9141,1028,905.9141,1032,901.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1034" y1="901.9141" y2="901.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="700" y="897.1719">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="713" y="897.1719">Close requested window</text><polygon fill="#FFFFE0" filter="url(#f1hw8f7sh8mdpi)" points="811,914.9141,1279,914.9141,1289,940.9141,1279,967.9141,811,967.9141,801,940.9141,811,914.9141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="813" y="931.4824">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="897" y="931.4824">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="841" y="946.793">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="813" y="962.1035">VALUES ({id}, {payload.state}, {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="704,991.1563,694,995.1563,704,999.1563,700,995.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="698" x2="1044" y1="995.1563" y2="995.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="710" y="990.4141">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="723" y="990.4141">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="223" x="768" y="990.4141">settlementWindowStateChangeId</text><polygon fill="#A80036" points="1028,1020.4668,1038,1024.4668,1028,1028.4668,1032,1024.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1034" y1="1024.4668" y2="1024.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1019.7246">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="722" y="1019.7246">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f1hw8f7sh8mdpi)" points="846,1067.4668,1243,1067.4668,1253,1093.4668,1243,1120.4668,846,1120.4668,836,1093.4668,846,1067.4668" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="848" y="1084.0352">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="902" y="1084.0352">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="848" y="1099.3457">SET currentStateChangeId = {settlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="848" y="1114.6563">WHERE settlementWindowId = {id}</text><polygon fill="#A80036" points="1028,1143.709,1038,1147.709,1028,1151.709,1032,1147.709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1034" y1="1147.709" y2="1147.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1142.9668">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="722" y="1142.9668">Create new settlementWindow</text><polygon fill="#FFFFE0" filter="url(#f1hw8f7sh8mdpi)" points="870,1160.709,1220,1160.709,1230,1179.709,1220,1198.709,870,1198.709,860,1179.709,870,1160.709" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="872" y="1177.2773">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="956" y="1177.2773">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1085" y="1177.2773">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="872" y="1192.5879">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="704,1221.6406,694,1225.6406,704,1229.6406,700,1225.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="698" x2="1044" y1="1225.6406" y2="1225.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="710" y="1220.8984">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="732" y="1220.8984">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="777" y="1220.8984">settlementWindowId</text><polygon fill="#A80036" points="1028,1250.9512,1038,1254.9512,1028,1258.9512,1032,1254.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1034" y1="1254.9512" y2="1254.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1250.209">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="722" y="1250.209">Insert intial state for the created window</text><polygon fill="#FFFFE0" filter="url(#f1hw8f7sh8mdpi)" points="787,1267.9512,1302,1267.9512,1312,1293.9512,1302,1320.9512,787,1320.9512,777,1293.9512,787,1267.9512" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="789" y="1284.5195">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="873" y="1284.5195">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="817" y="1299.8301">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="511" x="789" y="1315.1406">VALUES ({settlementWindowId}, 'OPEN', {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="704,1344.1934,694,1348.1934,704,1352.1934,700,1348.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="698" x2="1044" y1="1348.1934" y2="1348.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="710" y="1343.4512">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="732" y="1343.4512">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="251" x="777" y="1343.4512">newSettlementWindowStateChangeId</text><polygon fill="#A80036" points="1028,1373.5039,1038,1377.5039,1028,1381.5039,1032,1377.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1034" y1="1377.5039" y2="1377.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1372.7617">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="722" y="1372.7617">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f1hw8f7sh8mdpi)" points="834,1420.5039,1256,1420.5039,1266,1446.5039,1256,1473.5039,834,1473.5039,824,1446.5039,834,1420.5039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="836" y="1437.0723">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="890" y="1437.0723">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="418" x="836" y="1452.3828">SET currentStateChangeId = {newSettlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="836" y="1467.6934">WHERE settlementWindowId = {settlementWindowId}</text><polygon fill="#A80036" points="393,1503.7461,383,1507.7461,393,1511.7461,389,1507.7461" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="682" y1="1507.7461" y2="1507.7461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1503.0039">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="1503.0039">Return success</text><path d="M85,1520.7461 L85,1637.7461 L363,1637.7461 L363,1530.7461 L353,1520.7461 L85,1520.7461 " fill="#FFFF00" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,1520.7461 L353,1530.7461 L363,1530.7461 L353,1520.7461 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="91" y="1538.3145">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="107" y="1553.625">"id": settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="107" y="1568.9355">"state": 'OPEN',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="107" y="1584.2461">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="107" y="1599.5566">"createdDate": transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="107" y="1614.8672">"changedDate": transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="91" y="1630.1777">}</text><polygon fill="#A80036" points="123,1664.2305,113,1668.2305,123,1672.2305,119,1668.2305" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="117" x2="371" y1="1668.2305" y2="1668.2305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="129" y="1663.4883">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="151" y="1663.4883">Respond HTTP - 201 (Created)</text><path d="M621,1683.2305 L839,1683.2305 L839,1690.2305 L829,1700.2305 L621,1700.2305 L621,1683.2305 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="825.1797" style="stroke: #000000; stroke-width: 2.0;" width="762" x="621" y="1683.2305"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="173" x="636" y="1696.7988">DB TRANSACTION (async)</text><path d="M698,1705.541 L698,1730.541 L943,1730.541 L943,1715.541 L933,1705.541 L698,1705.541 " fill="#D3D3D3" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M933,1705.541 L933,1715.541 L943,1715.541 L933,1705.541 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="704" y="1723.1094">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="724" y="1723.1094">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="880" y="1723.1094">= now()</text><polygon fill="#A80036" points="1028,1757.1621,1038,1761.1621,1028,1765.1621,1032,1761.1621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1034" y1="1761.1621" y2="1761.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1756.4199">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="722" y="1756.4199">Determine window content and insert</text><polygon fill="#FFFFE0" filter="url(#f1hw8f7sh8mdpi)" points="734,1804.1621,1355,1804.1621,1365,1869.1621,1355,1934.1621,734,1934.1621,724,1869.1621,734,1804.1621" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="736" y="1820.7305">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="820" y="1820.7305">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="351" x="1002" y="1820.7305">(settlementWindowId, ledgerAccountTypeId, currencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="518" x="736" y="1836.041">SELECT DISTINCT {id} settlementWindowId, pc.ledgerAccountTypeId, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="736" y="1851.3516">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="776" y="1851.3516">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="902" y="1851.3516">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="736" y="1866.6621">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="768" y="1866.6621">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="899" y="1866.6621">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="736" y="1881.9727">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="736" y="1897.2832">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="768" y="1897.2832">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="908" y="1897.2832">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="736" y="1912.5938">ON pc.participantCurrencyId = tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="736" y="1927.9043">WHERE tf.settlementWindowId = {id}</text><polygon fill="#A80036" points="1028,1956.957,1038,1960.957,1028,1964.957,1032,1960.957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1034" y1="1960.957" y2="1960.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1956.2148">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="722" y="1956.2148">Aggregate window data and insert</text><polygon fill="#FFFFE0" filter="url(#f1hw8f7sh8mdpi)" points="727,2003.957,1363,2003.957,1373,2129.957,1363,2255.957,727,2255.957,717,2129.957,727,2003.957" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="729" y="2020.5254">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="813" y="2020.5254">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="1027" y="2020.5254">(settlementWindowContentId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="533" x="745" y="2035.8359">transferParticipantRoleTypeId, ledgerEntryTypeId, amount, settlementWindowStateId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="729" y="2051.1465">SELECT swc.settlementWindowContentId, pc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="745" y="2066.457">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount), 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="729" y="2081.7676">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="769" y="2081.7676">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="895" y="2081.7676">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="729" y="2097.0781">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="761" y="2097.0781">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="892" y="2097.0781">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="729" y="2112.3887">ON tf.transferId = tp.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="729" y="2127.6992">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="761" y="2127.6992">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="901" y="2127.6992">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="729" y="2143.0098">ON pc.participantCurrencyId = tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="729" y="2158.3203">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="761" y="2158.3203">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="943" y="2158.3203">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="729" y="2173.6309">ON swc.settlementWindowId = tf.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="729" y="2188.9414">AND swc.ledgerAccountTypeId = pc.ledgerAccountTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="729" y="2204.252">AND swc.currencyId = pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="729" y="2219.5625">WHERE tf.settlementWindowId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="729" y="2234.873">GROUP BY swc.settlementWindowContentId, pc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="745" y="2250.1836">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="1028,2279.2363,1038,2283.2363,1028,2287.2363,1032,2283.2363" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1034" y1="2283.2363" y2="2283.2363"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="2278.4941">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="722" y="2278.4941">Insert initial window content state change</text><polygon fill="#FFFFE0" filter="url(#f1hw8f7sh8mdpi)" points="858,2326.2363,1231,2326.2363,1241,2368.2363,1231,2410.2363,858,2410.2363,848,2368.2363,858,2326.2363" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="860" y="2342.8047">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="944" y="2342.8047">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="876" y="2358.1152">(settlementWindowContentId, settlementWindowStateId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="860" y="2373.4258">SELECT swc.settlementWindowContentId, 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="860" y="2388.7363">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="900" y="2388.7363">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1082" y="2388.7363">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="860" y="2404.0469">WHERE swc.settlementWindowId = {id}</text><polygon fill="#A80036" points="1028,2433.0996,1038,2437.0996,1028,2441.0996,1032,2437.0996" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1034" y1="2437.0996" y2="2437.0996"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="2432.3574">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="722" y="2432.3574">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1hw8f7sh8mdpi)" points="960,2480.0996,1130,2480.0996,1140,2491.0996,1130,2503.0996,960,2503.0996,950,2491.0996,960,2480.0996" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="962" y="2496.668">settlementWindowContent</text><path d="M698,2520.4102 L698,2545.4102 L1080,2545.4102 L1080,2530.4102 L1070,2520.4102 L698,2520.4102 " fill="#D3D3D3" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1070,2520.4102 L1070,2530.4102 L1080,2530.4102 L1070,2520.4102 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="704" y="2537.9785">How do we make sure async has completed successfully?</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1393" y1="2555.7207" y2="2555.7207"/><path d="M387,2561.7207 L387,2586.7207 L514,2586.7207 L514,2571.7207 L504,2561.7207 L387,2561.7207 " fill="#D3D3D3" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M504,2561.7207 L504,2571.7207 L514,2571.7207 L504,2561.7207 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="393" y="2579.2891">Log ERROR event</text><path d="M33,2601.0313 L33,2702.0313 L363,2702.0313 L363,2611.0313 L353,2601.0313 L33,2601.0313 " fill="#FFFF00" filter="url(#f1hw8f7sh8mdpi)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,2601.0313 L353,2611.0313 L363,2611.0313 L353,2601.0313 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="2618.5996">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="55" y="2633.9102">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="71" y="2649.2207">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="71" y="2664.5313">"errorDescription": "Client error description"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="55" y="2679.8418">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="2695.1523">}</text><polygon fill="#A80036" points="118,2729.2051,108,2733.2051,118,2737.2051,114,2733.2051" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112" x2="376" y1="2733.2051" y2="2733.2051"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124" y="2728.4629">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="146" y="2728.4629">Respond HTTP - 4xx (Client error)</text><!--
@startuml
title 6.1.2. Close Settlement Window (closeSettlementWindow)

autonumber 

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Close Settlement Window
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "state": "CLOSED",
            "reason": <string>
        }
    end note

    OPERATOR -> SSAPI: POST - /settlementWindows/{id}
    activate SSAPI
    SSAPI -> SSAPI: Validate payload and requested state
    break
        note right of SSAPI #yellow
            {
                "errorInformation": {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid payload or state"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 400 (Bad Request)
    end
    SSAPI -> SETTLE_DAO: Get requested settlementWindow and state\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Get settlementWindow state
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId, 
               swsc.reason, sw.createdDate, swsc.createdDate changedDate
        FROM **settlementWindow** AS sw
        JOIN **settlementWindowStateChange** AS swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId = {id}
    end hnote
    deactivate DB
    SETTLE_DAO - -> SSAPI: Return result
    deactivate SETTLE_DAO

    alt settlementWindow found && settlementWindowStateId == 'OPEN'
        SSAPI -> SETTLE_DAO: Close current window and open a new one\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Close requested window
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({id}, {payload.state}, {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementWindowStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {settlementWindowStateChangeId}
                WHERE settlementWindowId = {id}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Create new settlementWindow
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindow** (reason, createdDate)
                VALUES ({payload.reason}, {transactionTimestamp})
            end note
            SETTLE_DAO <- - DB: Return **settlementWindowId**
            deactivate DB

            SETTLE_DAO -> DB: Insert intial state for the created window
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({settlementWindowId}, 'OPEN', {payload.reason}, {transactionTimestamp})
            end note
            SETTLE_DAO <- - DB: Return **newSettlementWindowStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {newSettlementWindowStateChangeId}
                WHERE settlementWindowId = {settlementWindowId}
            end hnote
            deactivate DB
        end
        SSAPI <- - SETTLE_DAO: Return success

        note left of SSAPI #yellow
            {
                "id": settlementWindowId,
                "state": 'OPEN',
                "reason": payload.reason,
                "createdDate": transactionTimestamp,
                "changedDate": transactionTimestamp
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)

        group <color #red>DB TRANSACTION (async)</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Determine window content and insert
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowContent** (settlementWindowId, ledgerAccountTypeId, currencyId)
                SELECT DISTINCT {id} settlementWindowId, pc.ledgerAccountTypeId, pc.currencyId
                FROM **transferFulfilment** tf
                JOIN **transferParticipant** tp
                ON tp.transferId = tf.transferId
                JOIN **participantCurrency** pc
                ON pc.participantCurrencyId = tp.participantCurrencyId
                WHERE tf.settlementWindowId = {id}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Aggregate window data and insert
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementContentAggregation** (settlementWindowContentId, participantCurrencyId, 
                    transferParticipantRoleTypeId, ledgerEntryTypeId, amount, settlementWindowStateId)
                SELECT swc.settlementWindowContentId, pc.participantCurrencyId,
                    tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount), 'CLOSED'
                FROM **transferFulfilment** tf
                JOIN **transferParticipant** tp
                ON tf.transferId = tp.transferId
                JOIN **participantCurrency** pc
                ON pc.participantCurrencyId = tp.participantCurrencyId
                JOIN **settlementWindowContent** swc
                ON swc.settlementWindowId = tf.settlementWindowId
                AND swc.ledgerAccountTypeId = pc.ledgerAccountTypeId
                AND swc.currencyId = pc.currencyId
                WHERE tf.settlementWindowId = {id}
                GROUP BY swc.settlementWindowContentId, pc.participantCurrencyId, 
                    tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Insert initial window content state change
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowContentStateChange**
                    (settlementWindowContentId, settlementWindowStateId)
                SELECT swc.settlementWindowContentId, 'CLOSED'
                FROM **settlementWindowContent** swc
                WHERE swc.settlementWindowId = {id}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                settlementWindowContent
            end hnote
            deactivate DB
        end
        note right of SETTLE_DAO #lightgray
            <color #red>How do we make sure async has completed successfully?</color>
        end note
        deactivate SETTLE_DAO
    else
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                "errorInformation": {
                    "errorCode": <integer>,
                    "errorDescription": "Client error description"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.1
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>