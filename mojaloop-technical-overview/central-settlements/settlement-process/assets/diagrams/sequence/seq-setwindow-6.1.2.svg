<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4731px" preserveAspectRatio="none" style="width:2031px;height:4731px;" version="1.1" viewBox="0 0 2031 4731" width="2031px" zoomAndPan="magnify"><defs><filter height="300%" id="fk7wq2zq0apsz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="413" x="810" y="23.5352">6.1.2. Close Settlement Window (closeSettlementWindow)</text><rect fill="#FFB6C1" height="4685.7852" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="55" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="70.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="4685.7852" style="stroke: #A80036; stroke-width: 1.0;" width="963" x="294.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="714" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="4685.7852" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1575.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1578.5" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="2064.2598" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="106" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="15" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="106" y="4601.7852"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="1933.3965" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="278.1504"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="150.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="4451.3008"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="627" y="2021.0625"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="627" y="2280.4785"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="4469.498" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="861" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="556.877"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="698.7637" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="848.6035"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="2690.8262"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="1007.043" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="2897"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="59.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="4019.2852"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="59.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="4241.0586"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="586.1875"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="941.5352"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="1064.0879"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="1187.3301"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="1294.5723"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="1417.125"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="2720.1367"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="2989.9316"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="3097.8633"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="3328.2793"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="3650.5586"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="3804.4219"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="4048.5957"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="4270.3691"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="4462.498" style="stroke: #000000; stroke-width: 2.0;" width="2007" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="162.4844" style="stroke: #000000; stroke-width: 2.0;" width="689" x="49" y="350.7715"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="3839.4238" style="stroke: #000000; stroke-width: 2.0;" width="1987" x="23" y="770.3613"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="760.6953" style="stroke: #000000; stroke-width: 2.0;" width="1631.5" x="288.5" y="794.6719"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="655.4531" style="stroke: #000000; stroke-width: 2.0;" width="780.5" x="1129.5" y="863.6035"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="2186.7539" style="stroke: #000000; stroke-width: 2.0;" width="1455.5" x="544.5" y="2226.5469"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="352" x="787.5" y="2325.4785"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="1839.3379" style="stroke: #000000; stroke-width: 2.0;" width="1212.5" x="777.5" y="2566.9629"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="1068.9746" style="stroke: #000000; stroke-width: 2.0;" width="1192.5" x="787.5" y="2843.0684"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="963.7324" style="stroke: #000000; stroke-width: 2.0;" width="840.5" x="1129.5" y="2912"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="473.2578" style="stroke: #000000; stroke-width: 2.0;" width="994.5" x="787.5" y="3926.043"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="994.5" x="787.5" y="4135.2168"/><rect fill="#FFFFFF" height="209.8184" style="stroke: none; stroke-width: 1.0;" width="994.5" x="787.5" y="4189.4824"/><rect fill="#FFFFFF" height="189.4844" style="stroke: none; stroke-width: 1.0;" width="1987" x="23" y="4420.3008"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="111" x2="111" y1="137.2871" y2="4633.7852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="376.5" x2="376.5" y1="137.2871" y2="4633.7852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="631.5" x2="631.5" y1="137.2871" y2="4633.7852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="865.5" x2="865.5" y1="137.2871" y2="4633.7852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1078.5" x2="1078.5" y1="137.2871" y2="4633.7852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1196.5" x2="1196.5" y1="137.2871" y2="4633.7852"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1632.5" x2="1632.5" y1="137.2871" y2="4633.7852"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="59" y="134.334">Hub Employee</text><ellipse cx="111" cy="63.7988" fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M111,71.7988 L111,98.7988 M98,79.7988 L124,79.7988 M111,98.7988 L98,113.7988 M111,98.7988 L124,113.7988 " fill="none" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="59" y="4646.3203">Hub Employee</text><ellipse cx="111" cy="4659.2734" fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M111,4667.2734 L111,4694.2734 M98,4675.2734 L124,4675.2734 M111,4694.2734 L98,4709.2734 M111,4694.2734 L124,4709.2734 " fill="none" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="298.5" y="134.334">Settlement Service API</text><path d="M356.5,92.7988 L356.5,116.7988 M356.5,104.7988 L373.5,104.7988 " fill="none" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="385.5" cy="104.7988" fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="298.5" y="4646.3203">Settlement Service API</text><path d="M356.5,4653.2734 L356.5,4677.2734 M356.5,4665.2734 L373.5,4665.2734 " fill="none" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="385.5" cy="4665.2734" fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="147" x="558.5" y="81.3105"/><rect fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="147" x="554.5" y="85.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="607" y="105.8457">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="561.5" y="122.334">settlement-window</text><rect fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="147" x="558.5" y="4632.7852"/><rect fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="147" x="554.5" y="4636.7852"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="607" y="4657.3203">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="561.5" y="4673.8086">settlement-window</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="131" x="797.5" y="117.8457">Settlement Window</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="836" y="134.334">Handler</text><ellipse cx="866" cy="88.3105" fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="862,76.3105,868,71.3105,866,76.3105,868,81.3105,862,76.3105" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="131" x="797.5" y="4646.3203">Settlement Window</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="836" y="4662.8086">Handler</text><ellipse cx="866" cy="4681.7617" fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="862,4669.7617,868,4664.7617,866,4669.7617,868,4674.7617,862,4669.7617" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="1032.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="1028.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="1035.5" y="122.334">topic-event</text><rect fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="1032.5" y="4632.7852"/><rect fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="1028.5" y="4636.7852"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="1035.5" y="4657.3203">topic-event</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1139.5" y="134.334">Settlement DAO</text><ellipse cx="1196.5" cy="104.7988" fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1184.5" x2="1208.5" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1139.5" y="4646.3203">Settlement DAO</text><ellipse cx="1196.5" cy="4665.2734" fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1184.5" x2="1208.5" y1="4679.2734" y2="4679.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1584.5" y="134.334">Central Store</text><path d="M1614.5,84.7988 C1614.5,74.7988 1632.5,74.7988 1632.5,74.7988 C1632.5,74.7988 1650.5,74.7988 1650.5,84.7988 L1650.5,110.7988 C1650.5,120.7988 1632.5,120.7988 1632.5,120.7988 C1632.5,120.7988 1614.5,120.7988 1614.5,110.7988 L1614.5,84.7988 " fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1614.5,84.7988 C1614.5,94.7988 1632.5,94.7988 1632.5,94.7988 C1632.5,94.7988 1650.5,94.7988 1650.5,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1584.5" y="4646.3203">Central Store</text><path d="M1614.5,4659.2734 C1614.5,4649.2734 1632.5,4649.2734 1632.5,4649.2734 C1632.5,4649.2734 1650.5,4649.2734 1650.5,4659.2734 L1650.5,4685.2734 C1650.5,4695.2734 1632.5,4695.2734 1632.5,4695.2734 C1632.5,4695.2734 1614.5,4695.2734 1614.5,4685.2734 L1614.5,4659.2734 " fill="#FEFECE" filter="url(#fk7wq2zq0apsz)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1614.5,4659.2734 C1614.5,4669.2734 1632.5,4669.2734 1632.5,4669.2734 C1632.5,4669.2734 1650.5,4669.2734 1650.5,4659.2734 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="2064.2598" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="106" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="15" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="106" y="4601.7852"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="1933.3965" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="278.1504"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="150.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="4451.3008"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="627" y="2021.0625"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="627" y="2280.4785"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="4469.498" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="861" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="556.877"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="698.7637" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="848.6035"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="2690.8262"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="1007.043" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="2897"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="59.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="4019.2852"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="59.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1191.5" y="4241.0586"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="586.1875"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="941.5352"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="1064.0879"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="1187.3301"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="1294.5723"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="1417.125"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="2720.1367"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="2989.9316"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="3097.8633"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="3328.2793"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="3650.5586"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="3804.4219"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="4048.5957"/><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1627.5" y="4270.3691"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4462.498" style="stroke: #000000; stroke-width: 2.0;" width="2007" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Close Settlement Window</text><path d="M121,176.5977 L121,247.5977 L275,247.5977 L275,186.5977 L265,176.5977 L121,176.5977 " fill="#FFFF00" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M265,176.5977 L265,186.5977 L275,186.5977 L265,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="127" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="143" y="209.4766">"state": "CLOSED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="143" y="224.7871">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="127" y="240.0977">}</text><polygon fill="#A80036" points="360,274.1504,370,278.1504,360,282.1504,364,278.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="116" x2="366" y1="278.1504" y2="278.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="123" y="273.4082">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="136" y="273.4082">POST - /settlementWindows/{id}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="322.7715" y2="322.7715"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="322.7715" y2="335.7715"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="335.7715" y2="335.7715"/><polygon fill="#A80036" points="393,331.7715,383,335.7715,393,339.7715,389,335.7715" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="310.374">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="402" y="302.7188">Validate payload, existing window,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="402" y="318.0293">state, assigned transfers, etc.</text><path d="M49,350.7715 L133,350.7715 L133,357.7715 L123,367.7715 L49,367.7715 L49,350.7715 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="162.4844" style="stroke: #000000; stroke-width: 2.0;" width="689" x="49" y="350.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="64" y="364.3398">break</text><path d="M387,373.082 L387,474.082 L724,474.082 L724,383.082 L714,373.082 L387,373.082 " fill="#FFFF00" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M714,373.082 L714,383.082 L724,383.082 L714,373.082 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="390.6504">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="409" y="405.9609">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="425" y="421.2715">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="425" y="436.582">"errorDescription": "FSPIOP Error Description"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="451.8926">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="467.2031">}</text><polygon fill="#A80036" points="127,501.2559,117,505.2559,127,509.2559,123,505.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="121" x2="371" y1="505.2559" y2="505.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="133" y="500.5137">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="146" y="500.5137">Respond HTTP - 400 (Bad Request)</text><polygon fill="#A80036" points="1179.5,552.877,1189.5,556.877,1179.5,560.877,1183.5,556.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1185.5" y1="556.877" y2="556.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="544.4795">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="402" y="536.8242">Get requested settlementWindow and state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="552.1348">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="552.1348">2001</text><polygon fill="#A80036" points="1615.5,582.1875,1625.5,586.1875,1615.5,590.1875,1619.5,586.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="586.1875" y2="586.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1208.5" y="581.4453">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="1221.5" y="581.4453">Get settlementWindow state</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1411,629.1875,1854,629.1875,1864,678.1875,1854,728.1875,1411,728.1875,1401,678.1875,1411,629.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="1413" y="645.7559">SELECT sw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="1441" y="661.0664">swsc.reason, sw.createdDate, swsc.createdDate changedDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1413" y="676.377">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1453" y="676.377">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="1582" y="676.377">AS sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1413" y="691.6875">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1445" y="691.6875">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="1659" y="691.6875">AS swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="1413" y="706.998">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1413" y="722.3086">WHERE sw.settlementWindowId = {id}</text><polygon fill="#A80036" points="393,751.3613,383,755.3613,393,759.3613,389,755.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1195.5" y1="755.3613" y2="755.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="399" y="750.6191">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="412" y="750.6191">Return result</text><path d="M23,770.3613 L85,770.3613 L85,777.3613 L75,787.3613 L23,787.3613 L23,770.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3839.4238" style="stroke: #000000; stroke-width: 2.0;" width="1987" x="23" y="770.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="783.9297">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="373" x="100" y="782.9961">[settlementWindow found &amp;&amp; settlementWindowStateId == 'OPEN']</text><path d="M288.5,794.6719 L516.5,794.6719 L516.5,801.6719 L506.5,811.6719 L288.5,811.6719 L288.5,794.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="760.6953" style="stroke: #000000; stroke-width: 2.0;" width="1631.5" x="288.5" y="794.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="183" x="303.5" y="808.2402">Process settlement window</text><polygon fill="#A80036" points="1179.5,844.6035,1189.5,848.6035,1179.5,852.6035,1183.5,848.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="1185.5" y1="848.6035" y2="848.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="836.2061">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="402" y="828.5508">Terminate current window and open a new one</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="843.8613">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="843.8613">2001</text><path d="M1129.5,863.6035 L1583.5,863.6035 L1583.5,870.6035 L1573.5,880.6035 L1129.5,880.6035 L1129.5,863.6035 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="655.4531" style="stroke: #000000; stroke-width: 2.0;" width="780.5" x="1129.5" y="863.6035"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="409" x="1144.5" y="877.1719">DB TRANSACTION: Terminate window usage and initate next</text><path d="M1206,885.9141 L1206,910.9141 L1451,910.9141 L1451,895.9141 L1441,885.9141 L1206,885.9141 " fill="#D3D3D3" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1441,885.9141 L1441,895.9141 L1451,895.9141 L1441,885.9141 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1212" y="903.4824">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="1232" y="903.4824">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1388" y="903.4824">= now()</text><polygon fill="#A80036" points="1615.5,937.5352,1625.5,941.5352,1615.5,945.5352,1619.5,941.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="941.5352" y2="941.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1208.5" y="936.793">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="1221.5" y="936.793">Terminate requested window</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1404,954.5352,1860,954.5352,1870,980.5352,1860,1007.5352,1404,1007.5352,1394,980.5352,1404,954.5352" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1406" y="971.1035">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1490" y="971.1035">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="1422" y="986.4141">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="1406" y="1001.7246">VALUES ({id}, 'PROCESSING', {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="1212.5,1030.7773,1202.5,1034.7773,1212.5,1038.7773,1208.5,1034.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1206.5" x2="1631.5" y1="1034.7773" y2="1034.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1218.5" y="1030.0352">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="1231.5" y="1030.0352">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="223" x="1276.5" y="1030.0352">settlementWindowStateChangeId</text><polygon fill="#A80036" points="1615.5,1060.0879,1625.5,1064.0879,1615.5,1068.0879,1619.5,1064.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="1064.0879" y2="1064.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="1059.3457">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1230.5" y="1059.3457">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1434,1107.0879,1831,1107.0879,1841,1133.0879,1831,1160.0879,1434,1160.0879,1424,1133.0879,1434,1107.0879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1436" y="1123.6563">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1490" y="1123.6563">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="1436" y="1138.9668">SET currentStateChangeId = {settlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="1436" y="1154.2773">WHERE settlementWindowId = {id}</text><polygon fill="#A80036" points="1615.5,1183.3301,1625.5,1187.3301,1615.5,1191.3301,1619.5,1187.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="1187.3301" y2="1187.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="1182.5879">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="1230.5" y="1182.5879">Create new settlementWindow</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1457,1200.3301,1807,1200.3301,1817,1219.3301,1807,1238.3301,1457,1238.3301,1447,1219.3301,1457,1200.3301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1459" y="1216.8984">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1543" y="1216.8984">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1672" y="1216.8984">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="1459" y="1232.209">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="1212.5,1261.2617,1202.5,1265.2617,1212.5,1269.2617,1208.5,1265.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1206.5" x2="1631.5" y1="1265.2617" y2="1265.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1218.5" y="1260.5195">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="1240.5" y="1260.5195">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="1285.5" y="1260.5195">settlementWindowId</text><polygon fill="#A80036" points="1615.5,1290.5723,1625.5,1294.5723,1615.5,1298.5723,1619.5,1294.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="1294.5723" y2="1294.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="1289.8301">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1230.5" y="1289.8301">Insert intial state for the created window</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1375,1307.5723,1890,1307.5723,1900,1333.5723,1890,1360.5723,1375,1360.5723,1365,1333.5723,1375,1307.5723" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1377" y="1324.1406">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1461" y="1324.1406">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="1393" y="1339.4512">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="511" x="1377" y="1354.7617">VALUES ({settlementWindowId}, 'OPEN', {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="1212.5,1383.8145,1202.5,1387.8145,1212.5,1391.8145,1208.5,1387.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1206.5" x2="1631.5" y1="1387.8145" y2="1387.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1218.5" y="1383.0723">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="1240.5" y="1383.0723">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="251" x="1285.5" y="1383.0723">newSettlementWindowStateChangeId</text><polygon fill="#A80036" points="1615.5,1413.125,1625.5,1417.125,1615.5,1421.125,1619.5,1417.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="1417.125" y2="1417.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="1412.3828">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1230.5" y="1412.3828">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1421,1460.125,1843,1460.125,1853,1486.125,1843,1513.125,1421,1513.125,1411,1486.125,1421,1460.125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1423" y="1476.6934">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1477" y="1476.6934">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="418" x="1423" y="1492.0039">SET currentStateChangeId = {newSettlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="1423" y="1507.3145">WHERE settlementWindowId = {settlementWindowId}</text><polygon fill="#A80036" points="393,1543.3672,383,1547.3672,393,1551.3672,389,1547.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="1195.5" y1="1547.3672" y2="1547.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1542.625">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="1542.625">Return success</text><path d="M387,1567.3672 L387,1959.3672 L615,1959.3672 L615,1577.3672 L605,1567.3672 L387,1567.3672 " fill="#FFFF00" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M605,1567.3672 L605,1577.3672 L615,1577.3672 L605,1567.3672 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="393" y="1584.9355">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="1600.2461">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="409" y="1615.5566">id: &lt;uuid&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="409" y="1630.8672">from: switch,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="409" y="1646.1777">to: switch,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="409" y="1661.4883">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="409" y="1676.7988">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="425" y="1692.1094">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="441" y="1707.4199">settlementWindowId: {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="1722.7305">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="409" y="1738.041">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="409" y="1753.3516">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="1768.6621">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="441" y="1783.9727">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="441" y="1799.2832">responseTo: null,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="441" y="1814.5938">type: setwin,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="441" y="1829.9043">action: close,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="441" y="1845.2148">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="441" y="1860.5254">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="457" y="1875.8359">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="457" y="1891.1465">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="441" y="1906.457">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="1921.7676">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="1937.0781">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="1952.3887">}</text><polygon fill="#A80036" points="615,2017.0625,625,2021.0625,615,2025.0625,619,2021.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="621" y1="2021.0625" y2="2021.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="2001.0098">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="411" y="1985.6992">Produce Settlement Window</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="411" y="2001.0098">event message</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="411" y="2016.3203">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="495" y="2016.3203">2003</text><path d="M85,2064.0625 L85,2181.0625 L363,2181.0625 L363,2074.0625 L353,2064.0625 L85,2064.0625 " fill="#FFFF00" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,2064.0625 L353,2074.0625 L363,2074.0625 L353,2064.0625 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="91" y="2081.6309">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="107" y="2096.9414">"id": settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="107" y="2112.252">"state": 'OPEN',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="107" y="2127.5625">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="107" y="2142.873">"createdDate": transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="107" y="2158.1836">"changedDate": transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="91" y="2173.4941">}</text><polygon fill="#A80036" points="122,2207.5469,112,2211.5469,122,2215.5469,118,2211.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="116" x2="376" y1="2211.5469" y2="2211.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="128" y="2206.8047">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="150" y="2206.8047">Respond HTTP - 201 (Created)</text><path d="M544.5,2226.5469 L950.5,2226.5469 L950.5,2233.5469 L940.5,2243.5469 L544.5,2243.5469 L544.5,2226.5469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2186.7539" style="stroke: #000000; stroke-width: 2.0;" width="1455.5" x="544.5" y="2226.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="361" x="559.5" y="2240.1152">Close settlement window (SettlementWindowHandler)</text><polygon fill="#A80036" points="648,2276.4785,638,2280.4785,648,2284.4785,644,2280.4785" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="642" x2="860" y1="2280.4785" y2="2280.4785"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="654" y="2268.0811">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="676" y="2260.4258">Consume Settlement Window</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="676" y="2275.7363">event message</text><path d="M787.5,2325.4785 L1002.5,2325.4785 L1002.5,2332.4785 L992.5,2342.4785 L787.5,2342.4785 L787.5,2325.4785 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="352" x="787.5" y="2325.4785"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="802.5" y="2339.0469">Persist Event Information</text><polygon fill="#A80036" points="1067,2385.0996,1077,2389.0996,1067,2393.0996,1071,2389.0996" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="871" x2="1073" y1="2389.0996" y2="2389.0996"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="878" y="2384.3574">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="900" y="2384.3574">Publish event information</text><rect fill="#FFFFFF" filter="url(#fk7wq2zq0apsz)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="334" x="794.5" y="2397.0996"/><polygon fill="#EEEEEE" points="794.5,2397.0996,858.5,2397.0996,858.5,2404.0996,848.5,2414.0996,794.5,2414.0996,794.5,2397.0996" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="807.5" y="2411.668">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="888.5" y="2430.668">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="892.5" y="2445.9785"/><path d="M876,2495.0313 L876,2550.0313 L1240,2550.0313 L1240,2505.0313 L1230,2495.0313 L876,2495.0313 " fill="#D3D3D3" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1230,2495.0313 L1230,2505.0313 L1240,2505.0313 L1230,2495.0313 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="882" y="2512.5996">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13" x="902" y="2512.5996">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="919" y="2512.5996">= message.content.payload.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="882" y="2527.9102">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="902" y="2527.9102">windowContentReady</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1053" y="2527.9102">= false</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="882" y="2543.2207">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="23" x="902" y="2543.2207">iter</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="929" y="2543.2207">= 0</text><path d="M777.5,2566.9629 L851.5,2566.9629 L851.5,2573.9629 L841.5,2583.9629 L777.5,2583.9629 L777.5,2566.9629 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1839.3379" style="stroke: #000000; stroke-width: 2.0;" width="1212.5" x="777.5" y="2566.9629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="792.5" y="2580.5313">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="435" x="866.5" y="2579.5977">[iter &lt; Config.WIN_AGGREGATION_RETRY_COUNT &amp;&amp; !windowContentReady]</text><path d="M876,2589.2734 L876,2614.2734 L938,2614.2734 L938,2599.2734 L928,2589.2734 L876,2589.2734 " fill="#D3D3D3" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M928,2589.2734 L928,2599.2734 L938,2599.2734 L928,2589.2734 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="882" y="2606.8418">iter++</text><polygon fill="#A80036" points="1179.5,2686.8262,1189.5,2690.8262,1179.5,2694.8262,1183.5,2690.8262" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="871" x2="1185.5" y1="2690.8262" y2="2690.8262"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="878" y="2663.1182">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="900" y="2640.1523">Check if all transferParticipant records</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="900" y="2655.4629">for the requested window have been set</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="900" y="2670.7734">(currentStateChangeId is NOT NULL).</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="900" y="2686.084">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="977" y="2686.084">2001</text><polygon fill="#A80036" points="1615.5,2716.1367,1625.5,2720.1367,1615.5,2724.1367,1619.5,2720.1367" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="2720.1367" y2="2720.1367"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="2715.3945">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="1230.5" y="2715.3945">Use EXISTS query to find NULL currentStateChangeId records</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1572,2763.1367,1692,2763.1367,1702,2782.1367,1692,2801.1367,1572,2801.1367,1562,2782.1367,1572,2763.1367" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1574" y="2779.7051">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1574" y="2795.0156">transferParticipant</text><polygon fill="#A80036" points="882,2824.0684,872,2828.0684,882,2832.0684,878,2828.0684" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="876" x2="1195.5" y1="2828.0684" y2="2828.0684"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="888" y="2823.3262">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="910" y="2823.3262">Return result (success / failure)</text><path d="M787.5,2843.0684 L854.5,2843.0684 L854.5,2850.0684 L844.5,2860.0684 L787.5,2860.0684 L787.5,2843.0684 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1068.9746" style="stroke: #000000; stroke-width: 2.0;" width="1192.5" x="787.5" y="2843.0684"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="802.5" y="2856.6367">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="869.5" y="2855.7031">[transferParticipant records have been processed by central-ledger SettlementModelHandler]</text><polygon fill="#A80036" points="1179.5,2893,1189.5,2897,1179.5,2901,1183.5,2897" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="871" x2="1185.5" y1="2897" y2="2897"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="878" y="2884.6025">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="900" y="2876.9473">Generate window content and aggregations</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="900" y="2892.2578">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="977" y="2892.2578">2001</text><path d="M1129.5,2912 L1598.5,2912 L1598.5,2919 L1588.5,2929 L1129.5,2929 L1129.5,2912 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="963.7324" style="stroke: #000000; stroke-width: 2.0;" width="840.5" x="1129.5" y="2912"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="424" x="1144.5" y="2925.5684">DB TRANSACTION: Generate window content and aggregations</text><path d="M1206,2934.3105 L1206,2959.3105 L1451,2959.3105 L1451,2944.3105 L1441,2934.3105 L1206,2934.3105 " fill="#D3D3D3" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1441,2934.3105 L1441,2944.3105 L1451,2944.3105 L1441,2934.3105 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1212" y="2951.8789">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="1232" y="2951.8789">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1388" y="2951.8789">= now()</text><polygon fill="#A80036" points="1615.5,2985.9316,1625.5,2989.9316,1615.5,2993.9316,1619.5,2989.9316" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="2989.9316" y2="2989.9316"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="2985.1895">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="1230.5" y="2985.1895">Change all applicable entries to CLOSED state</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1533,3032.9316,1731,3032.9316,1741,3051.9316,1731,3070.9316,1533,3070.9316,1523,3051.9316,1533,3032.9316" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1535" y="3049.5">transferParticipantStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1535" y="3064.8105">transferParticipant</text><polygon fill="#A80036" points="1615.5,3093.8633,1625.5,3097.8633,1615.5,3101.8633,1619.5,3097.8633" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="3097.8633" y2="3097.8633"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="3093.1211">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="1230.5" y="3093.1211">Determine window content and insert</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1359,3140.8633,1906,3140.8633,1916,3220.8633,1906,3301.8633,1359,3301.8633,1349,3220.8633,1359,3140.8633" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1361" y="3157.4316">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="1445" y="3157.4316">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="1627" y="3157.4316">(settlementWindowId, ledgerAccountTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="1377" y="3172.7422">currencyId,  createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="429" x="1361" y="3188.0527">SELECT DISTINCT {id} settlementWindowId, pc.ledgerAccountTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1377" y="3203.3633">pc.currencyId, transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1361" y="3218.6738">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1401" y="3218.6738">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1527" y="3218.6738">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1361" y="3233.9844">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1393" y="3233.9844">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="1524" y="3233.9844">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1361" y="3249.2949">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1361" y="3264.6055">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1393" y="3264.6055">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1533" y="3264.6055">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="1361" y="3279.916">ON pc.participantCurrencyId = tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="1361" y="3295.2266">WHERE tf.settlementWindowId = {id}</text><polygon fill="#A80036" points="1615.5,3324.2793,1625.5,3328.2793,1615.5,3332.2793,1619.5,3328.2793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="3328.2793" y2="3328.2793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="3323.5371">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="1230.5" y="3323.5371">Aggregate window data and insert</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1314,3371.2793,1950,3371.2793,1960,3497.2793,1950,3623.2793,1314,3623.2793,1304,3497.2793,1314,3371.2793" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1316" y="3387.8477">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1400" y="3387.8477">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="1614" y="3387.8477">(settlementWindowContentId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="545" x="1332" y="3403.1582">transferParticipantRoleTypeId, ledgerEntryTypeId, currentStateId, createdDate, amount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="632" x="1316" y="3418.4688">SELECT swc.settlementWindowContentId, pc.participantCurrencyId, tp.transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="451" x="1332" y="3433.7793">tp.ledgerEntryTypeId, 'CLOSED', transactionTimestamp, SUM(tp.amount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1316" y="3449.0898">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1356" y="3449.0898">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1482" y="3449.0898">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1316" y="3464.4004">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1348" y="3464.4004">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="1479" y="3464.4004">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1316" y="3479.7109">ON tf.transferId = tp.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1316" y="3495.0215">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1348" y="3495.0215">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1488" y="3495.0215">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="1316" y="3510.332">ON pc.participantCurrencyId = tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1316" y="3525.6426">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="1348" y="3525.6426">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1530" y="3525.6426">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="1316" y="3540.9531">ON swc.settlementWindowId = tf.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="1316" y="3556.2637">AND swc.ledgerAccountTypeId = pc.ledgerAccountTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="1316" y="3571.5742">AND swc.currencyId = pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1316" y="3586.8848">WHERE ttf.settlementWindowId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="1316" y="3602.1953">GROUP BY swc.settlementWindowContentId, pc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="1332" y="3617.5059">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="1615.5,3646.5586,1625.5,3650.5586,1615.5,3654.5586,1619.5,3650.5586" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="3650.5586" y2="3650.5586"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="3645.8164">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1230.5" y="3645.8164">Insert initial window content state change</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1446,3693.5586,1819,3693.5586,1829,3735.5586,1819,3777.5586,1446,3777.5586,1436,3735.5586,1446,3693.5586" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1448" y="3710.127">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="1532" y="3710.127">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="1464" y="3725.4375">(settlementWindowContentId, settlementWindowStateId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="1448" y="3740.748">SELECT swc.settlementWindowContentId, 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1448" y="3756.0586">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="1488" y="3756.0586">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1670" y="3756.0586">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="1448" y="3771.3691">WHERE swc.settlementWindowId = {id}</text><polygon fill="#A80036" points="1615.5,3800.4219,1625.5,3804.4219,1615.5,3808.4219,1619.5,3804.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="3804.4219" y2="3804.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="3799.6797">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="1230.5" y="3799.6797">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1547,3847.4219,1717,3847.4219,1727,3858.4219,1717,3870.4219,1547,3870.4219,1537,3858.4219,1547,3847.4219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1549" y="3863.9902">settlementWindowContent</text><polygon fill="#A80036" points="882,3900.043,872,3904.043,882,3908.043,878,3904.043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="876" x2="1195.5" y1="3904.043" y2="3904.043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="888" y="3899.3008">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="910" y="3899.3008">Return result (success / failure)</text><path d="M787.5,3926.043 L849.5,3926.043 L849.5,3933.043 L839.5,3943.043 L787.5,3943.043 L787.5,3926.043 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="473.2578" style="stroke: #000000; stroke-width: 2.0;" width="994.5" x="787.5" y="3926.043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="802.5" y="3939.6113">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="51" x="864.5" y="3938.6777">[success]</text><path d="M876,3948.3535 L876,3973.3535 L1075,3973.3535 L1075,3958.3535 L1065,3948.3535 L876,3948.3535 " fill="#D3D3D3" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1065,3948.3535 L1065,3958.3535 L1075,3958.3535 L1065,3948.3535 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="882" y="3965.9219">windowContentReady = true</text><polygon fill="#A80036" points="1179.5,4015.2852,1189.5,4019.2852,1179.5,4023.2852,1183.5,4019.2852" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="871" x2="1185.5" y1="4019.2852" y2="4019.2852"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="878" y="4006.8877">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="900" y="3999.2324">Close requested window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="900" y="4014.543">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="977" y="4014.543">2001</text><polygon fill="#A80036" points="1615.5,4044.5957,1625.5,4048.5957,1615.5,4052.5957,1619.5,4048.5957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="4048.5957" y2="4048.5957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="4043.8535">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="1230.5" y="4043.8535">Change window state to 'CLOSED'</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1503,4091.5957,1762,4091.5957,1772,4110.5957,1762,4129.5957,1503,4129.5957,1493,4110.5957,1503,4091.5957" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1505" y="4108.1641">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1505" y="4123.4746">settlementWindow.currentStateChangeId</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="787.5" x2="1782" y1="4136.2168" y2="4136.2168"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="350" x="792.5" y="4146.8516">[failure &amp;&amp; iter &lt; Config.WIN_AGGREGATION_RETRY_COUNT]</text><path d="M876,4155.1719 L876,4180.1719 L1277,4180.1719 L1277,4165.1719 L1267,4155.1719 L876,4155.1719 " fill="#D3D3D3" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1267,4155.1719 L1267,4165.1719 L1277,4165.1719 L1267,4155.1719 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="882" y="4172.7402">sleep</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="922" y="4172.7402">Config.WIN_AGGREGATION_RETRY_INTERVAL seconds</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="787.5" x2="1782" y1="4190.4824" y2="4190.4824"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="45" x="792.5" y="4201.1172">[failure]</text><polygon fill="#A80036" points="1179.5,4237.0586,1189.5,4241.0586,1179.5,4245.0586,1183.5,4241.0586" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="871" x2="1185.5" y1="4241.0586" y2="4241.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="878" y="4228.6611">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="900" y="4221.0059">Fail requested window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="900" y="4236.3164">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="977" y="4236.3164">2001</text><polygon fill="#A80036" points="1615.5,4266.3691,1625.5,4270.3691,1615.5,4274.3691,1619.5,4270.3691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1621.5" y1="4270.3691" y2="4270.3691"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1208.5" y="4265.627">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="1230.5" y="4265.627">Change window state to 'FAILED'</text><polygon fill="#FFFFE0" filter="url(#fk7wq2zq0apsz)" points="1503,4313.3691,1762,4313.3691,1772,4332.3691,1762,4351.3691,1503,4351.3691,1493,4332.3691,1503,4313.3691" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1505" y="4329.9375">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1505" y="4345.248">settlementWindow.currentStateChangeId</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="871" x2="913" y1="4378.3008" y2="4378.3008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="913" x2="913" y1="4378.3008" y2="4391.3008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="872" x2="913" y1="4391.3008" y2="4391.3008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="872" x2="882" y1="4391.3008" y2="4387.3008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="872" x2="882" y1="4391.3008" y2="4395.3008"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="878" y="4373.5586">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="900" y="4373.5586">Log ERROR event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="2010" y1="4421.3008" y2="4421.3008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="377" x2="424" y1="4438.6113" y2="4438.6113"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="4438.6113" y2="4451.6113"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="4451.6113" y2="4451.6113"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="393" y1="4451.6113" y2="4447.6113"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="393" y1="4451.6113" y2="4455.6113"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="389" y="4433.8691">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="411" y="4433.8691">Log ERROR event</text><path d="M33,4469.6113 L33,4570.6113 L363,4570.6113 L363,4479.6113 L353,4469.6113 L33,4469.6113 " fill="#FFFF00" filter="url(#fk7wq2zq0apsz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,4469.6113 L353,4479.6113 L363,4479.6113 L353,4469.6113 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="4487.1797">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="55" y="4502.4902">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="71" y="4517.8008">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="71" y="4533.1113">"errorDescription": "Client error description"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="55" y="4548.4219">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="4563.7324">}</text><polygon fill="#A80036" points="127,4597.7852,117,4601.7852,127,4605.7852,123,4601.7852" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="121" x2="376" y1="4601.7852" y2="4601.7852"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="133" y="4597.043">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="155" y="4597.043">Respond HTTP - 4xx (Client error)</text><!--
@startuml
title 6.1.2. Close Settlement Window (closeSettlementWindow)

autonumber 

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
collections "topic-\nsettlement-window" as TOPIC_SET_WIN
control "Settlement Window\nHandler" as SET_WIN_HANDLER
collections "topic-event" as TOPIC_EVENT
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant TOPIC_SET_WIN
    participant SET_WIN_HANDLER
    participant TOPIC_EVENT
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Close Settlement Window
    activate OPERATOR
    activate SET_WIN_HANDLER
    note right of OPERATOR #yellow
        {
            "state": "CLOSED",
            "reason": <string>
        }
    end note

    OPERATOR -> SSAPI: POST - /settlementWindows/{id}
    activate SSAPI
    SSAPI -> SSAPI: Validate payload, existing window,\nstate, assigned transfers, etc.
    break
        note right of SSAPI #yellow
            {
                "errorInformation": {
                    "errorCode": <integer>,
                    "errorDescription": "FSPIOP Error Description"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 400 (Bad Request)
    end
    SSAPI -> SETTLE_DAO: Get requested settlementWindow and state\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Get settlementWindow state
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId, 
               swsc.reason, sw.createdDate, swsc.createdDate changedDate
        FROM **settlementWindow** AS sw
        JOIN **settlementWindowStateChange** AS swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId = {id}
    end hnote
    deactivate DB
    SETTLE_DAO - -> SSAPI: Return result
    deactivate SETTLE_DAO

    alt settlementWindow found && settlementWindowStateId == 'OPEN'
        group Process settlement window
            SSAPI -> SETTLE_DAO: Terminate current window and open a new one\n<color #FF0000><b>Error code:</b> 2001</color>
            activate SETTLE_DAO
            group <color #blue>DB TRANSACTION: Terminate window usage and initate next</color>
                note right of SETTLE_DAO #lightgray
                    let **transactionTimestamp** = now()
                end note

                SETTLE_DAO -> DB: Terminate requested window
                activate DB
                hnote over DB #lightyellow
                    INSERT INTO **settlementWindowStateChange**
                        (settlementWindowId, settlementWindowStateId, reason, createdDate)
                    VALUES ({id}, 'PROCESSING', {payload.reason}, {transactionTimestamp})
                end hnote
                SETTLE_DAO <- - DB: Return **settlementWindowStateChangeId**
                deactivate DB

                SETTLE_DAO -> DB: Update pointer to current state change id
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlementWindow**
                    SET currentStateChangeId = {settlementWindowStateChangeId}
                    WHERE settlementWindowId = {id}
                end hnote
                deactivate DB

                SETTLE_DAO -> DB: Create new settlementWindow
                activate DB
                hnote over DB #lightyellow
                    INSERT INTO **settlementWindow** (reason, createdDate)
                    VALUES ({payload.reason}, {transactionTimestamp})
                end note
                SETTLE_DAO <- - DB: Return **settlementWindowId**
                deactivate DB

                SETTLE_DAO -> DB: Insert intial state for the created window
                activate DB
                hnote over DB #lightyellow
                    INSERT INTO **settlementWindowStateChange**
                        (settlementWindowId, settlementWindowStateId, reason, createdDate)
                    VALUES ({settlementWindowId}, 'OPEN', {payload.reason}, {transactionTimestamp})
                end note
                SETTLE_DAO <- - DB: Return **newSettlementWindowStateChangeId**
                deactivate DB

                SETTLE_DAO -> DB: Update pointer to current state change id
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlementWindow**
                    SET currentStateChangeId = {newSettlementWindowStateChangeId}
                    WHERE settlementWindowId = {settlementWindowId}
                end hnote
                deactivate DB
            end
            SSAPI <- - SETTLE_DAO: Return success
            deactivate SETTLE_DAO
        end

        note right of SSAPI #yellow
            Message:
            {
                id: <uuid>
                from: switch,
                to: switch,
                type: application/json
                content: {
                    payload: {
                        settlementWindowId: {id}
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: null,
                        type: setwin,
                        action: close,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        SSAPI -> TOPIC_SET_WIN: Produce Settlement Window\nevent message\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_SET_WIN
        deactivate TOPIC_SET_WIN
        
        note left of SSAPI #yellow
            {
                "id": settlementWindowId,
                "state": 'OPEN',
                "reason": payload.reason,
                "createdDate": transactionTimestamp,
                "changedDate": transactionTimestamp
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)
        deactivate SSAPI
        deactivate OPERATOR

        group Close settlement window (SettlementWindowHandler)
            TOPIC_SET_WIN <- SET_WIN_HANDLER: Consume Settlement Window\nevent message
            activate TOPIC_SET_WIN
            deactivate TOPIC_SET_WIN
    
            group Persist Event Information
                |||
                SET_WIN_HANDLER -> TOPIC_EVENT: Publish event information
                ref over SET_WIN_HANDLER, TOPIC_EVENT:  Event Handler Consume\n
                |||
            end
            note right of SET_WIN_HANDLER #lightgray
                let **id** = message.content.payload.settlementWindowId
                let **windowContentReady** = false
                let **iter** = 0
            end note

            loop iter < Config.WIN_AGGREGATION_RETRY_COUNT && !windowContentReady
                note right of SET_WIN_HANDLER #lightgray
                    iter++
                end note

                SET_WIN_HANDLER -> SETTLE_DAO: Check if all transferParticipant records\nfor the requested window have been set\n(currentStateChangeId is NOT NULL).\n<color #FF0000><b>Error code:</b> 2001</color>
                activate SETTLE_DAO
                SETTLE_DAO -> DB: Use EXISTS query to find NULL currentStateChangeId records
                activate DB
                hnote over DB #lightyellow
                    transferFulfilment
                    transferParticipant
                end hnote
                deactivate DB
                SET_WIN_HANDLER <- - SETTLE_DAO: Return result (success / failure)
                deactivate SETTLE_DAO

                opt transferParticipant records have been processed by central-ledger SettlementModelHandler
                    SET_WIN_HANDLER -> SETTLE_DAO: Generate window content and aggregations\n<color #FF0000><b>Error code:</b> 2001</color>
                    activate SETTLE_DAO
                    group <color #blue>DB TRANSACTION: Generate window content and aggregations</color>
                        note right of SETTLE_DAO #lightgray
                            let **transactionTimestamp** = now()
                        end note

                        SETTLE_DAO -> DB: Change all applicable entries to CLOSED state
                        activate DB
                        hnote over DB #lightyellow
                            transferParticipantStateChange
                            transferParticipant
                        end hnote
                        deactivate DB

                        SETTLE_DAO -> DB: Determine window content and insert
                        activate DB
                        hnote over DB #lightyellow
                            INSERT INTO **settlementWindowContent** (settlementWindowId, ledgerAccountTypeId,
                                currencyId,  createdDate)
                            SELECT DISTINCT {id} settlementWindowId, pc.ledgerAccountTypeId,
                                pc.currencyId, transactionTimestamp
                            FROM **transferFulfilment** tf
                            JOIN **transferParticipant** tp
                            ON tp.transferId = tf.transferId
                            JOIN **participantCurrency** pc
                            ON pc.participantCurrencyId = tp.participantCurrencyId
                            WHERE tf.settlementWindowId = {id}
                        end hnote
                        deactivate DB

                        SETTLE_DAO -> DB: Aggregate window data and insert
                        activate DB
                        hnote over DB #lightyellow
                            INSERT INTO **settlementContentAggregation** (settlementWindowContentId, participantCurrencyId, 
                                transferParticipantRoleTypeId, ledgerEntryTypeId, currentStateId, createdDate, amount)
                            SELECT swc.settlementWindowContentId, pc.participantCurrencyId, tp.transferParticipantRoleTypeId,
                                tp.ledgerEntryTypeId, 'CLOSED', transactionTimestamp, SUM(tp.amount)
                            FROM **transferFulfilment** tf
                            JOIN **transferParticipant** tp
                            ON tf.transferId = tp.transferId
                            JOIN **participantCurrency** pc
                            ON pc.participantCurrencyId = tp.participantCurrencyId
                            JOIN **settlementWindowContent** swc
                            ON swc.settlementWindowId = tf.settlementWindowId
                            AND swc.ledgerAccountTypeId = pc.ledgerAccountTypeId
                            AND swc.currencyId = pc.currencyId
                            WHERE ttf.settlementWindowId = {id}
                            GROUP BY swc.settlementWindowContentId, pc.participantCurrencyId, 
                                tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId
                        end hnote
                        deactivate DB

                        SETTLE_DAO -> DB: Insert initial window content state change
                        activate DB
                        hnote over DB #lightyellow
                            INSERT INTO **settlementWindowContentStateChange**
                                (settlementWindowContentId, settlementWindowStateId)
                            SELECT swc.settlementWindowContentId, 'CLOSED'
                            FROM **settlementWindowContent** swc
                            WHERE swc.settlementWindowId = {id}
                        end hnote
                        deactivate DB

                        SETTLE_DAO -> DB: Update pointers to current state change ids
                        activate DB
                        hnote over DB #lightyellow
                            settlementWindowContent
                        end hnote
                        deactivate DB
                    end
                    SETTLE_DAO - -> SET_WIN_HANDLER: Return result (success / failure)
                    deactivate SETTLE_DAO
                end

                alt success
                    note right of SET_WIN_HANDLER #lightgray
                        windowContentReady = true
                    end note
                    SET_WIN_HANDLER -> SETTLE_DAO: Close requested window\n<color #FF0000><b>Error code:</b> 2001</color>
                    activate SETTLE_DAO
                    SETTLE_DAO -> DB: Change window state to 'CLOSED'
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindowStateChange
                        settlementWindow.currentStateChangeId
                    end hnote
                    deactivate DB
                    deactivate SETTLE_DAO
                else failure && iter < Config.WIN_AGGREGATION_RETRY_COUNT
                    note right of SET_WIN_HANDLER #lightgray
                        **sleep** Config.WIN_AGGREGATION_RETRY_INTERVAL seconds
                    end note
                else failure
                    SET_WIN_HANDLER -> SETTLE_DAO: Fail requested window\n<color #FF0000><b>Error code:</b> 2001</color>
                    activate SETTLE_DAO
                    SETTLE_DAO -> DB: Change window state to 'FAILED'
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindowStateChange
                        settlementWindow.currentStateChangeId
                    end hnote
                    deactivate DB
                    deactivate SETTLE_DAO

                    SET_WIN_HANDLER ->> SET_WIN_HANDLER: Log ERROR event
                end
            end
        end
    else
        SSAPI ->> SSAPI: Log ERROR event
        activate SSAPI
        note left of SSAPI #yellow
            {
                "errorInformation": {
                    "errorCode": <integer>,
                    "errorDescription": "Client error description"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
        deactivate SSAPI
        activate OPERATOR
    end
    deactivate OPERATOR
    deactivate SET_WIN_HANDLER
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.3
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>