<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3114px" preserveAspectRatio="none" style="width:1431px;height:3114px;" version="1.1" viewBox="0 0 1431 3114" width="1431px" zoomAndPan="magnify"><defs><filter height="300%" id="f112zx7dcgk7j0" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="413" x="510" y="23.5352">6.1.2. Close Settlement Window (closeSettlementWindow)</text><rect fill="#FFB6C1" height="3068.7949" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="51" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="66.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="3068.7949" style="stroke: #A80036; stroke-width: 1.0;" width="454.5" x="294.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="459.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="3068.7949" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1005" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1008" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="2837.5078" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="2706.6445" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="278.1504"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="683" y="541.5664"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="1836.8438" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="683" y="808.9824"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="570.877"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="901.9141"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1024.4668"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1147.709"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1254.9512"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1377.5039"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1600.6777"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1800.4727"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="2122.752"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="2307.2363"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="2845.5078" style="stroke: #000000; stroke-width: 2.0;" width="1407" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="162.4844" style="stroke: #000000; stroke-width: 2.0;" width="687" x="45" y="335.4609"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="2237.7441" style="stroke: #000000; stroke-width: 2.0;" width="1387" x="23" y="755.0508"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="655.4531" style="stroke: #000000; stroke-width: 2.0;" width="718" x="621" y="823.9824"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="1116.0801" style="stroke: #000000; stroke-width: 2.0;" width="779" x="621" y="1522.7461"/><rect fill="#FFFFFF" height="186.4844" style="stroke: none; stroke-width: 1.0;" width="1387" x="23" y="2806.3105"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="107" x2="107" y1="137.2871" y2="3016.7949"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="376.5" x2="376.5" y1="137.2871" y2="3016.7949"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="688" x2="688" y1="137.2871" y2="3016.7949"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1062" x2="1062" y1="137.2871" y2="3016.7949"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="55" y="134.334">Hub Employee</text><ellipse cx="107" cy="63.7988" fill="#FEFECE" filter="url(#f112zx7dcgk7j0)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M107,71.7988 L107,98.7988 M94,79.7988 L120,79.7988 M107,98.7988 L94,113.7988 M107,98.7988 L120,113.7988 " fill="none" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="55" y="3029.3301">Hub Employee</text><ellipse cx="107" cy="3042.2832" fill="#FEFECE" filter="url(#f112zx7dcgk7j0)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M107,3050.2832 L107,3077.2832 M94,3058.2832 L120,3058.2832 M107,3077.2832 L94,3092.2832 M107,3077.2832 L120,3092.2832 " fill="none" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="298.5" y="134.334">Settlement Service API</text><path d="M356.5,92.7988 L356.5,116.7988 M356.5,104.7988 L373.5,104.7988 " fill="none" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="385.5" cy="104.7988" fill="#FEFECE" filter="url(#f112zx7dcgk7j0)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="298.5" y="3029.3301">Settlement Service API</text><path d="M356.5,3036.2832 L356.5,3060.2832 M356.5,3048.2832 L373.5,3048.2832 " fill="none" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="385.5" cy="3048.2832" fill="#FEFECE" filter="url(#f112zx7dcgk7j0)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="631" y="134.334">Settlement DAO</text><ellipse cx="688" cy="104.7988" fill="#FEFECE" filter="url(#f112zx7dcgk7j0)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="676" x2="700" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="631" y="3029.3301">Settlement DAO</text><ellipse cx="688" cy="3048.2832" fill="#FEFECE" filter="url(#f112zx7dcgk7j0)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="676" x2="700" y1="3062.2832" y2="3062.2832"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1014" y="134.334">Central Store</text><path d="M1044,84.7988 C1044,74.7988 1062,74.7988 1062,74.7988 C1062,74.7988 1080,74.7988 1080,84.7988 L1080,110.7988 C1080,120.7988 1062,120.7988 1062,120.7988 C1062,120.7988 1044,120.7988 1044,110.7988 L1044,84.7988 " fill="#FEFECE" filter="url(#f112zx7dcgk7j0)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1044,84.7988 C1044,94.7988 1062,94.7988 1062,94.7988 C1062,94.7988 1080,94.7988 1080,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1014" y="3029.3301">Central Store</text><path d="M1044,3042.2832 C1044,3032.2832 1062,3032.2832 1062,3032.2832 C1062,3032.2832 1080,3032.2832 1080,3042.2832 L1080,3068.2832 C1080,3078.2832 1062,3078.2832 1062,3078.2832 C1062,3078.2832 1044,3078.2832 1044,3068.2832 L1044,3042.2832 " fill="#FEFECE" filter="url(#f112zx7dcgk7j0)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1044,3042.2832 C1044,3052.2832 1062,3052.2832 1062,3052.2832 C1062,3052.2832 1080,3052.2832 1080,3042.2832 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="2837.5078" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="2706.6445" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="372" y="278.1504"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="683" y="541.5664"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="1836.8438" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="683" y="808.9824"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="570.877"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="901.9141"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1024.4668"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1147.709"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1254.9512"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1377.5039"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1600.6777"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="1800.4727"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="2122.752"/><rect fill="#FFFFFF" filter="url(#f112zx7dcgk7j0)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1057" y="2307.2363"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2845.5078" style="stroke: #000000; stroke-width: 2.0;" width="1407" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Close Settlement Window</text><path d="M117,176.5977 L117,247.5977 L271,247.5977 L271,186.5977 L261,176.5977 L117,176.5977 " fill="#FFFF00" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M261,176.5977 L261,186.5977 L271,186.5977 L261,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="123" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="139" y="209.4766">"state": "CLOSED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="139" y="224.7871">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="123" y="240.0977">}</text><polygon fill="#A80036" points="360,274.1504,370,278.1504,360,282.1504,364,278.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="112" x2="366" y1="278.1504" y2="278.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="119" y="273.4082">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="132" y="273.4082">POST - /settlementWindows/{id}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="424" y1="307.4609" y2="307.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="424" x2="424" y1="307.4609" y2="320.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383" x2="424" y1="320.4609" y2="320.4609"/><polygon fill="#A80036" points="393,316.4609,383,320.4609,393,324.4609,389,320.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="302.7188">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="402" y="302.7188">Validate payload and requested state</text><path d="M45,335.4609 L129,335.4609 L129,342.4609 L119,352.4609 L45,352.4609 L45,335.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="162.4844" style="stroke: #000000; stroke-width: 2.0;" width="687" x="45" y="335.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="60" y="349.0293">break</text><path d="M387,357.7715 L387,458.7715 L718,458.7715 L718,367.7715 L708,357.7715 L387,357.7715 " fill="#FFFF00" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M708,357.7715 L708,367.7715 L718,367.7715 L708,357.7715 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="375.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="409" y="390.6504">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="425" y="405.9609">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="425" y="421.2715">"errorDescription": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="436.582">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="451.8926">}</text><polygon fill="#A80036" points="123,485.9453,113,489.9453,123,493.9453,119,489.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="117" x2="371" y1="489.9453" y2="489.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="129" y="485.2031">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="142" y="485.2031">Respond HTTP - 400 (Bad Request)</text><polygon fill="#A80036" points="671,537.5664,681,541.5664,671,545.5664,675,541.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="677" y1="541.5664" y2="541.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="529.1689">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="402" y="521.5137">Get requested settlementWindow and state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="536.8242">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="536.8242">2001</text><polygon fill="#A80036" points="1045,566.877,1055,570.877,1045,574.877,1049,570.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1051" y1="570.877" y2="570.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="700" y="566.1348">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="713" y="566.1348">Get settlementWindow state</text><polygon fill="#FFFFE0" filter="url(#f112zx7dcgk7j0)" points="840,613.877,1283,613.877,1293,662.877,1283,712.877,840,712.877,830,662.877,840,613.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="842" y="630.4453">SELECT sw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="870" y="645.7559">swsc.reason, sw.createdDate, swsc.createdDate changedDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="842" y="661.0664">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="882" y="661.0664">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="1011" y="661.0664">AS sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="842" y="676.377">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="874" y="676.377">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="1088" y="676.377">AS swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="842" y="691.6875">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="842" y="706.998">WHERE sw.settlementWindowId = {id}</text><polygon fill="#A80036" points="393,736.0508,383,740.0508,393,744.0508,389,740.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="687" y1="740.0508" y2="740.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="399" y="735.3086">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="412" y="735.3086">Return result</text><path d="M23,755.0508 L85,755.0508 L85,762.0508 L75,772.0508 L23,772.0508 L23,755.0508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2237.7441" style="stroke: #000000; stroke-width: 2.0;" width="1387" x="23" y="755.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="768.6191">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="373" x="100" y="767.6855">[settlementWindow found &amp;&amp; settlementWindowStateId == 'OPEN']</text><polygon fill="#A80036" points="671,804.9824,681,808.9824,671,812.9824,675,808.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382" x2="677" y1="808.9824" y2="808.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="389" y="796.585">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="402" y="788.9297">Close current window and open a new one</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="402" y="804.2402">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="804.2402">2001</text><path d="M621,823.9824 L786,823.9824 L786,830.9824 L776,840.9824 L621,840.9824 L621,823.9824 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="655.4531" style="stroke: #000000; stroke-width: 2.0;" width="718" x="621" y="823.9824"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="636" y="837.5508">DB TRANSACTION</text><path d="M698,846.293 L698,871.293 L943,871.293 L943,856.293 L933,846.293 L698,846.293 " fill="#D3D3D3" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M933,846.293 L933,856.293 L943,856.293 L933,846.293 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="704" y="863.8613">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="724" y="863.8613">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="880" y="863.8613">= now()</text><polygon fill="#A80036" points="1045,897.9141,1055,901.9141,1045,905.9141,1049,901.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1051" y1="901.9141" y2="901.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="700" y="897.1719">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="713" y="897.1719">Close requested window</text><polygon fill="#FFFFE0" filter="url(#f112zx7dcgk7j0)" points="828,914.9141,1296,914.9141,1306,940.9141,1296,967.9141,828,967.9141,818,940.9141,828,914.9141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="830" y="931.4824">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="914" y="931.4824">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="858" y="946.793">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="830" y="962.1035">VALUES ({id}, {payload.state}, {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="704,991.1563,694,995.1563,704,999.1563,700,995.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="698" x2="1061" y1="995.1563" y2="995.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="710" y="990.4141">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="723" y="990.4141">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="223" x="768" y="990.4141">settlementWindowStateChangeId</text><polygon fill="#A80036" points="1045,1020.4668,1055,1024.4668,1045,1028.4668,1049,1024.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1051" y1="1024.4668" y2="1024.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1019.7246">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="722" y="1019.7246">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f112zx7dcgk7j0)" points="863,1067.4668,1260,1067.4668,1270,1093.4668,1260,1120.4668,863,1120.4668,853,1093.4668,863,1067.4668" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="865" y="1084.0352">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="919" y="1084.0352">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="865" y="1099.3457">SET currentStateChangeId = {settlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="865" y="1114.6563">WHERE settlementWindowId = {id}</text><polygon fill="#A80036" points="1045,1143.709,1055,1147.709,1045,1151.709,1049,1147.709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1051" y1="1147.709" y2="1147.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1142.9668">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="722" y="1142.9668">Create new settlementWindow</text><polygon fill="#FFFFE0" filter="url(#f112zx7dcgk7j0)" points="887,1160.709,1237,1160.709,1247,1179.709,1237,1198.709,887,1198.709,877,1179.709,887,1160.709" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="889" y="1177.2773">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="973" y="1177.2773">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1102" y="1177.2773">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="889" y="1192.5879">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="704,1221.6406,694,1225.6406,704,1229.6406,700,1225.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="698" x2="1061" y1="1225.6406" y2="1225.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="710" y="1220.8984">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="732" y="1220.8984">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="777" y="1220.8984">settlementWindowId</text><polygon fill="#A80036" points="1045,1250.9512,1055,1254.9512,1045,1258.9512,1049,1254.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1051" y1="1254.9512" y2="1254.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1250.209">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="722" y="1250.209">Insert intial state for the created window</text><polygon fill="#FFFFE0" filter="url(#f112zx7dcgk7j0)" points="804,1267.9512,1319,1267.9512,1329,1293.9512,1319,1320.9512,804,1320.9512,794,1293.9512,804,1267.9512" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="806" y="1284.5195">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="890" y="1284.5195">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="834" y="1299.8301">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="511" x="806" y="1315.1406">VALUES ({settlementWindowId}, 'OPEN', {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="704,1344.1934,694,1348.1934,704,1352.1934,700,1348.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="698" x2="1061" y1="1348.1934" y2="1348.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="710" y="1343.4512">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="732" y="1343.4512">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="251" x="777" y="1343.4512">newSettlementWindowStateChangeId</text><polygon fill="#A80036" points="1045,1373.5039,1055,1377.5039,1045,1381.5039,1049,1377.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1051" y1="1377.5039" y2="1377.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1372.7617">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="722" y="1372.7617">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f112zx7dcgk7j0)" points="851,1420.5039,1273,1420.5039,1283,1446.5039,1273,1473.5039,851,1473.5039,841,1446.5039,851,1420.5039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="853" y="1437.0723">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="907" y="1437.0723">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="418" x="853" y="1452.3828">SET currentStateChangeId = {newSettlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="853" y="1467.6934">WHERE settlementWindowId = {settlementWindowId}</text><polygon fill="#A80036" points="393,1503.7461,383,1507.7461,393,1511.7461,389,1507.7461" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="387" x2="682" y1="1507.7461" y2="1507.7461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="399" y="1503.0039">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="421" y="1503.0039">Return success</text><path d="M621,1522.7461 L839,1522.7461 L839,1529.7461 L829,1539.7461 L621,1539.7461 L621,1522.7461 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1116.0801" style="stroke: #000000; stroke-width: 2.0;" width="779" x="621" y="1522.7461"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="173" x="636" y="1536.3145">DB TRANSACTION (async)</text><path d="M698,1545.0566 L698,1570.0566 L943,1570.0566 L943,1555.0566 L933,1545.0566 L698,1545.0566 " fill="#D3D3D3" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M933,1545.0566 L933,1555.0566 L943,1555.0566 L933,1545.0566 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="704" y="1562.625">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="724" y="1562.625">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="880" y="1562.625">= now()</text><polygon fill="#A80036" points="1045,1596.6777,1055,1600.6777,1045,1604.6777,1049,1600.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1051" y1="1600.6777" y2="1600.6777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1595.9355">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="722" y="1595.9355">Determine window content and insert</text><polygon fill="#FFFFE0" filter="url(#f112zx7dcgk7j0)" points="751,1643.6777,1372,1643.6777,1382,1708.6777,1372,1773.6777,751,1773.6777,741,1708.6777,751,1643.6777" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="753" y="1660.2461">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="837" y="1660.2461">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="351" x="1019" y="1660.2461">(settlementWindowId, ledgerAccountTypeId, currencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="518" x="753" y="1675.5566">SELECT DISTINCT {id} settlementWindowId, pc.ledgerAccountTypeId, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="753" y="1690.8672">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="793" y="1690.8672">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="919" y="1690.8672">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="753" y="1706.1777">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="785" y="1706.1777">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="916" y="1706.1777">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="753" y="1721.4883">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="753" y="1736.7988">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="785" y="1736.7988">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="925" y="1736.7988">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="753" y="1752.1094">ON pc.participantCurrencyId = tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="753" y="1767.4199">WHERE tf.settlementWindowId = {id}</text><polygon fill="#A80036" points="1045,1796.4727,1055,1800.4727,1045,1804.4727,1049,1800.4727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1051" y1="1800.4727" y2="1800.4727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="1795.7305">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="722" y="1795.7305">Aggregate window data and insert</text><polygon fill="#FFFFE0" filter="url(#f112zx7dcgk7j0)" points="744,1843.4727,1380,1843.4727,1390,1969.4727,1380,2095.4727,744,2095.4727,734,1969.4727,744,1843.4727" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="746" y="1860.041">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="830" y="1860.041">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="1044" y="1860.041">(settlementWindowContentId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="762" y="1875.3516">transferParticipantRoleTypeId, ledgerEntryTypeId, amount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="746" y="1890.6621">SELECT swc.settlementWindowContentId, pc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="762" y="1905.9727">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="746" y="1921.2832">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="786" y="1921.2832">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="912" y="1921.2832">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="746" y="1936.5938">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="778" y="1936.5938">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="909" y="1936.5938">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="746" y="1951.9043">ON tf.transferId = tp.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="746" y="1967.2148">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="778" y="1967.2148">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="918" y="1967.2148">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="746" y="1982.5254">ON pc.participantCurrencyId = tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="746" y="1997.8359">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="778" y="1997.8359">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="960" y="1997.8359">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="746" y="2013.1465">ON swc.settlementWindowId = tf.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="746" y="2028.457">AND swc.ledgerAccountTypeId = pc.ledgerAccountTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="746" y="2043.7676">AND swc.currencyId = pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="746" y="2059.0781">WHERE tf.settlementWindowId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="746" y="2074.3887">GROUP BY swc.settlementWindowContentId, pc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="762" y="2089.6992">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId;</text><polygon fill="#A80036" points="1045,2118.752,1055,2122.752,1045,2126.752,1049,2122.752" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1051" y1="2122.752" y2="2122.752"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="2118.0098">19</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="722" y="2118.0098">Insert initial content aggregation state change</text><polygon fill="#FFFFE0" filter="url(#f112zx7dcgk7j0)" points="834,2165.752,1289,2165.752,1299,2222.752,1289,2280.752,834,2280.752,824,2222.752,834,2165.752" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="836" y="2182.3203">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="295" x="920" y="2182.3203">settlementContentAggregationStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="381" x="852" y="2197.6309">(settlementContentAggregationId, settlementWindowStateId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="836" y="2212.9414">SELECT sca.settlementContentAggregationId, 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="836" y="2228.252">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="876" y="2228.252">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1058" y="2228.252">swc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="836" y="2243.5625">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="868" y="2243.5625">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1082" y="2243.5625">sca</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="451" x="836" y="2258.873">ON sca.settlementWindowContentId = swc.settlementWindowContentId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="836" y="2274.1836">WHERE swc.settlementWindowId = {id}</text><polygon fill="#A80036" points="1045,2303.2363,1055,2307.2363,1045,2311.2363,1049,2307.2363" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="693" x2="1051" y1="2307.2363" y2="2307.2363"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="700" y="2302.4941">20</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="722" y="2302.4941">Update pointers to current state change ids (</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="33" x="1003" y="2302.4941">knex</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1036" y="2302.4941">)</text><polygon fill="#FFFFE0" filter="url(#f112zx7dcgk7j0)" points="770,2350.2363,1354,2350.2363,1364,2491.2363,1354,2633.2363,770,2633.2363,760,2491.2363,770,2350.2363" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="772" y="2366.8047">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="826" y="2366.8047">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="772" y="2382.1152">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="812" y="2382.1152">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1026" y="2382.1152">sca</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="772" y="2397.4258">JOIN (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="788" y="2412.7363">SELECT scacs.settlementContentStateAggregationId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="518" x="804" y="2428.0469">MAX(scacs.settlementContentAggregationStateChangeId) AS currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="788" y="2443.3574">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="295" x="828" y="2443.3574">settlementContentAggregationStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1127" y="2443.3574">scacs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="788" y="2458.668">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="820" y="2458.668">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="29" x="1034" y="2458.668">sca2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="526" x="788" y="2473.9785">ON sca2.settlementContentAggregationId = scacs.settlementContentAggregationId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="788" y="2489.2891">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="820" y="2489.2891">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1002" y="2489.2891">swc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="788" y="2504.5996">ON swc2.settlementWindowContentId = sca2.settlementWindowContentId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="788" y="2519.9102">WHERE swc2.settlementWindowId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="788" y="2535.2207">GROUP BY settlementContentStateAggregationId) scasc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="580" x="772" y="2550.5313">ON scasc.settlementContentStateAggregationId = sca.settlementContentStateAggregationId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="772" y="2565.8418">SET currentStateChangeId = scasc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="772" y="2581.1523">WHERE settlementWindowContentId IN (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="788" y="2596.4629">SELECT settlementWindowContentId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="788" y="2611.7734">FROM settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="788" y="2627.084">WHERE settlementWindowId = {id})</text><path d="M85,2650.8262 L85,2767.8262 L363,2767.8262 L363,2660.8262 L353,2650.8262 L85,2650.8262 " fill="#FFFF00" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,2650.8262 L353,2660.8262 L363,2660.8262 L353,2650.8262 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="91" y="2668.3945">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="107" y="2683.7051">"id": settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="107" y="2699.0156">"state": 'OPEN',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="107" y="2714.3262">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="107" y="2729.6367">"createdDate": transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="107" y="2744.9473">"changedDate": transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="91" y="2760.2578">}</text><polygon fill="#A80036" points="123,2794.3105,113,2798.3105,123,2802.3105,119,2798.3105" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="117" x2="371" y1="2798.3105" y2="2798.3105"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="129" y="2793.5684">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="151" y="2793.5684">Respond HTTP - 201 (Created)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1410" y1="2807.3105" y2="2807.3105"/><path d="M387,2813.3105 L387,2838.3105 L514,2838.3105 L514,2823.3105 L504,2813.3105 L387,2813.3105 " fill="#D3D3D3" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M504,2813.3105 L504,2823.3105 L514,2823.3105 L504,2813.3105 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="393" y="2830.8789">Log ERROR event</text><path d="M33,2852.6211 L33,2953.6211 L363,2953.6211 L363,2862.6211 L353,2852.6211 L33,2852.6211 " fill="#FFFF00" filter="url(#f112zx7dcgk7j0)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353,2852.6211 L353,2862.6211 L363,2862.6211 L353,2852.6211 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="2870.1895">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="55" y="2885.5">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="71" y="2900.8105">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="71" y="2916.1211">"errorDescription": "Client error description"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="55" y="2931.4316">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="2946.7422">}</text><polygon fill="#A80036" points="118,2980.7949,108,2984.7949,118,2988.7949,114,2984.7949" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112" x2="376" y1="2984.7949" y2="2984.7949"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124" y="2980.0527">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="146" y="2980.0527">Respond HTTP - 4xx (Client error)</text><!--
@startuml
title 6.1.2. Close Settlement Window (closeSettlementWindow)

autonumber 

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Close Settlement Window
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "state": "CLOSED",
            "reason": <string>
        }
    end note

    OPERATOR -> SSAPI: POST - /settlementWindows/{id}
    activate SSAPI
    SSAPI -> SSAPI: Validate payload and requested state
    break
        note right of SSAPI #yellow
            {
                "errorInformation": {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid payload or state"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 400 (Bad Request)
    end
    SSAPI -> SETTLE_DAO: Get requested settlementWindow and state\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Get settlementWindow state
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId, 
               swsc.reason, sw.createdDate, swsc.createdDate changedDate
        FROM **settlementWindow** AS sw
        JOIN **settlementWindowStateChange** AS swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId = {id}
    end hnote
    deactivate DB
    SETTLE_DAO - -> SSAPI: Return result
    deactivate SETTLE_DAO

    alt settlementWindow found && settlementWindowStateId == 'OPEN'
        SSAPI -> SETTLE_DAO: Close current window and open a new one\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Close requested window
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({id}, {payload.state}, {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementWindowStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {settlementWindowStateChangeId}
                WHERE settlementWindowId = {id}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Create new settlementWindow
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindow** (reason, createdDate)
                VALUES ({payload.reason}, {transactionTimestamp})
            end note
            SETTLE_DAO <- - DB: Return **settlementWindowId**
            deactivate DB

            SETTLE_DAO -> DB: Insert intial state for the created window
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({settlementWindowId}, 'OPEN', {payload.reason}, {transactionTimestamp})
            end note
            SETTLE_DAO <- - DB: Return **newSettlementWindowStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {newSettlementWindowStateChangeId}
                WHERE settlementWindowId = {settlementWindowId}
            end hnote
            deactivate DB
        end
        SSAPI <- - SETTLE_DAO: Return success
        group <color #red>DB TRANSACTION (async)</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Determine window content and insert
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowContent** (settlementWindowId, ledgerAccountTypeId, currencyId)
                SELECT DISTINCT {id} settlementWindowId, pc.ledgerAccountTypeId, pc.currencyId
                FROM **transferFulfilment** tf
                JOIN **transferParticipant** tp
                ON tp.transferId = tf.transferId
                JOIN **participantCurrency** pc
                ON pc.participantCurrencyId = tp.participantCurrencyId
                WHERE tf.settlementWindowId = {id}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Aggregate window data and insert
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementContentAggregation** (settlementWindowContentId, participantCurrencyId, 
                    transferParticipantRoleTypeId, ledgerEntryTypeId, amount)
                SELECT swc.settlementWindowContentId, pc.participantCurrencyId,
                    tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount)
                FROM **transferFulfilment** tf
                JOIN **transferParticipant** tp
                ON tf.transferId = tp.transferId
                JOIN **participantCurrency** pc
                ON pc.participantCurrencyId = tp.participantCurrencyId
                JOIN **settlementWindowContent** swc
                ON swc.settlementWindowId = tf.settlementWindowId
                AND swc.ledgerAccountTypeId = pc.ledgerAccountTypeId
                AND swc.currencyId = pc.currencyId
                WHERE tf.settlementWindowId = {id}
                GROUP BY swc.settlementWindowContentId, pc.participantCurrencyId, 
                    tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId;
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: <color #red>Insert initial content aggregation state change</color>
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementContentAggregationStateChange**
                    (settlementContentAggregationId, settlementWindowStateId)
                SELECT sca.settlementContentAggregationId, 'CLOSED'
                FROM **settlementWindowContent** swc
                JOIN **settlementContentAggregation** sca
                ON sca.settlementWindowContentId = swc.settlementWindowContentId
                WHERE swc.settlementWindowId = {id}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: <color #red>Update pointers to current state change ids (<b>knex</b>)</color>
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementContentAggregation**
                FROM **settlementContentAggregation** sca
                JOIN (
                    SELECT scacs.settlementContentStateAggregationId, 
                        MAX(scacs.settlementContentAggregationStateChangeId) AS currentStateChangeId
                    FROM **settlementContentAggregationStateChange** scacs
                    JOIN **settlementContentAggregation** sca2
                    ON sca2.settlementContentAggregationId = scacs.settlementContentAggregationId
                    JOIN **settlementWindowContent** swc2
                    ON swc2.settlementWindowContentId = sca2.settlementWindowContentId
                    WHERE swc2.settlementWindowId = {id}
                    GROUP BY settlementContentStateAggregationId) scasc
                ON scasc.settlementContentStateAggregationId = sca.settlementContentStateAggregationId
                SET currentStateChangeId = scasc.currentStateChangeId
                WHERE settlementWindowContentId IN (
                    SELECT settlementWindowContentId
                    FROM settlementWindowContent
                    WHERE settlementWindowId = {id})
            end hnote
            deactivate DB
        end
        deactivate SETTLE_DAO

        note left of SSAPI #yellow
            {
                "id": settlementWindowId,
                "state": 'OPEN',
                "reason": payload.reason,
                "createdDate": transactionTimestamp,
                "changedDate": transactionTimestamp
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)
    else
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                "errorInformation": {
                    "errorCode": <integer>,
                    "errorDescription": "Client error description"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.1
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>