<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="8380px" preserveAspectRatio="none" style="width:1508px;height:8380px;" version="1.1" viewBox="0 0 1508 8380" width="1508px" zoomAndPan="magnify"><defs><filter height="300%" id="f1kegwx30cnlti" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="515" x="497.5" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)</text><rect fill="#FFB6C1" height="8334.7109" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="280" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="295.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="8334.7109" style="stroke: #A80036; stroke-width: 1.0;" width="370.5" x="436.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="559.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="8334.7109" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1187" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1190" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="8126.4238" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="331" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="7734.5918" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="514" y="523.1191"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="6779.2695" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="741" y="567.7402"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="621.3613"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="805.1563"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="5202.2344"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="5367.0977"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="6123.7031"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="6284.5664"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="7141.457"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="7233.3887"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="8111.4238" style="stroke: #000000; stroke-width: 2.0;" width="1484" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="6735.959" style="stroke: #000000; stroke-width: 2.0;" width="838" x="649" y="582.7402"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="767.1152" style="stroke: #000000; stroke-width: 2.0;" width="454" x="679" y="1919.7891"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="382.2148" style="stroke: #000000; stroke-width: 2.0;" width="377" x="746" y="2297.6895"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2354.3105"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2408.5762"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2462.8418"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2517.1074"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2571.373"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="377" x="746" y="2625.6387"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="2180.293" style="stroke: #000000; stroke-width: 2.0;" width="797" x="659" y="2969.3203"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="2021.4297" style="stroke: #000000; stroke-width: 2.0;" width="777" x="669" y="3121.1836"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="1908.498" style="stroke: #000000; stroke-width: 2.0;" width="757" x="679" y="3227.1152"/><rect fill="#FFFFFF" height="188.4395" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="3417.9102"/><rect fill="#FFFFFF" height="249.6816" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="3606.3496"/><rect fill="#FFFFFF" height="341.5449" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="3856.0313"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="4197.5762"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="4212.5313"/><rect fill="#FFFFFF" height="14.9551" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="4227.4863"/><rect fill="#FFFFFF" height="656.4453" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="4242.4414"/><rect fill="#FFFFFF" height="236.7266" style="stroke: none; stroke-width: 1.0;" width="757" x="679" y="4898.8867"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="397.2793" style="stroke: #000000; stroke-width: 2.0;" width="798" x="679" y="5163.6133"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="471.8789" style="stroke: #000000; stroke-width: 2.0;" width="623" x="679" y="5574.8926"/><rect fill="#FFFFFF" height="156.5078" style="stroke: none; stroke-width: 1.0;" width="623" x="679" y="5733.7559"/><rect fill="#FFFFFF" height="156.5078" style="stroke: none; stroke-width: 1.0;" width="623" x="679" y="5890.2637"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="428.5898" style="stroke: #000000; stroke-width: 2.0;" width="729" x="669" y="6060.7715"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="171.1738" style="stroke: #000000; stroke-width: 2.0;" width="709" x="679" y="6085.082"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="808.3379" style="stroke: #000000; stroke-width: 2.0;" width="739" x="669" y="6503.3613"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="467.2324" style="stroke: #000000; stroke-width: 2.0;" width="564" x="746" y="6566.9824"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="746" y="6649.8242"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="746" y="6732.3555"/><rect fill="#FFFFFF" height="95.4863" style="stroke: none; stroke-width: 1.0;" width="564" x="746" y="6814.8867"/><rect fill="#FFFFFF" height="82.5313" style="stroke: none; stroke-width: 1.0;" width="564" x="746" y="6910.373"/><rect fill="#FFFFFF" height="41.3105" style="stroke: none; stroke-width: 1.0;" width="564" x="746" y="6992.9043"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="256.4844" style="stroke: #000000; stroke-width: 2.0;" width="719" x="679" y="7048.2148"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="336" x2="336" y1="137.2871" y2="8282.7109"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="518.5" x2="518.5" y1="137.2871" y2="8282.7109"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="746" x2="746" y1="137.2871" y2="8282.7109"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1244" x2="1244" y1="137.2871" y2="8282.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="284" y="134.334">Hub Employee</text><ellipse cx="336" cy="63.7988" fill="#FEFECE" filter="url(#f1kegwx30cnlti)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M336,71.7988 L336,98.7988 M323,79.7988 L349,79.7988 M336,98.7988 L323,113.7988 M336,98.7988 L349,113.7988 " fill="none" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="284" y="8295.2461">Hub Employee</text><ellipse cx="336" cy="8308.1992" fill="#FEFECE" filter="url(#f1kegwx30cnlti)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M336,8316.1992 L336,8343.1992 M323,8324.1992 L349,8324.1992 M336,8343.1992 L323,8358.1992 M336,8343.1992 L349,8358.1992 " fill="none" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="440.5" y="134.334">Settlement Service API</text><path d="M498.5,92.7988 L498.5,116.7988 M498.5,104.7988 L515.5,104.7988 " fill="none" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="527.5" cy="104.7988" fill="#FEFECE" filter="url(#f1kegwx30cnlti)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="440.5" y="8295.2461">Settlement Service API</text><path d="M498.5,8302.1992 L498.5,8326.1992 M498.5,8314.1992 L515.5,8314.1992 " fill="none" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="527.5" cy="8314.1992" fill="#FEFECE" filter="url(#f1kegwx30cnlti)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="689" y="134.334">Settlement DAO</text><ellipse cx="746" cy="104.7988" fill="#FEFECE" filter="url(#f1kegwx30cnlti)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="734" x2="758" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="689" y="8295.2461">Settlement DAO</text><ellipse cx="746" cy="8314.1992" fill="#FEFECE" filter="url(#f1kegwx30cnlti)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="734" x2="758" y1="8328.1992" y2="8328.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1196" y="134.334">Central Store</text><path d="M1226,84.7988 C1226,74.7988 1244,74.7988 1244,74.7988 C1244,74.7988 1262,74.7988 1262,84.7988 L1262,110.7988 C1262,120.7988 1244,120.7988 1244,120.7988 C1244,120.7988 1226,120.7988 1226,110.7988 L1226,84.7988 " fill="#FEFECE" filter="url(#f1kegwx30cnlti)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1226,84.7988 C1226,94.7988 1244,94.7988 1244,94.7988 C1244,94.7988 1262,94.7988 1262,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1196" y="8295.2461">Central Store</text><path d="M1226,8308.1992 C1226,8298.1992 1244,8298.1992 1244,8298.1992 C1244,8298.1992 1262,8298.1992 1262,8308.1992 L1262,8334.1992 C1262,8344.1992 1244,8344.1992 1244,8344.1992 C1244,8344.1992 1226,8344.1992 1226,8334.1992 L1226,8308.1992 " fill="#FEFECE" filter="url(#f1kegwx30cnlti)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1226,8308.1992 C1226,8318.1992 1244,8318.1992 1244,8318.1992 C1244,8318.1992 1262,8318.1992 1262,8308.1992 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="8126.4238" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="331" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="7734.5918" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="514" y="523.1191"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="6779.2695" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="741" y="567.7402"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="621.3613"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="805.1563"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="5202.2344"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="5367.0977"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="6123.7031"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="6284.5664"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="7141.457"/><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1239" y="7233.3887"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="8111.4238" style="stroke: #000000; stroke-width: 2.0;" width="1484" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M346,176.5977 L346,492.5977 L1053,492.5977 L1053,186.5977 L1043,176.5977 L346,176.5977 " fill="#FFFF00" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1043,176.5977 L1043,186.5977 L1053,186.5977 L1043,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="352" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="368" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="384" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="400" y="240.0977">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="400" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="416" y="270.7188">{ "id": 1, "state": "PENDING_SETTLEMENT", "reason": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="613" x="416" y="286.0293">{ "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": &lt;string&gt;, "externalReference": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="416" y="301.3398">{ "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="622" x="416" y="316.6504">{ "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": &lt;string&gt;, "externalReference": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="416" y="331.9609">{ "id": 5, "state": "SETTLED", "reason": &lt;string&gt; }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="400" y="347.2715">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="384" y="362.582">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="384" y="377.8926">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="400" y="393.2031">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="400" y="408.5137">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="416" y="423.8242">{ "id": 6, "state": "SETTLED", "reason": &lt;string&gt; }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="400" y="439.1348">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="384" y="454.4453">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="368" y="469.7559">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="352" y="485.0664">}</text><polygon fill="#A80036" points="502,519.1191,512,523.1191,502,527.1191,506,523.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="341" x2="508" y1="523.1191" y2="523.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="348" y="518.377">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="361" y="518.377">PUT - /settlement/{id}</text><polygon fill="#A80036" points="729,563.7402,739,567.7402,729,571.7402,733,567.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="524" x2="735" y1="567.7402" y2="567.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="531" y="555.3428">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="544" y="547.6875">updateSettlementById routine</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="544" y="562.998">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="621" y="562.998">2001</text><path d="M649,582.7402 L814,582.7402 L814,589.7402 L804,599.7402 L649,599.7402 L649,582.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="6735.959" style="stroke: #000000; stroke-width: 2.0;" width="838" x="649" y="582.7402"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="664" y="596.3086">DB TRANSACTION</text><polygon fill="#A80036" points="1227,617.3613,1237,621.3613,1227,625.3613,1231,621.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="621.3613" y2="621.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="616.6191">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="771" y="616.6191">Retrieve settlement information</text><polygon fill="#FFFFE0" filter="url(#f1kegwx30cnlti)" points="1057,634.3613,1431,634.3613,1441,691.3613,1431,749.3613,1057,749.3613,1047,691.3613,1057,634.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="1059" y="650.9297">SELECT s.settlementId, ssc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1075" y="666.2402">ssc.reason, ssc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1059" y="681.5508">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1099" y="681.5508">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="1175" y="681.5508">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1059" y="696.8613">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1091" y="696.8613">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1252" y="696.8613">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="1059" y="712.1719">ON ssc.settlementStateChangeId = s.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1059" y="727.4824">WHERE s.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1059" y="742.793">FOR UPDATE</text><polygon fill="#A80036" points="762,771.8457,752,775.8457,762,779.8457,758,775.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1243" y1="775.8457" y2="775.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="768" y="771.1035">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="781" y="771.1035">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="826" y="771.1035">settlementData</text><polygon fill="#A80036" points="1227,801.1563,1237,805.1563,1227,809.1563,1231,805.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="805.1563" y2="805.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="800.4141">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="771" y="800.4141">Retrive settlement accounts information</text><polygon fill="#FFFFE0" filter="url(#f1kegwx30cnlti)" points="1060,818.1563,1428,818.1563,1438,913.1563,1428,1009.1563,1060,1009.1563,1050,913.1563,1060,818.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="1062" y="834.7246">SELECT pc.participantId, spc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1078" y="850.0352">spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="1078" y="865.3457">spcsc.createdDate, spc.netAmount, pc.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="1078" y="880.6563">spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1330" y="880.6563">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1062" y="895.9668">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1102" y="895.9668">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1313" y="895.9668">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1062" y="911.2773">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="1094" y="911.2773">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1390" y="911.2773">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="1062" y="926.5879">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="1062" y="941.8984">spc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1062" y="957.209">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1094" y="957.209">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1234" y="957.209">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1062" y="972.5195">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="1062" y="987.8301">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1062" y="1003.1406">FOR UPDATE</text><polygon fill="#A80036" points="762,1032.1934,752,1036.1934,762,1040.1934,758,1036.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1243" y1="1036.1934" y2="1036.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="768" y="1031.4512">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="781" y="1031.4512">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="826" y="1031.4512">settlementAccountsList</text><path d="M756,1074.1934 L756,1145.1934 L1253,1145.1934 L1253,1084.1934 L1243,1074.1934 L756,1074.1934 " fill="#ADD8E6" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1243,1074.1934 L1243,1084.1934 L1253,1084.1934 L1243,1074.1934 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="405" x="762" y="1091.7617">All objects below are for the purpose of the syncronous request.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="762" y="1107.0723">If at some point, Node process memory limit is reached, we may decide to:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="762" y="1122.3828">A. Limit the amount of transfers per window and windows per settlement or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="762" y="1137.6934">B. Move to asyncronous processing where we don't need these objects</text><path d="M756,1159.4355 L756,1613.4355 L1419,1613.4355 L1419,1169.4355 L1409,1159.4355 L756,1159.4355 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1409,1159.4355 L1409,1169.4355 L1419,1169.4355 L1409,1159.4355 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="762" y="1177.0039">Available raw datasets from DB:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="762" y="1192.3145">settlementData</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="869" y="1192.3145">contains information about settlement and its current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="762" y="1207.625">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="924" y="1207.625">holds information about all accounts and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="766" y="1222.9355"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="762" y="1238.2461">Local variables and objects:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="762" y="1253.5566">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="896" y="1253.5566">: { // (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="1018" y="1253.5566">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1167" y="1253.5566">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="778" y="1268.8672">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="605" x="778" y="1284.1777">psTransfersRecordedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RECORDED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="596" x="778" y="1299.4883">psTransfersReservedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RESERVED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="626" x="778" y="1314.7988">psTransfersCommittedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_COMMITTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="778" y="1330.1094">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="778" y="1345.4199">abortedCount: &lt;integer&gt; // count of accounts in ABORTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="762" y="1360.7305">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="762" y="1376.041">settlementAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="922" y="1376.041">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="762" y="1391.3516">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="840" y="1391.3516">: { // same as previous but accessed by account id (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="1250" y="1391.3516">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1399" y="1391.3516">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="778" y="1406.6621">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="794" y="1421.9727">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="794" y="1437.2832">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="794" y="1452.5938">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="794" y="1467.9043">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="794" y="1483.2148">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="810" y="1498.5254">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="810" y="1513.8359">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="794" y="1529.1465">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="794" y="1544.457">participantId: participantId, // could be used to reconstruct allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="794" y="1559.7676">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="824" y="1559.7676">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="850" y="1559.7676">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="778" y="1575.0781">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="762" y="1590.3887">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="762" y="1605.6992">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="782" y="1605.6992">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="938" y="1605.6992">= now()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="1668.752" y2="1668.752"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="1668.752" y2="1681.752"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="1681.752" y2="1681.752"/><polygon fill="#A80036" points="762,1677.752,752,1681.752,762,1685.752,758,1681.752" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="1664.0098">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="771" y="1664.0098">Declare and initialize variables</text><path d="M756,1694.752 L756,1903.752 L1048,1903.752 L1048,1704.752 L1038,1694.752 L756,1694.752 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1038,1694.752 L1038,1704.752 L1048,1704.752 L1038,1694.752 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="762" y="1712.3203">let settlementAccounts = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="778" y="1727.6309">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="778" y="1742.9414">psTransfersRecordedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="778" y="1758.252">psTransfersReservedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="778" y="1773.5625">psTransfersCommittedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="778" y="1788.873">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="778" y="1804.1836">abortedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="778" y="1819.4941">unknownCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="762" y="1834.8047">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="762" y="1850.1152">let allAccounts = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="762" y="1865.4258">let pid // participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="762" y="1880.7363">let aid // accountId (participantCurrencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="762" y="1896.0469">let state</text><path d="M679,1919.7891 L753,1919.7891 L753,1926.7891 L743,1936.7891 L679,1936.7891 L679,1919.7891 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="767.1152" style="stroke: #000000; stroke-width: 2.0;" width="454" x="679" y="1919.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="694" y="1933.3574">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="768" y="1932.4238">[settlementAccountsList as account]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="1958.4102" y2="1958.4102"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="1958.4102" y2="1971.4102"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="1971.4102" y2="1971.4102"/><polygon fill="#A80036" points="762,1967.4102,752,1971.4102,762,1975.4102,758,1971.4102" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="1953.668">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="771" y="1953.668">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="829" y="1953.668">allAccounts</text><path d="M756,1984.4102 L756,2238.4102 L1004,2238.4102 L1004,1994.4102 L994,1984.4102 L756,1984.4102 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M994,1984.4102 L994,1994.4102 L1004,1994.4102 L994,1984.4102 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="2001.9785">pid = account.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="762" y="2017.2891">aid = account.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="762" y="2032.5996">state = account.settlementStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="766" y="2047.9102"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="762" y="2063.2207">allAccounts[aid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="778" y="2078.5313">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="778" y="2093.8418">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="778" y="2109.1523">reason: account.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="778" y="2124.4629">createDate: account.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="778" y="2139.7734">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="794" y="2155.084">amount: account.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="794" y="2170.3945">currency: account.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="778" y="2185.7051">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="778" y="2201.0156">participantId: pid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="778" y="2216.3262">key: account.key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="762" y="2231.6367">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="2269.6895" y2="2269.6895"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="2269.6895" y2="2282.6895"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="2282.6895" y2="2282.6895"/><polygon fill="#A80036" points="762,2278.6895,752,2282.6895,762,2286.6895,758,2282.6895" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="758" y="2264.9473">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="771" y="2264.9473">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="829" y="2264.9473">settlementAccounts</text><path d="M746,2297.6895 L808,2297.6895 L808,2304.6895 L798,2314.6895 L746,2314.6895 L746,2297.6895 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="382.2148" style="stroke: #000000; stroke-width: 2.0;" width="377" x="746" y="2297.6895"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="761" y="2311.2578">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="823" y="2310.3242">[state == 'PENDING_SETTLEMENT']</text><path d="M756,2320 L756,2345 L1083,2345 L1083,2330 L1073,2320 L756,2320 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1073,2320 L1073,2330 L1083,2330 L1073,2320 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="762" y="2337.5684">settlementAccounts.pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2355.3105" y2="2355.3105"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="751" y="2365.9453">[state == 'PS_TRANSFERS_RECORDED']</text><path d="M756,2374.2656 L756,2399.2656 L1097,2399.2656 L1097,2384.2656 L1087,2374.2656 L756,2374.2656 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1087,2374.2656 L1087,2384.2656 L1097,2384.2656 L1087,2374.2656 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="762" y="2391.834">settlementAccounts.psTransfersRecordedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2409.5762" y2="2409.5762"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="216" x="751" y="2420.2109">[state == 'PS_TRANSFERS_RESERVED']</text><path d="M756,2428.5313 L756,2453.5313 L1095,2453.5313 L1095,2438.5313 L1085,2428.5313 L756,2428.5313 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1085,2428.5313 L1085,2438.5313 L1095,2438.5313 L1085,2428.5313 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="762" y="2446.0996">settlementAccounts.psTransfersReservedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2463.8418" y2="2463.8418"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="751" y="2474.4766">[state == 'PS_TRANSFERS_COMMITTED']</text><path d="M756,2482.7969 L756,2507.7969 L1109,2507.7969 L1109,2492.7969 L1099,2482.7969 L756,2482.7969 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1099,2482.7969 L1099,2492.7969 L1109,2492.7969 L1099,2482.7969 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="762" y="2500.3652">settlementAccounts.psTransfersCommittedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2518.1074" y2="2518.1074"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="751" y="2528.7422">[state == 'SETTLED']</text><path d="M756,2537.0625 L756,2562.0625 L1008,2562.0625 L1008,2547.0625 L998,2537.0625 L756,2537.0625 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M998,2537.0625 L998,2547.0625 L1008,2547.0625 L998,2537.0625 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="762" y="2554.6309">settlementAccounts.settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2572.373" y2="2572.373"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="751" y="2583.0078">[state == 'ABORTED']</text><path d="M756,2591.3281 L756,2616.3281 L1013,2616.3281 L1013,2601.3281 L1003,2591.3281 L756,2591.3281 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1003,2591.3281 L1003,2601.3281 L1013,2601.3281 L1003,2591.3281 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="762" y="2608.8965">settlementAccounts.abortedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1123" y1="2626.6387" y2="2626.6387"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="751" y="2637.2734">[default]</text><path d="M756,2645.5938 L756,2670.5938 L1023,2670.5938 L1023,2655.5938 L1013,2645.5938 L756,2645.5938 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1013,2645.5938 L1013,2655.5938 L1023,2655.5938 L1013,2645.5938 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="762" y="2663.1621">settlementAccounts.unknownCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="2715.2148" y2="2715.2148"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="2715.2148" y2="2728.2148"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="2728.2148" y2="2728.2148"/><polygon fill="#A80036" points="762,2724.2148,752,2728.2148,762,2732.2148,758,2728.2148" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="2710.4727">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="780" y="2710.4727">Make a copy of settlementAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="1038" y="2710.4727">settlementAccountsInit</text><path d="M756,2741.2148 L756,2766.2148 L1178,2766.2148 L1178,2751.2148 L1168,2741.2148 L756,2741.2148 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1168,2741.2148 L1168,2751.2148 L1178,2751.2148 L1168,2741.2148 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="401" x="762" y="2758.7832">settlementAccountsInit = Object.assign({}, settlementAccounts)</text><path d="M756,2805.5254 L756,2952.5254 L1450,2952.5254 L1450,2815.5254 L1440,2805.5254 L756,2805.5254 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1440,2805.5254 L1440,2815.5254 L1450,2815.5254 L1440,2805.5254 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="762" y="2823.0938">Available objects after the setup:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="762" y="2838.4043">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="900" y="2838.4043">is used for tracing settlement state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="762" y="2853.7148">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="474" x="844" y="2853.7148">is helper object, same as previous, providing direct access to account by id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="766" y="2869.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="762" y="2884.3359">Now we are ready to process the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="970" y="2884.3359">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1024" y="2884.3359">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="762" y="2899.6465">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="588" x="847" y="2899.6465">= [] // part of the response object that lists the affected participants and respective accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="762" y="2914.957">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="1058" y="2914.957">= [] // array to collect inserts to the table</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="277" x="762" y="2930.2676">settlementParticipantCurrencySettledList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="1043" y="2930.2676">= [] // array to collect settled accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="762" y="2945.5781">processedAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="897" y="2945.5781">= [] // array to log processed accounts and restrict subsequent processing</text><path d="M659,2969.3203 L733,2969.3203 L733,2976.3203 L723,2986.3203 L659,2986.3203 L659,2969.3203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2180.293" style="stroke: #000000; stroke-width: 2.0;" width="797" x="659" y="2969.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="674" y="2982.8887">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="748" y="2981.9551">[let participant IN payload.participants]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3007.9414" y2="3007.9414"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3007.9414" y2="3020.9414"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3020.9414" y2="3020.9414"/><polygon fill="#A80036" points="762,3016.9414,752,3020.9414,762,3024.9414,758,3020.9414" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3003.1992">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="780" y="3003.1992">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="923" y="3003.1992">participantPayload</text><path d="M756,3033.9414 L756,3104.9414 L1136,3104.9414 L1136,3043.9414 L1126,3033.9414 L756,3033.9414 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1126,3033.9414 L1126,3043.9414 L1136,3043.9414 L1126,3033.9414 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="762" y="3051.5098">let participantPayload = payload.participants[participant]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="762" y="3066.8203">participants.push({id: participantPayload.id, accounts: []})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="762" y="3082.1309">let pi = participants.length - 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="762" y="3097.4414">participant = participants[pi]</text><path d="M669,3121.1836 L743,3121.1836 L743,3128.1836 L733,3138.1836 L669,3138.1836 L669,3121.1836 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2021.4297" style="stroke: #000000; stroke-width: 2.0;" width="777" x="669" y="3121.1836"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="684" y="3134.752">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="758" y="3133.8184">[let account IN participantPayload.accounts]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3159.8047" y2="3159.8047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3159.8047" y2="3172.8047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3172.8047" y2="3172.8047"/><polygon fill="#A80036" points="762,3168.8047,752,3172.8047,762,3176.8047,758,3172.8047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3155.0625">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="780" y="3155.0625">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="923" y="3155.0625">accountPayload</text><path d="M756,3185.8047 L756,3210.8047 L1148,3210.8047 L1148,3195.8047 L1138,3185.8047 L756,3185.8047 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1138,3185.8047 L1138,3195.8047 L1148,3195.8047 L1138,3185.8047 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="762" y="3203.373">let accountPayload = participantPayload.accounts[account]</text><path d="M679,3227.1152 L741,3227.1152 L741,3234.1152 L731,3244.1152 L679,3244.1152 L679,3227.1152 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1908.498" style="stroke: #000000; stroke-width: 2.0;" width="757" x="679" y="3227.1152"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="694" y="3240.6836">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="756" y="3239.75">[allAccounts[accountPayload.id] == undefined]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3265.7363" y2="3265.7363"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3265.7363" y2="3278.7363"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3278.7363" y2="3278.7363"/><polygon fill="#A80036" points="762,3274.7363,752,3278.7363,762,3282.7363,758,3278.7363" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3260.9941">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="780" y="3260.9941">If the account doesn't match the settlement</text><path d="M756,3291.7363 L756,3408.7363 L1044,3408.7363 L1044,3301.7363 L1034,3291.7363 L756,3291.7363 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1034,3291.7363 L1034,3301.7363 L1044,3301.7363 L1034,3291.7363 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="3309.3047">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="3324.6152">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="778" y="3339.9258">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="794" y="3355.2363">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="794" y="3370.5469">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="778" y="3385.8574">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="3401.168">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="3418.9102" y2="3418.9102"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="392" x="684" y="3429.5449">[participantPayload.id != allAccounts[accountPayload.id].participantId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3454.1758" y2="3454.1758"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3454.1758" y2="3467.1758"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3467.1758" y2="3467.1758"/><polygon fill="#A80036" points="762,3463.1758,752,3467.1758,762,3471.1758,758,3467.1758" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3449.4336">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="780" y="3449.4336">If the account doesn't match the participant</text><path d="M756,3480.1758 L756,3597.1758 L1140,3597.1758 L1140,3490.1758 L1130,3480.1758 L756,3480.1758 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1130,3480.1758 L1130,3490.1758 L1140,3490.1758 L1130,3480.1758 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="3497.7441">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="3513.0547">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="778" y="3528.3652">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="794" y="3543.6758">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="794" y="3558.9863">errorDescription: 'Participant and account mismatch'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="778" y="3574.2969">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="3589.6074">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="3607.3496" y2="3607.3496"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="684" y="3617.9844">[processedAccounts.indexOf(accountPayload.id) &gt; -1]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3642.6152" y2="3642.6152"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3642.6152" y2="3655.6152"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3655.6152" y2="3655.6152"/><polygon fill="#A80036" points="762,3651.6152,752,3655.6152,762,3659.6152,758,3655.6152" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3637.873">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="780" y="3637.873">If the account has been previosly processed (duplicated in the payload)</text><path d="M756,3668.6152 L756,3846.6152 L1275,3846.6152 L1275,3678.6152 L1265,3668.6152 L756,3668.6152 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1265,3668.6152 L1265,3678.6152 L1275,3678.6152 L1265,3668.6152 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="3686.1836">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="3701.4941">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="778" y="3716.8047">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="778" y="3732.1152">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="778" y="3747.4258">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="778" y="3762.7363">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="778" y="3778.0469">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="794" y="3793.3574">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="794" y="3808.668">errorDescription: 'Account already processed once'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="778" y="3823.9785">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="3839.2891">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="3857.0313" y2="3857.0313"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="371" x="684" y="3867.666">[allAccounts[account.id].state == accountPayload.state // allowed]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="3892.2969" y2="3892.2969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="3892.2969" y2="3905.2969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="3905.2969" y2="3905.2969"/><polygon fill="#A80036" points="762,3901.2969,752,3905.2969,762,3909.2969,758,3905.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="3887.5547">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="780" y="3887.5547">Same-state reason amendment is always allowed</text><path d="M756,3918.2969 L756,4188.2969 L1275,4188.2969 L1275,3928.2969 L1265,3918.2969 L756,3918.2969 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1265,3918.2969 L1265,3928.2969 L1275,3928.2969 L1265,3918.2969 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="762" y="3935.8652">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="3951.1758">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="3966.4863">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="778" y="3981.7969">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="778" y="3997.1074">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="778" y="4012.418">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="778" y="4027.7285">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="778" y="4043.0391">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="4058.3496">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="762" y="4073.6602">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="778" y="4088.9707">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="778" y="4104.2813">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="778" y="4119.5918">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="778" y="4134.9023">externalReference: accountPayload.externalReference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="4150.2129">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="762" y="4165.5234">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="762" y="4180.834">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="4198.5762" y2="4198.5762"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="610" x="684" y="4209.2109">[settlementData.state == 'PENDING_SETTLEMENT' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_RECORDED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="4213.5313" y2="4213.5313"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="628" x="684" y="4224.166">[settlementData.state == 'PS_TRANSFERS_RECORDED' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_RESERVED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="4228.4863" y2="4228.4863"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="636" x="684" y="4239.1211">[settlementData.state == 'PS_TRANSFERS_RESERVED' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_COMMITTED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="4243.4414" y2="4243.4414"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="752" x="684" y="4254.0762">[settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING' &amp;&amp; accountPayload.state == 'SETTLED']</text><path d="M756,4262.3965 L756,4302.3965 L1257,4302.3965 L1257,4272.3965 L1247,4262.3965 L756,4262.3965 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1247,4262.3965 L1247,4272.3965 L1257,4272.3965 L1247,4262.3965 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="31" x="762" y="4279.9648">Note</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="793" y="4279.9648">: Since we previously checked same-state, here we don't need to match</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="762" y="4295.2754">allAccounts[account.id].state == settlementData.state.</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="4333.3281" y2="4333.3281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="4333.3281" y2="4346.3281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="4346.3281" y2="4346.3281"/><polygon fill="#A80036" points="762,4342.3281,752,4346.3281,762,4350.3281,758,4346.3281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="4328.5859">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="780" y="4328.5859">Settlement acknowledgement</text><path d="M756,4359.3281 L756,4889.3281 L1326,4889.3281 L1326,4369.3281 L1316,4359.3281 L756,4359.3281 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1316,4359.3281 L1316,4369.3281 L1326,4369.3281 L1316,4359.3281 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="762" y="4376.8965">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="4392.207">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="4407.5176">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="778" y="4422.8281">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="778" y="4438.1387">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="778" y="4453.4492">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="778" y="4468.7598">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="778" y="4484.0703">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="4499.3809">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="762" y="4514.6914">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="778" y="4530.002">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="778" y="4545.3125">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="778" y="4560.623">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="778" y="4575.9336">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="778" y="4591.2441"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="421" x="778" y="4591.2441">settlementTransferId: Uuid() -- only for PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="4606.5547">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="762" y="4621.8652">if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="778" y="4637.1758">settlementAccounts.pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="778" y="4652.4863">settlementAccounts.psTransfersRecordedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="762" y="4667.7969">} else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="778" y="4683.1074">settlementAccounts.psTransfersRecordedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="778" y="4698.418">settlementAccounts.psTransfersReservedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410" x="762" y="4713.7285">} else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="778" y="4729.0391">settlementAccounts.psTransfersReservedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="778" y="4744.3496">settlementAccounts.psTransfersCommittedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="762" y="4759.6602">} else if (accountPayload.state == 'SETTLED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="533" x="778" y="4774.9707">settlementParticipantCurrencySettledIdList.push(allAccounts[accountPayload.id].key)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="778" y="4790.2813">settlementAccounts.psTransfersCommittedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="778" y="4805.5918">settlementAccounts.settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="762" y="4820.9023">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="762" y="4836.2129">allAccounts[accountPayload.id].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="762" y="4851.5234">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="544" x="762" y="4866.834">allAccounts[accountPayload.id].externalReference = accountPayload.externalReference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="762" y="4882.1445">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1436" y1="4899.8867" y2="4899.8867"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="4922.1973" y2="4922.1973"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="4922.1973" y2="4935.1973"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="4935.1973" y2="4935.1973"/><polygon fill="#A80036" points="762,4931.1973,752,4935.1973,762,4939.1973,758,4935.1973" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="4917.4551">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="780" y="4917.4551">All other state transitions are not permitted</text><path d="M756,4948.1973 L756,5126.1973 L1275,5126.1973 L1275,4958.1973 L1265,4948.1973 L756,4948.1973 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1265,4948.1973 L1265,4958.1973 L1275,4958.1973 L1265,4948.1973 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="762" y="4965.7656">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="778" y="4981.0762">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="778" y="4996.3867">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="778" y="5011.6973">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="778" y="5027.0078">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="778" y="5042.3184">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="778" y="5057.6289">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="794" y="5072.9395">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="794" y="5088.25">errorDescription: 'State change not allowed'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="778" y="5103.5605">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="762" y="5118.8711">})</text><path d="M679,5163.6133 L1092,5163.6133 L1092,5170.6133 L1082,5180.6133 L679,5180.6133 L679,5163.6133 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="397.2793" style="stroke: #000000; stroke-width: 2.0;" width="798" x="679" y="5163.6133"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="368" x="694" y="5177.1816">Bulk insert settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="1227,5198.2344,1237,5202.2344,1227,5206.2344,1231,5202.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="5202.2344" y2="5202.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="5197.4922">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="780" y="5197.4922">Insert settlementParticipantCurrencyStateChange</text><polygon fill="#FFFFE0" filter="url(#f1kegwx30cnlti)" points="1108,5215.2344,1380,5215.2344,1390,5226.2344,1380,5238.2344,1108,5238.2344,1098,5226.2344,1108,5215.2344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="1110" y="5231.8027">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="762,5260.8555,752,5264.8555,762,5268.8555,758,5264.8555" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1243" y1="5264.8555" y2="5264.8555"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="768" y="5260.1133">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="790" y="5260.1133">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="835" y="5260.1133">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="5324.7871" y2="5324.7871"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="5324.7871" y2="5337.7871"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="5337.7871" y2="5337.7871"/><polygon fill="#A80036" points="762,5333.7871,752,5337.7871,762,5341.7871,758,5337.7871" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="5304.7344">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="780" y="5289.4238">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="780" y="5304.7344">to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="797" y="5304.7344">settlementParticipantCurrencyIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="1045" y="5304.7344">in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="780" y="5320.0449">issue the following update in one knex command</text><polygon fill="#A80036" points="1227,5363.0977,1237,5367.0977,1227,5371.0977,1231,5367.0977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="5367.0977" y2="5367.0977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="5362.3555">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="780" y="5362.3555">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1kegwx30cnlti)" points="1031,5410.0977,1457,5410.0977,1467,5482.0977,1457,5555.0977,1031,5555.0977,1021,5482.0977,1031,5410.0977" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1033" y="5426.666">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1087" y="5426.666">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1033" y="5441.9766">SET currentStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1049" y="5457.2871">{settlementParticipantCurrencyStateChangeIdList},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1049" y="5472.5977"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1049" y="5472.5977">settlementTransferId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1049" y="5487.9082"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="1049" y="5487.9082">settlementParticipantCurrencyStateChange.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1049" y="5503.2188"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="1049" y="5503.2188">-- only for PENDING_SETTLEMENT to PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1033" y="5518.5293">WHERE settlementParticipantCurrencyId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="1065" y="5533.8398">{settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="1065" y="5549.1504">.settlementParticipantCurrencyIdList}</text><path d="M679,5574.8926 L741,5574.8926 L741,5581.8926 L731,5591.8926 L679,5591.8926 L679,5574.8926 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="471.8789" style="stroke: #000000; stroke-width: 2.0;" width="623" x="679" y="5574.8926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="694" y="5588.4609">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="284" x="756" y="5587.5273">[settlementData.state == 'PENDING_SETTLEMENT']</text><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="686" y="5617.2031"/><polygon fill="#EEEEEE" points="686,5617.2031,750,5617.2031,750,5624.2031,740,5634.2031,686,5634.2031,686,5617.2031" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="699" y="5631.7715">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="813" y="5650.7715">Settlement Transfer Prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="5666.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="813" y="5681.3926">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="856" y="5681.3926">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="5696.7031"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1302" y1="5734.7559" y2="5734.7559"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="307" x="684" y="5745.3906">[settlementData.state == 'PS_TRANSFERS_RECORDED']</text><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="686" y="5773.7109"/><polygon fill="#EEEEEE" points="686,5773.7109,750,5773.7109,750,5780.7109,740,5790.7109,686,5790.7109,686,5773.7109" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="699" y="5788.2793">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="813" y="5807.2793">Settlement Transfer Reserve</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="5822.5898"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="813" y="5837.9004">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="856" y="5837.9004">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="5853.2109"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="679" x2="1302" y1="5891.2637" y2="5891.2637"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="302" x="684" y="5901.8984">[settlementData.state == 'PS_TRANSFERS_RESERVED']</text><rect fill="#FFFFFF" filter="url(#f1kegwx30cnlti)" height="86.5527" style="stroke: #000000; stroke-width: 2.0;" width="605" x="686" y="5930.2188"/><polygon fill="#EEEEEE" points="686,5930.2188,750,5930.2188,750,5937.2188,740,5947.2188,686,5947.2188,686,5930.2188" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="699" y="5944.7871">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="813" y="5963.7871">Settlement Transfer Commit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="5979.0977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="813" y="5994.4082">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="856" y="5994.4082">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="817" y="6009.7188"/><path d="M669,6060.7715 L999,6060.7715 L999,6067.7715 L989,6077.7715 L669,6077.7715 L669,6060.7715 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="428.5898" style="stroke: #000000; stroke-width: 2.0;" width="729" x="669" y="6060.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="684" y="6074.3398">Update aggregations, contents &amp; windows</text><path d="M679,6085.082 L746,6085.082 L746,6092.082 L736,6102.082 L679,6102.082 L679,6085.082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="171.1738" style="stroke: #000000; stroke-width: 2.0;" width="709" x="679" y="6085.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="694" y="6098.6504">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="306" x="761" y="6097.7168">[settlementParticipantCurrencySettledIdList.length &gt; 0]</text><polygon fill="#A80036" points="1227,6119.7031,1237,6123.7031,1227,6127.7031,1231,6123.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="6123.7031" y2="6123.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="6118.9609">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="780" y="6118.9609">Change settlementWindowState where applicable</text><polygon fill="#FFFFE0" filter="url(#f1kegwx30cnlti)" points="1120,6166.7031,1368,6166.7031,1378,6208.7031,1368,6250.7031,1120,6250.7031,1110,6208.7031,1120,6166.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1122" y="6183.2715">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1122" y="6198.582">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1122" y="6213.8926">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1122" y="6229.2031">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1122" y="6244.5137">settlementWindow</text><polygon fill="#A80036" points="1227,6280.5664,1237,6284.5664,1227,6288.5664,1231,6284.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="6284.5664" y2="6284.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="6279.8242">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="780" y="6279.8242">Retrieve all affected content (incl. when settled)</text><polygon fill="#FFFFE0" filter="url(#f1kegwx30cnlti)" points="1120,6297.5664,1368,6297.5664,1378,6354.5664,1368,6412.5664,1120,6412.5664,1110,6354.5664,1120,6297.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1122" y="6314.1348">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1122" y="6329.4453">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1122" y="6344.7559">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="1122" y="6360.0664">ledgerAccountType</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="1122" y="6375.377">currency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1122" y="6390.6875">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1122" y="6405.998">settlementWindowStateChange</text><polygon fill="#A80036" points="762,6435.0508,752,6439.0508,762,6443.0508,758,6439.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1243" y1="6439.0508" y2="6439.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="768" y="6434.3086">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="790" y="6434.3086">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="160" x="835" y="6434.3086">affectedWindowsReport</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="793" y1="6468.3613" y2="6468.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="793" y1="6468.3613" y2="6481.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="752" x2="793" y1="6481.3613" y2="6481.3613"/><polygon fill="#A80036" points="762,6477.3613,752,6481.3613,762,6485.3613,758,6481.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="6463.6191">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="780" y="6463.6191">Use previous result to produce settlementWindowsData (</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="1137" y="6463.6191">swd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="1164" y="6463.6191">) array</text><path d="M669,6503.3613 L1001,6503.3613 L1001,6510.3613 L991,6520.3613 L669,6520.3613 L669,6503.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="808.3379" style="stroke: #000000; stroke-width: 2.0;" width="739" x="669" y="6503.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="287" x="684" y="6516.9297">Prepare and insert settlementStateChange</text><path d="M756,6525.6719 L756,6550.6719 L993,6550.6719 L993,6535.6719 L983,6525.6719 L756,6525.6719 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M983,6525.6719 L983,6535.6719 L993,6535.6719 L983,6525.6719 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="762" y="6543.2402">let settlementStateChanged = true</text><path d="M746,6566.9824 L808,6566.9824 L808,6573.9824 L798,6583.9824 L746,6583.9824 L746,6566.9824 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="467.2324" style="stroke: #000000; stroke-width: 2.0;" width="564" x="746" y="6566.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="761" y="6580.5508">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="280" x="823" y="6579.6172">[settlementData.state == 'PENDING_SETTLEMENT'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="305" x="823" y="6592.5723">&amp;&amp; settlementAccounts.pendingSettlementCount == 0]</text><path d="M756,6600.2031 L756,6640.2031 L1287,6640.2031 L1287,6610.2031 L1277,6600.2031 L756,6600.2031 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1277,6600.2031 L1277,6610.2031 L1287,6610.2031 L1277,6600.2031 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="762" y="6617.7715">settlementData.state = 'PS_TRANSFERS_RECORDED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="510" x="762" y="6633.082">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RECORDED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1310" y1="6650.8242" y2="6650.8242"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="303" x="751" y="6661.459">[settlementData.state == 'PS_TRANSFERS_RECORDED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="321" x="751" y="6674.4141">&amp;&amp; settlementAccounts.psTransfersRecordedCount == 0]</text><path d="M756,6682.7344 L756,6722.7344 L1280,6722.7344 L1280,6692.7344 L1270,6682.7344 L756,6682.7344 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1270,6682.7344 L1270,6692.7344 L1280,6692.7344 L1270,6682.7344 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="762" y="6700.3027">settlementData.state = 'PS_TRANSFERS_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="503" x="762" y="6715.6133">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RESERVED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1310" y1="6733.3555" y2="6733.3555"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="298" x="751" y="6743.9902">[settlementData.state == 'PS_TRANSFERS_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="751" y="6756.9453">&amp;&amp; settlementAccounts.psTransfersReservedCount == 0]</text><path d="M756,6765.2656 L756,6805.2656 L1296,6805.2656 L1296,6775.2656 L1286,6765.2656 L756,6765.2656 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1286,6765.2656 L1286,6775.2656 L1296,6775.2656 L1286,6765.2656 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="762" y="6782.834">settlementData.state = 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="519" x="762" y="6798.1445">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_COMMITTED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1310" y1="6815.8867" y2="6815.8867"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="311" x="751" y="6826.5215">[settlementData.state == 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="318" x="751" y="6839.4766">&amp;&amp; settlementAccounts.psTransfersCommittedCount &gt; 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="751" y="6852.4316">&amp;&amp; settlementAccounts.settledCount &gt; 0]</text><path d="M756,6860.752 L756,6900.752 L1190,6900.752 L1190,6870.752 L1180,6860.752 L756,6860.752 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1180,6860.752 L1180,6870.752 L1190,6870.752 L1180,6860.752 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="762" y="6878.3203">settlementData.state = 'SETTLING'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413" x="762" y="6893.6309">settlementData.reason = 'Some settlement accounts are SETTLED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1310" y1="6911.373" y2="6911.373"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="534" x="751" y="6922.0078">[(settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING')</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="751" y="6934.9629">&amp;&amp; settlementAccounts.psTransfersCommittedCount == 0]</text><path d="M756,6943.2832 L756,6983.2832 L1173,6983.2832 L1173,6953.2832 L1163,6943.2832 L756,6943.2832 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1163,6943.2832 L1163,6953.2832 L1173,6953.2832 L1163,6943.2832 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="762" y="6960.8516">settlementData.state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="762" y="6976.1621">settlementData.reason = 'All settlement accounts are SETTLED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="1310" y1="6993.9043" y2="6993.9043"/><path d="M756,6999.9043 L756,7024.9043 L978,7024.9043 L978,7009.9043 L968,6999.9043 L756,6999.9043 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M968,6999.9043 L968,7009.9043 L978,7009.9043 L968,6999.9043 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="762" y="7017.4727">settlementStateChanged = false</text><path d="M679,7048.2148 L746,7048.2148 L746,7055.2148 L736,7065.2148 L679,7065.2148 L679,7048.2148 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="256.4844" style="stroke: #000000; stroke-width: 2.0;" width="719" x="679" y="7048.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="694" y="7061.7832">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="188" x="761" y="7060.8496">[settlementStateChanged == true]</text><path d="M756,7070.5254 L756,7110.5254 L1085,7110.5254 L1085,7080.5254 L1075,7070.5254 L756,7070.5254 " fill="#D3D3D3" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1075,7070.5254 L1075,7080.5254 L1085,7080.5254 L1075,7070.5254 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="762" y="7088.0938">settlementData.createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="762" y="7103.4043">settlementStateChange.push(settlementData)</text><polygon fill="#A80036" points="1227,7137.457,1237,7141.457,1227,7145.457,1231,7141.457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="7141.457" y2="7141.457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="7136.7148">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="780" y="7136.7148">Insert settlementStateChange</text><polygon fill="#FFFFE0" filter="url(#f1kegwx30cnlti)" points="1169,7154.457,1318,7154.457,1328,7165.457,1318,7177.457,1169,7177.457,1159,7165.457,1169,7154.457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1171" y="7171.0254">settlementStateChange</text><polygon fill="#A80036" points="762,7200.0781,752,7204.0781,762,7208.0781,758,7204.0781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="756" x2="1243" y1="7204.0781" y2="7204.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="768" y="7199.3359">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="790" y="7199.3359">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="835" y="7199.3359">settlementStateChangeId</text><polygon fill="#A80036" points="1227,7229.3887,1237,7233.3887,1227,7237.3887,1231,7233.3887" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="751" x2="1233" y1="7233.3887" y2="7233.3887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="758" y="7228.6465">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="780" y="7228.6465">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f1kegwx30cnlti)" points="1109,7276.3887,1378,7276.3887,1388,7287.3887,1378,7299.3887,1109,7299.3887,1099,7287.3887,1109,7276.3887" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1111" y="7292.957">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1165" y="7292.957">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1237" y="7292.957">.currentStateChangeId</text><polygon fill="#A80036" points="535,7343.0098,525,7347.0098,535,7351.0098,531,7347.0098" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="529" x2="745" y1="7347.0098" y2="7347.0098"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="541" y="7342.2676">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="563" y="7342.2676">Return transaction result</text><path d="M23,7360.0098 L23,8227.0098 L505,8227.0098 L505,7370.0098 L495,7360.0098 L23,7360.0098 " fill="#FFFF00" filter="url(#f1kegwx30cnlti)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M495,7360.0098 L495,7370.0098 L505,7370.0098 L495,7360.0098 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="7377.5781">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="45" y="7392.8887">"id": {id},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="45" y="7408.1992">"state": settlementData.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="45" y="7423.5098">"createdDate": settlementData.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="45" y="7438.8203">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="7454.1309">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="77" y="7469.4414">"id": swd[m].id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="77" y="7484.752">"state": swd[m].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="77" y="7500.0625">"reason": swd[m].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="77" y="7515.373">"createdDate": swd[m].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="77" y="7530.6836">"changedDate": swd[m].changedDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="77" y="7545.9941">"content": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="93" y="7561.3047">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="109" y="7576.6152">"id": swd[m].content[n].settlementWindowContentId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="109" y="7591.9258">"state": swd[m].content[n].settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="381" x="109" y="7607.2363">"ledgerAccountType": swd[m].content[n].ledgerAccountType,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="109" y="7622.5469">"currencyId": swd[m].content[n].currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="109" y="7637.8574">"createdDate": swd[m].content[n].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="109" y="7653.168">"changedDate": swd[m].content[n].changedDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="93" y="7668.4785">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="7683.7891">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="7699.0996">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="45" y="7714.4102">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="45" y="7729.7207">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="7745.0313">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="77" y="7760.3418">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="77" y="7775.6523">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="93" y="7790.9629">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="109" y="7806.2734">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="109" y="7821.584">"state": "&lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="109" y="7836.8945">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="109" y="7852.2051">"externalReference": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="109" y="7867.5156">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="109" y="7882.8262">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="125" y="7898.1367">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="125" y="7913.4473">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="109" y="7928.7578">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="93" y="7944.0684">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="93" y="7959.3789">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="109" y="7974.6895">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="109" y="7990">"state": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="109" y="8005.3105">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="109" y="8020.6211">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="109" y="8035.9316">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="125" y="8051.2422">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="125" y="8066.5527">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="109" y="8081.8633">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="109" y="8097.1738">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="125" y="8112.4844">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="125" y="8127.7949">"errorDescription": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="109" y="8143.1055">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="93" y="8158.416">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="8173.7266">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="8189.0371">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="45" y="8204.3477">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="8219.6582">}</text><polygon fill="#A80036" points="352,8253.7109,342,8257.7109,352,8261.7109,348,8257.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="346" x2="518" y1="8257.7109" y2="8257.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="8252.9688">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="380" y="8252.9688">Return response</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        { "id": 1, "state": "PENDING_SETTLEMENT", "reason": <string> },
                        { "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": <string>, "externalReference": <string> },
                        { "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": <string> },
                        { "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": <string>, "externalReference": <string> },
                        { "id": 5, "state": "SETTLED", "reason": <string> }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        { "id": 6, "state": "SETTLED", "reason": <string> }
                    ]
                }
            ]
        }
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: updateSettlementById routine\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    group <color #blue>DB TRANSACTION</color>
        SETTLE_DAO -> DB: Retrieve settlement information
        activate DB
        hnote over DB #lightyellow
            SELECT s.settlementId, ssc.settlementStateId,
                ssc.reason, ssc.createdDate
            FROM **settlement** s
            JOIN **settlementStateChange** ssc
            ON ssc.settlementStateChangeId = s.currentStateChangeId
            WHERE s.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementData**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId,
                spcsc.settlementStateId, spcsc.reason,
                spcsc.createdDate, spc.netAmount, pc.currencyId,
                spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
            FROM **settlementParticipantCurrency** spc
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId =
            spc.currentStateChangeId
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementAccountsList**
        deactivate DB

        |||
        note right of SETTLE_DAO #lightblue
            All objects below are for the purpose of the syncronous request.
            If at some point, Node process memory limit is reached, we may decide to:
            A. Limit the amount of transfers per window and windows per settlement or
            B. Move to asyncronous processing where we don't need these objects
        end note
        note right of SETTLE_DAO #lightgray
            Available raw datasets from DB:
            **settlementData** contains information about settlement and its current state/reason
            **settlementAccountsList** holds information about all accounts and their current state/reason

            Local variables and objects:
            **settlementAccounts**: { // (derived from <color 0000FF>settlementAccountsList</color>)
                pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                psTransfersRecordedCount: <integer>, // count of accounts in PS_TRANSFERS_RECORDED state
                psTransfersReservedCount: <integer>, // count of accounts in PS_TRANSFERS_RESERVED state
                psTransfersCommittedCount: <integer>, // count of accounts in PS_TRANSFERS_COMMITTED state
                settledCount: <integer>, // count of accounts in SETTLED state
                abortedCount: <integer> // count of accounts in ABORTED state
            }
            **settlementAccountsInit** copy of previous object to be preserved for comparission at the end
            **allAccounts**: { // same as previous but accessed by account id (derived from <color 0000FF>settlementAccountsList</color>)
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId,
                    state: settlementStateId,
                    reason: reason,
                    createdDate: createdDate,
                    netSettlementAmount: {
                        amount: netAmount,
                        currency: currencyId
                    },
                    participantId: participantId, // could be used to reconstruct allParticipants
                    key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
                }
            }
            let **transactionTimestamp** = now()
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and initialize variables
        note right of SETTLE_DAO #lightgray
            let settlementAccounts = {
                pendingSettlementCount: 0,
                psTransfersRecordedCount: 0,
                psTransfersReservedCount: 0,
                psTransfersCommittedCount: 0,
                settledCount: 0,
                abortedCount: 0,
                unknownCount: 0
            }
            let allAccounts = {} // declare map
            let pid // participantId
            let aid // accountId (participantCurrencyId)
            let state
        end note

        loop settlementAccountsList as account
            SETTLE_DAO -> SETTLE_DAO: Populate **allAccounts**
            note right of SETTLE_DAO #lightgray
                pid = account.participantId
                aid = account.participantCurrencyId
                state = account.settlementStateId

                allAccounts[aid] = {
                    id: aid,
                    state,
                    reason: account.reason,
                    createDate: account.createdDate,
                    netSettlementAmount: {
                        amount: account.netAmount,
                        currency: account.currencyId
                    },
                    participantId: pid,
                    key: account.key
                }
            end note

            SETTLE_DAO -> SETTLE_DAO: Populate **settlementAccounts**
            alt state == 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.pendingSettlementCount++
                end note
            else state == 'PS_TRANSFERS_RECORDED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersRecordedCount++
                end note
            else state == 'PS_TRANSFERS_RESERVED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersReservedCount++
                end note
            else state == 'PS_TRANSFERS_COMMITTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersCommittedCount++
                end note
            else state == 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.settledCount++
                end note
            else state == 'ABORTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.abortedCount++
                end note
            else default
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.unknownCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of settlementAccounts into **settlementAccountsInit**
        note right of SETTLE_DAO #lightgray
            settlementAccountsInit = Object.assign({}, settlementAccounts)
        end note
        |||
        note right of SETTLE_DAO #lightgray
            Available objects after the setup:
            **settlementAccounts** is used for tracing settlement state and state transition allowance
            **allAccounts** is helper object, same as previous, providing direct access to account by id

            Now we are ready to process the **payload**:
            **participants** = [] // part of the response object that lists the affected participants and respective accounts
            **settlementParticipantCurrencyStateChange** = [] // array to collect inserts to the table
            **settlementParticipantCurrencySettledList** = [] // array to collect settled accounts
            **processedAccounts** = [] // array to log processed accounts and restrict subsequent processing
        end note
        
        loop let participant IN payload.participants
            SETTLE_DAO -> SETTLE_DAO: Loop payload for each **participantPayload**
            note right of SETTLE_DAO #lightgray
                let participantPayload = payload.participants[participant]
                participants.push({id: participantPayload.id, accounts: []})
                let pi = participants.length - 1
                participant = participants[pi]
            end note

            loop let account IN participantPayload.accounts
                SETTLE_DAO -> SETTLE_DAO: Loop payload for each **accountPayload**
                note right of SETTLE_DAO #lightgray
                    let accountPayload = participantPayload.accounts[account]
                end note
                alt allAccounts[accountPayload.id] == undefined
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the settlement
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account not found'
                            }
                        })
                    end note
                else participantPayload.id != allAccounts[accountPayload.id].participantId
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the participant
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Participant and account mismatch'
                            }
                        })
                    end note
                else processedAccounts.indexOf(accountPayload.id) > -1
                    SETTLE_DAO -> SETTLE_DAO: If the account has been previosly processed (duplicated in the payload)
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account already processed once'
                            }
                        })
                    end note
                else allAccounts[account.id].state == accountPayload.state // allowed
                    SETTLE_DAO -> SETTLE_DAO: Same-state reason amendment is always allowed
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference
                        })
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                    end note
                else settlementData.state == 'PENDING_SETTLEMENT' && accountPayload.state == 'PS_TRANSFERS_RECORDED'
                else settlementData.state == 'PS_TRANSFERS_RECORDED' && accountPayload.state == 'PS_TRANSFERS_RESERVED'
                else settlementData.state == 'PS_TRANSFERS_RESERVED' && accountPayload.state == 'PS_TRANSFERS_COMMITTED'
                else settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING' && accountPayload.state == 'SETTLED'
                    note right of SETTLE_DAO #lightgray
                        **Note**: Since we previously checked same-state, here we don't need to match
                        allAccounts[account.id].state == settlementData.state.
                    end note

                    SETTLE_DAO -> SETTLE_DAO: Settlement acknowledgement
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            <color #blue>settlementTransferId: Uuid() - - only for PS_TRANSFERS_RECORDED</color>
                        })
                        if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {
                            settlementAccounts.pendingSettlementCount- -
                            settlementAccounts.psTransfersRecordedCount++
                        } else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {
                            settlementAccounts.psTransfersRecordedCount- -
                            settlementAccounts.psTransfersReservedCount++
                        } else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {
                            settlementAccounts.psTransfersReservedCount- -
                            settlementAccounts.psTransfersCommittedCount++
                        } else if (accountPayload.state == 'SETTLED') {
                            settlementParticipantCurrencySettledIdList.push(allAccounts[accountPayload.id].key)
                            settlementAccounts.psTransfersCommittedCount- -
                            settlementAccounts.settledCount++
                        }
                        allAccounts[accountPayload.id].state = accountPayload.state
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].externalReference = accountPayload.externalReference
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                    end note
                else
                    SETTLE_DAO -> SETTLE_DAO: All other state transitions are not permitted
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: <integer>,
                                errorDescription: 'State change not allowed'
                            }
                        })
                    end note
                end
            end
        end
        group Bulk insert settlementParticipantCurrencyStateChange
            SETTLE_DAO -> DB: Insert settlementParticipantCurrencyStateChange
            activate DB
            hnote over DB #lightyellow
                settlementParticipantCurrencyStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto **settlementParticipantCurrencyIdList** in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId =
                    {settlementParticipantCurrencyStateChangeIdList},
                    <color 00F>settlementTransferId =</color>
                    <color 00F>settlementParticipantCurrencyStateChange.settlementTransferId</color>
                    <color 00F>- - only for PENDING_SETTLEMENT to PS_TRANSFERS_RECORDED</color>
                WHERE settlementParticipantCurrencyId =
                        {settlementParticipantCurrencyStateChange
                        .settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB
        end

        alt settlementData.state == 'PENDING_SETTLEMENT'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Prepare\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        else settlementData.state == 'PS_TRANSFERS_RECORDED'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Reserve\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        else settlementData.state == 'PS_TRANSFERS_RESERVED'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Commit\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        end

        group Update aggregations, contents & windows
            opt settlementParticipantCurrencySettledIdList.length > 0
                SETTLE_DAO -> DB: Change settlementWindowState where applicable 
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    settlementContentAggregation
                    settlementWindowContentStateChange
                    settlementWindowContent
                    settlementWindowStateChange
                    settlementWindow
                end hnote
            end

            SETTLE_DAO -> DB: Retrieve all affected content (incl. when settled)
            activate DB
            hnote over DB #lightyellow
                settlementContentAggregation
                settlementWindowContent
                settlementWindowContentStateChange
                ledgerAccountType
                currency
                settlementWindow
                settlementWindowStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **affectedWindowsReport**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Use previous result to produce settlementWindowsData (**swd**) array
        end

        group Prepare and insert settlementStateChange
            note right of SETTLE_DAO #lightgray
                let settlementStateChanged = true
            end note
            alt settlementData.state == 'PENDING_SETTLEMENT'\n&& settlementAccounts.pendingSettlementCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_RECORDED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RECORDED'
                end note
            else settlementData.state == 'PS_TRANSFERS_RECORDED'\n&& settlementAccounts.psTransfersRecordedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_RESERVED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RESERVED'
                end note
            else settlementData.state == 'PS_TRANSFERS_RESERVED'\n&& settlementAccounts.psTransfersReservedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_COMMITTED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_COMMITTED'
                end note
            else settlementData.state == 'PS_TRANSFERS_COMMITTED'\n&& settlementAccounts.psTransfersCommittedCount > 0\n&& settlementAccounts.settledCount > 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLING'
                    settlementData.reason = 'Some settlement accounts are SETTLED'
                end note
            else (settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING')\n&& settlementAccounts.psTransfersCommittedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLED'
                    settlementData.reason = 'All settlement accounts are SETTLED'
                end note
            else
                note right of SETTLE_DAO #lightgray
                    settlementStateChanged = false
                end note
            end
            opt settlementStateChanged == true
                note right of SETTLE_DAO #lightgray
                    settlementData.createdDate = currentTimestamp
                    settlementStateChange.push(settlementData)
                end note

                SETTLE_DAO -> DB: Insert settlementStateChange
                activate DB
                hnote over DB #lightyellow
                    settlementStateChange
                end hnote
                SETTLE_DAO <- - DB: Return **settlementStateChangeId**
                deactivate DB

                SETTLE_DAO -> DB: Update pointer to current state change id
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlement**.currentStateChangeId
                end hnote
                deactivate DB
            end
        end
    end
    SSAPI <- - SETTLE_DAO: Return transaction result
    deactivate SETTLE_DAO

    note left of SSAPI #yellow
        {
            "id": {id},
            "state": settlementData.state,
            "createdDate": settlementData.createdDate,
            "settlementWindows": [
                {
                    "id": swd[m].id,
                    "state": swd[m].state,
                    "reason": swd[m].reason,
                    "createdDate": swd[m].createdDate,
                    "changedDate": swd[m].changedDate,
                    "content": [
                        {
                            "id": swd[m].content[n].settlementWindowContentId,
                            "state": swd[m].content[n].settlementWindowStateId,
                            "ledgerAccountType": swd[m].content[n].ledgerAccountType,
                            "currencyId": swd[m].content[n].currencyId,
                            "createdDate": swd[m].content[n].createdDate,
                            "changedDate": swd[m].content[n].changedDate
                        }
                    ]
                }
            ],
            "participants": [
                {
                    "id": <integer>,
                    "accounts": [
                        {
                            "id": <integer>,
                            "state": "<string>,
                            "reason": <string>,
                            "externalReference": <string>,
                            "createdDate": <date>,
                            "netSettlementAmount": {
                                "amount": <decimal>,
                                "currency": <enum>
                            }
                        },
                        {
                            "id": <integer>,
                            "state": <string>,
                            "reason": <string>,
                            "createdDate": <date>,
                            "netSettlementAmount": {
                                "amount": <decimal>,
                                "currency": <enum>
                            },
                            "errorInformation": {
                                "errorCode": <integer>,
                                "errorDescription": <string>
                            }
                        }
                    ]
                }
            ]
        }
    end note

    SSAPI - -> OPERATOR: Return response
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.1
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>