<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1560px" preserveAspectRatio="none" style="width:1492px;height:1560px;" version="1.1" viewBox="0 0 1492 1560" width="1492px" zoomAndPan="magnify"><defs><filter height="300%" id="f9fa1pqcpmeew" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="596.5" y="23.5352">2.1.2. Settlement Model Handler Consume</text><rect fill="#FFFFE0" height="1514.9512" style="stroke: #A80036; stroke-width: 1.0;" width="1345" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="651" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="100.5" y="214.0176"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="1342.6875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="315.5" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="604.7441"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="617.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="777.6074"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="634.0547"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="831.2285"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="923.8496"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="1040.0918"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="1156.334"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="1266.2656"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="1328.6875" style="stroke: #000000; stroke-width: 2.0;" width="1468" x="13" y="135.7754"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="1297.377" style="stroke: #000000; stroke-width: 2.0;" width="1448" x="23" y="160.0859"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="527.5" x="238" y="259.0176"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="507.5" x="248" y="283.3281"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="568" x="248" y="379.2598"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1154" x="248" y="550.8125"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="574.2793" style="stroke: #000000; stroke-width: 2.0;" width="675" x="786" y="792.6074"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="358.416" style="stroke: #000000; stroke-width: 2.0;" width="655" x="796" y="1001.4707"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="235.1738" style="stroke: #000000; stroke-width: 2.0;" width="635" x="806" y="1117.7129"/><rect fill="#FFFFFF" height="109.9316" style="stroke: none; stroke-width: 1.0;" width="635" x="806" y="1242.9551"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1448" x="23" y="1403.1973"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="105" x2="105" y1="118.7754" y2="1481.4629"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="320" x2="320" y1="118.7754" y2="1481.4629"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="755" x2="755" y1="118.7754" y2="1481.4629"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="873" x2="873" y1="118.7754" y2="1481.4629"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1322" x2="1322" y1="118.7754" y2="1481.4629"/><rect fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="37" y="62.7988"/><rect fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="33" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="80.5" y="87.334">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="123" x="40" y="103.8223">settlement-model</text><rect fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="37" y="1480.4629"/><rect fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="33" y="1484.4629"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="80.5" y="1504.998">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="123" x="40" y="1521.4863">settlement-model</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="258" y="99.334">Settlement Model</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="290.5" y="115.8223">Handler</text><ellipse cx="320.5" cy="69.7988" fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="316.5,57.7988,322.5,52.7988,320.5,57.7988,322.5,62.7988,316.5,57.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="258" y="1493.998">Settlement Model</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="290.5" y="1510.4863">Handler</text><ellipse cx="320.5" cy="1529.4395" fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="316.5,1517.4395,322.5,1512.4395,320.5,1517.4395,322.5,1522.4395,316.5,1517.4395" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="709" y="79.2871"/><rect fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="705" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="712" y="103.8223">topic-event</text><rect fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="709" y="1480.4629"/><rect fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="705" y="1484.4629"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="712" y="1504.998">topic-event</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="816" y="115.8223">Settlement DAO</text><ellipse cx="873" cy="86.2871" fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="861" x2="885" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="816" y="1493.998">Settlement DAO</text><ellipse cx="873" cy="1512.9512" fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="861" x2="885" y1="1526.9512" y2="1526.9512"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1274" y="115.8223">Central Store</text><path d="M1304,66.2871 C1304,56.2871 1322,56.2871 1322,56.2871 C1322,56.2871 1340,56.2871 1340,66.2871 L1340,92.2871 C1340,102.2871 1322,102.2871 1322,102.2871 C1322,102.2871 1304,102.2871 1304,92.2871 L1304,66.2871 " fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1304,66.2871 C1304,76.2871 1322,76.2871 1322,76.2871 C1322,76.2871 1340,76.2871 1340,66.2871 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1274" y="1493.998">Central Store</text><path d="M1304,1506.9512 C1304,1496.9512 1322,1496.9512 1322,1496.9512 C1322,1496.9512 1340,1496.9512 1340,1506.9512 L1340,1532.9512 C1340,1542.9512 1322,1542.9512 1322,1542.9512 C1322,1542.9512 1304,1542.9512 1304,1532.9512 L1304,1506.9512 " fill="#FEFECE" filter="url(#f9fa1pqcpmeew)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1304,1506.9512 C1304,1516.9512 1322,1516.9512 1322,1516.9512 C1322,1516.9512 1340,1516.9512 1340,1506.9512 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="100.5" y="214.0176"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="1342.6875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="315.5" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="604.7441"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="617.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="777.6074"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="634.0547"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="831.2285"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="923.8496"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="1040.0918"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="1156.334"/><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1317" y="1266.2656"/><path d="M13,135.7754 L300,135.7754 L300,142.7754 L290,152.7754 L13,152.7754 L13,135.7754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1328.6875" style="stroke: #000000; stroke-width: 2.0;" width="1468" x="13" y="135.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="242" x="28" y="149.3438">Settlement Model Handler Consume</text><path d="M23,160.0859 L85,160.0859 L85,167.0859 L75,177.0859 L23,177.0859 L23,160.0859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1297.377" style="stroke: #000000; stroke-width: 2.0;" width="1448" x="23" y="160.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="173.6543">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="172.7207">[Consume Single Message]</text><polygon fill="#A80036" points="121.5,210.0176,111.5,214.0176,121.5,218.0176,117.5,214.0176" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115.5" x2="314.5" y1="214.0176" y2="214.0176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="127.5" y="201.6201">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="140.5" y="193.9648">Consume settlement model</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="140.5" y="209.2754">event message</text><path d="M238,259.0176 L322,259.0176 L322,266.0176 L312,276.0176 L238,276.0176 L238,259.0176 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="527.5" x="238" y="259.0176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="253" y="272.5859">break</text><path d="M248,283.3281 L390,283.3281 L390,290.3281 L380,300.3281 L248,300.3281 L248,283.3281 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="507.5" x="248" y="283.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="263" y="296.8965">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="367.5" y1="337.2598" y2="337.2598"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367.5" x2="367.5" y1="337.2598" y2="350.2598"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="326.5" x2="367.5" y1="350.2598" y2="350.2598"/><polygon fill="#A80036" points="336.5,346.2598,326.5,350.2598,336.5,354.2598,332.5,350.2598" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="332.5" y="324.8623">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="398" x="345.5" y="317.207">Validate event - Rule: type == 'setmodel' &amp;&amp; action == 'assign'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="345.5" y="332.5176">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="429.5" y="332.5176">2001</text><path d="M248,379.2598 L463,379.2598 L463,386.2598 L453,396.2598 L248,396.2598 L248,379.2598 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="568" x="248" y="379.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="263" y="392.8281">Persist Event Information</text><polygon fill="#A80036" points="743.5,438.8809,753.5,442.8809,743.5,446.8809,747.5,442.8809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="749.5" y1="442.8809" y2="442.8809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="332.5" y="438.1387">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="345.5" y="438.1387">Publish event information</text><rect fill="#FFFFFF" filter="url(#f9fa1pqcpmeew)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="550" x="255" y="450.8809"/><polygon fill="#EEEEEE" points="255,450.8809,319,450.8809,319,457.8809,309,467.8809,255,467.8809,255,450.8809" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="268" y="465.4492">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="457" y="484.4492">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="461" y="499.7598"/><path d="M248,550.8125 L535,550.8125 L535,557.8125 L525,567.8125 L248,567.8125 L248,550.8125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1154" x="248" y="550.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="242" x="263" y="564.3809">Request current Settlement Window</text><polygon fill="#A80036" points="856,600.7441,866,604.7441,856,608.7441,860,604.7441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="862" y1="604.7441" y2="604.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="332.5" y="592.3467">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="345.5" y="584.6914">Request to retrieve current/latest transfer settlement window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="345.5" y="600.002">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="422.5" y="600.002">2003</text><polygon fill="#A80036" points="1305,630.0547,1315,634.0547,1305,638.0547,1309,634.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="878" x2="1311" y1="634.0547" y2="634.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="885" y="629.3125">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="898" y="629.3125">Fetch OPEN window</text><polygon fill="#FFFFE0" filter="url(#f9fa1pqcpmeew)" points="1262,647.0547,1382,647.0547,1392,658.0547,1382,670.0547,1262,670.0547,1252,658.0547,1262,647.0547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1264" y="663.623">settlementWindow</text><polygon fill="#A80036" points="889,692.6758,879,696.6758,889,700.6758,885,696.6758" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="883" x2="1321" y1="696.6758" y2="696.6758"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="895" y="691.9336">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="908" y="691.9336">Return settlementWindowId</text><polygon fill="#A80036" points="336.5,721.9863,326.5,725.9863,336.5,729.9863,332.5,725.9863" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="330.5" x2="872" y1="725.9863" y2="725.9863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="342.5" y="721.2441">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="355.5" y="721.2441">Return settlementWindowId</text><polygon fill="#A80036" points="856,773.6074,866,777.6074,856,781.6074,860,777.6074" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="325.5" x2="862" y1="777.6074" y2="777.6074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="332.5" y="765.21">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="345.5" y="757.5547">Assign window and transferParicipant state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="345.5" y="772.8652">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="422.5" y="772.8652">2003</text><path d="M786,792.6074 L951,792.6074 L951,799.6074 L941,809.6074 L786,809.6074 L786,792.6074 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="574.2793" style="stroke: #000000; stroke-width: 2.0;" width="675" x="786" y="792.6074"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="801" y="806.1758">DB TRANSACTION</text><polygon fill="#A80036" points="1305,827.2285,1315,831.2285,1305,835.2285,1309,831.2285" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="878" x2="1311" y1="831.2285" y2="831.2285"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="885" y="826.4863">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="898" y="826.4863">Assign settlement window id</text><polygon fill="#FFFFE0" filter="url(#f9fa1pqcpmeew)" points="1263,874.2285,1380,874.2285,1390,885.2285,1380,897.2285,1263,897.2285,1253,885.2285,1263,874.2285" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1265" y="890.7969">transferFulfilment</text><polygon fill="#A80036" points="1305,919.8496,1315,923.8496,1305,927.8496,1309,923.8496" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="878" x2="1311" y1="923.8496" y2="923.8496"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="885" y="919.1074">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="907" y="919.1074">Fetch transfer participant entries</text><polygon fill="#FFFFE0" filter="url(#f9fa1pqcpmeew)" points="1262,936.8496,1382,936.8496,1392,947.8496,1382,959.8496,1262,959.8496,1252,947.8496,1262,936.8496" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1264" y="953.418">transferParticipant</text><polygon fill="#A80036" points="889,982.4707,879,986.4707,889,990.4707,885,986.4707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="883" x2="1321" y1="986.4707" y2="986.4707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="895" y="981.7285">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="917" y="981.7285">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="962" y="981.7285">transferParticipantRecords</text><path d="M796,1001.4707 L870,1001.4707 L870,1008.4707 L860,1018.4707 L796,1018.4707 L796,1001.4707 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="358.416" style="stroke: #000000; stroke-width: 2.0;" width="655" x="796" y="1001.4707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="811" y="1015.0391">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="162" x="885" y="1014.1055">[for each transferParticipant]</text><polygon fill="#A80036" points="1305,1036.0918,1315,1040.0918,1305,1044.0918,1309,1040.0918" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="878" x2="1311" y1="1040.0918" y2="1040.0918"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="885" y="1035.3496">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="907" y="1035.3496">Get settlement model by currency and ledger entry</text><polygon fill="#FFFFE0" filter="url(#f9fa1pqcpmeew)" points="1267,1053.0918,1376,1053.0918,1386,1064.0918,1376,1076.0918,1267,1076.0918,1257,1064.0918,1267,1053.0918" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="1269" y="1069.6602">settlementModel</text><polygon fill="#A80036" points="889,1098.7129,879,1102.7129,889,1106.7129,885,1102.7129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="883" x2="1321" y1="1102.7129" y2="1102.7129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="895" y="1097.9707">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="917" y="1097.9707">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="962" y="1097.9707">settlementModel</text><path d="M806,1117.7129 L873,1117.7129 L873,1124.7129 L863,1134.7129 L806,1134.7129 L806,1117.7129 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="235.1738" style="stroke: #000000; stroke-width: 2.0;" width="635" x="806" y="1117.7129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="821" y="1131.2813">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="472" x="888" y="1130.3477">[settlementModel.delay == 'IMMEDIATE' || settlementModel.granularity == 'GROSS']</text><polygon fill="#A80036" points="1305,1152.334,1315,1156.334,1305,1160.334,1309,1156.334" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="878" x2="1311" y1="1156.334" y2="1156.334"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="885" y="1151.5918">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="398" x="907" y="1151.5918">Set state: OPEN-&gt;CLOSED-&gt;PENDING_SETTLEMENT-&gt;SETTLED</text><polygon fill="#FFFFE0" filter="url(#f9fa1pqcpmeew)" points="1223,1199.334,1421,1199.334,1431,1218.334,1421,1237.334,1223,1237.334,1213,1218.334,1223,1199.334" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1225" y="1215.9023">transferParticipantStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1225" y="1231.2129">transferParticipant</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="806" x2="1441" y1="1243.9551" y2="1243.9551"/><polygon fill="#A80036" points="1305,1262.2656,1315,1266.2656,1305,1270.2656,1309,1266.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="878" x2="1311" y1="1266.2656" y2="1266.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="885" y="1261.5234">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="907" y="1261.5234">Set state: OPEN</text><polygon fill="#FFFFE0" filter="url(#f9fa1pqcpmeew)" points="1223,1309.2656,1421,1309.2656,1431,1328.2656,1421,1347.2656,1223,1347.2656,1213,1328.2656,1223,1309.2656" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1225" y="1325.834">transferParticipantStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1225" y="1341.1445">transferParticipant</text><polygon fill="#A80036" points="336.5,1391.1973,326.5,1395.1973,336.5,1399.1973,332.5,1395.1973" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="330.5" x2="872" y1="1395.1973" y2="1395.1973"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="342.5" y="1390.4551">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="364.5" y="1390.4551">Return success</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1471" y1="1404.1973" y2="1404.1973"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="1414.832">[Consume Batch Messages]</text><path d="M92,1423.1523 L92,1448.1523 L306,1448.1523 L306,1433.1523 L296,1423.1523 L92,1423.1523 " fill="#ADD8E6" filter="url(#f9fa1pqcpmeew)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M296,1423.1523 L296,1433.1523 L306,1433.1523 L296,1423.1523 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="98" y="1440.7207">To be delivered by future story</text><!--
@startuml
title 2.1.2. Settlement Model Handler Consume
autonumber
collections "topic-\nsettlement-model" as TOPIC_SETMODEL
control "Settlement Model\nHandler" as SETMODEL_HANDLER
collections "topic-event" as TOPIC_EVENT
entity "Settlement DAO" as SET_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_SETMODEL
    participant SETMODEL_HANDLER
    participant TOPIC_EVENT
    participant SET_DAO
    participant DB
end box

activate SETMODEL_HANDLER
group Settlement Model Handler Consume
    alt Consume Single Message
        TOPIC_SETMODEL <- SETMODEL_HANDLER: Consume settlement model\nevent message
        activate TOPIC_SETMODEL
        deactivate TOPIC_SETMODEL
        break
            group Validate Event
                SETMODEL_HANDLER <-> SETMODEL_HANDLER: Validate event - Rule: type == 'setmodel' && action == 'assign'\n<color #FF0000><b>Error codes:</b> 2001</color>
            end
        end
        group Persist Event Information
            |||
            SETMODEL_HANDLER -> TOPIC_EVENT: Publish event information
            ref over SETMODEL_HANDLER, TOPIC_EVENT:  Event Handler Consume\n
            |||
        end

        group Request current Settlement Window
            SETMODEL_HANDLER -> SET_DAO: Request to retrieve current/latest transfer settlement window\n<color #FF0000><b>Error code:</b> 2003</color>
            activate SET_DAO
            SET_DAO -> DB: Fetch OPEN window
            activate DB
            hnote over DB #lightyellow
                settlementWindow
            end note
            DB - -> SET_DAO: Return settlementWindowId
            deactivate DB
            SETMODEL_HANDLER <- - SET_DAO: Return settlementWindowId
            deactivate SET_DAO
        end

        SETMODEL_HANDLER -> SET_DAO: Assign window and transferParicipant state\n<color #FF0000><b>Error code:</b> 2003</color>
        activate SET_DAO
        group <color #blue>DB TRANSACTION</color>
            SET_DAO -> DB: Assign settlement window id
            activate DB
            hnote over DB #lightyellow
                transferFulfilment
            end note
            deactivate DB

            SET_DAO -> DB: Fetch transfer participant entries
            activate DB
            hnote over DB #lightyellow
                transferParticipant
            end note
            DB - -> SET_DAO: Return **transferParticipantRecords**
            deactivate DB

            loop for each transferParticipant
                SET_DAO -> DB: Get settlement model by currency and ledger entry
                activate DB
                hnote over DB #lightyellow
                    settlementModel
                end note
                DB - -> SET_DAO: Return **settlementModel**
                deactivate DB

                opt settlementModel.delay == 'IMMEDIATE' || settlementModel.granularity == 'GROSS'
                    SET_DAO -> DB: Set state: OPEN->CLOSED->PENDING_SETTLEMENT->SETTLED
                    activate DB
                    hnote over DB #lightyellow
                        transferParticipantStateChange
                        transferParticipant
                    end note
                    deactivate DB
                else
                    SET_DAO -> DB: Set state: OPEN
                    activate DB
                    hnote over DB #lightyellow
                        transferParticipantStateChange
                        transferParticipant
                    end note
                    deactivate DB
                end

            end
        end
        SETMODEL_HANDLER <- - SET_DAO: Return success
        deactivate SET_DAO
    else Consume Batch Messages
        note left of SETMODEL_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate SETMODEL_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.3
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>