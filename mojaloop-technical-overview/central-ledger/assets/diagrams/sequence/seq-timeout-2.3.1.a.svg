<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2390px" preserveAspectRatio="none" style="width:1126px;height:2390px;" version="1.1" viewBox="0 0 1126 2390" width="1126px" zoomAndPan="magnify"><defs><filter height="300%" id="f1oj3ru31ffbab" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="449" y="23.5352">2.3.1.a Timeout Prepare Handler</text><rect fill="#FFFFE0" height="2345.3789" style="stroke: #A80036; stroke-width: 1.0;" width="960" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="468.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="2166.1152" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="98" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="2242.8906"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="581.5" y="1516.8926"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="167.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="691" y="320.2598"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="691" y="548.7441"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="942" y="349.5703"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="942" y="578.0547"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="2159.1152" style="stroke: #000000; stroke-width: 2.0;" width="1102" x="13" y="135.7754"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="107.5527" style="stroke: #000000; stroke-width: 2.0;" width="614" x="33" y="160.0859"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="214.4844" style="stroke: #000000; stroke-width: 2.0;" width="1033" x="33" y="281.6387"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="198.4844" style="stroke: #000000; stroke-width: 2.0;" width="1072" x="33" y="510.123"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="1565.2832" style="stroke: #000000; stroke-width: 2.0;" width="634" x="23" y="722.6074"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="1454.3516" style="stroke: #000000; stroke-width: 2.0;" width="614" x="33" y="826.5391"/><rect fill="#FFFFFF" height="725.998" style="stroke: none; stroke-width: 1.0;" width="614" x="33" y="1554.8926"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="103" x2="103" y1="118.7754" y2="2311.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="346" x2="346" y1="118.7754" y2="2311.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="476" x2="476" y1="118.7754" y2="2311.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="586" x2="586" y1="118.7754" y2="2311.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="696" x2="696" y1="118.7754" y2="2311.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="947" x2="947" y1="118.7754" y2="2311.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="43" y="99.334">Timeout Prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="73" y="115.8223">Handler</text><ellipse cx="103" cy="69.7988" fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="99,57.7988,105,52.7988,103,57.7988,105,62.7988,99,57.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="43" y="2324.4258">Timeout Prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="73" y="2340.9141">Handler</text><ellipse cx="103" cy="2359.8672" fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="99,2347.8672,105,2342.8672,103,2347.8672,105,2352.8672,99,2347.8672" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="280" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="276" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="325" y="87.334">topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="283" y="103.8223">transfer-position</text><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="280" y="2310.8906"/><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="276" y="2314.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="325" y="2335.4258">topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="283" y="2351.9141">transfer-position</text><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="430" y="62.7988"/><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="426" y="66.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="451" y="87.334">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="433" y="103.8223">notification</text><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="430" y="2310.8906"/><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="426" y="2314.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="451" y="2335.4258">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="433" y="2351.9141">notification</text><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="540" y="79.2871"/><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="536" y="83.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="543" y="103.8223">topic-event</text><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="540" y="2310.8906"/><rect fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="536" y="2314.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="543" y="2335.4258">topic-event</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="647" y="115.8223">Timeout DAO</text><ellipse cx="696" cy="86.2871" fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="684" x2="708" y1="100.2871" y2="100.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="647" y="2324.4258">Timeout DAO</text><ellipse cx="696" cy="2343.3789" fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="684" x2="708" y1="2357.3789" y2="2357.3789"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="899" y="115.8223">Central Store</text><path d="M929,66.2871 C929,56.2871 947,56.2871 947,56.2871 C947,56.2871 965,56.2871 965,66.2871 L965,92.2871 C965,102.2871 947,102.2871 947,102.2871 C947,102.2871 929,102.2871 929,92.2871 L929,66.2871 " fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M929,66.2871 C929,76.2871 947,76.2871 947,76.2871 C947,76.2871 965,76.2871 965,66.2871 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="899" y="2324.4258">Central Store</text><path d="M929,2337.3789 C929,2327.3789 947,2327.3789 947,2327.3789 C947,2327.3789 965,2327.3789 965,2337.3789 L965,2363.3789 C965,2373.3789 947,2373.3789 947,2373.3789 C947,2373.3789 929,2373.3789 929,2363.3789 L929,2337.3789 " fill="#FEFECE" filter="url(#f1oj3ru31ffbab)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M929,2337.3789 C929,2347.3789 947,2347.3789 947,2347.3789 C947,2347.3789 965,2347.3789 965,2337.3789 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="2166.1152" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="98" y="128.7754"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="2242.8906"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="581.5" y="1516.8926"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="167.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="691" y="320.2598"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="691" y="548.7441"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="942" y="349.5703"/><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="942" y="578.0547"/><path d="M13,135.7754 L229,135.7754 L229,142.7754 L219,152.7754 L13,152.7754 L13,135.7754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2159.1152" style="stroke: #000000; stroke-width: 2.0;" width="1102" x="13" y="135.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="28" y="149.3438">Timeout Prepare Handler</text><path d="M33,160.0859 L248,160.0859 L248,167.0859 L238,177.0859 L33,177.0859 L33,160.0859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="107.5527" style="stroke: #000000; stroke-width: 2.0;" width="614" x="33" y="160.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="48" y="173.6543">Persist Event Information</text><polygon fill="#A80036" points="574.5,194.707,584.5,198.707,574.5,202.707,578.5,198.707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108" x2="580.5" y1="198.707" y2="198.707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="115" y="193.9648">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="128" y="193.9648">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1oj3ru31ffbab)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="596" x="40" y="206.707"/><polygon fill="#EEEEEE" points="40,206.707,104,206.707,104,213.707,94,223.707,40,223.707,40,206.707" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="53" y="221.2754">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="265" y="240.2754">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="269" y="255.5859"/><path d="M33,281.6387 L134,281.6387 L134,288.6387 L124,298.6387 L33,298.6387 L33,281.6387 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="214.4844" style="stroke: #000000; stroke-width: 2.0;" width="1033" x="33" y="281.6387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="56" x="48" y="295.207">Cleanup</text><polygon fill="#A80036" points="679,316.2598,689,320.2598,679,324.2598,683,320.2598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108" x2="685" y1="320.2598" y2="320.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="115" y="315.5176">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="128" y="315.5176">Cleanup Fulfilled Transfers</text><polygon fill="#A80036" points="930,345.5703,940,349.5703,930,353.5703,934,349.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="701" x2="936" y1="349.5703" y2="349.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="708" y="344.8281">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="721" y="344.8281">Delete fuflfilled transfers records</text><polygon fill="#FFFFE0" filter="url(#f1oj3ru31ffbab)" points="848,392.5703,1046,392.5703,1056,426.5703,1046,461.5703,848,461.5703,838,426.5703,848,392.5703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="850" y="409.1387">DELETE et</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="850" y="424.4492">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="890" y="424.4492">expiringTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="1009" y="424.4492">et</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="850" y="439.7598">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="882" y="439.7598">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1008" y="439.7598">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="850" y="455.0703">ON tf.transferId = et.transferId</text><polygon fill="#A80036" points="119,484.123,109,488.123,119,492.123,115,488.123" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="113" x2="695" y1="488.123" y2="488.123"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="125" y="483.3809">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="138" y="483.3809">Return success</text><path d="M33,510.123 L158,510.123 L158,517.123 L148,527.123 L33,527.123 L33,510.123 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="198.4844" style="stroke: #000000; stroke-width: 2.0;" width="1072" x="33" y="510.123"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="48" y="523.6914">List Expired</text><polygon fill="#A80036" points="679,544.7441,689,548.7441,679,552.7441,683,548.7441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108" x2="685" y1="548.7441" y2="548.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="115" y="544.002">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="128" y="544.002">Retrieve Expired Transfers</text><polygon fill="#A80036" points="930,574.0547,940,578.0547,930,582.0547,934,578.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="701" x2="936" y1="578.0547" y2="578.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="708" y="573.3125">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="721" y="573.3125">Select using index</text><polygon fill="#FFFFE0" filter="url(#f1oj3ru31ffbab)" points="808,591.0547,1085,591.0547,1095,617.0547,1085,644.0547,808,644.0547,798,617.0547,808,591.0547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="810" y="607.623">SELECT *</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="810" y="622.9336">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="850" y="622.9336">expiringTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="810" y="638.2441">WHERE expirationDate &lt; currentTimestamp</text><polygon fill="#A80036" points="712,667.2969,702,671.2969,712,675.2969,708,671.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="706" x2="946" y1="671.2969" y2="671.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="718" y="666.5547">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="731" y="666.5547">Return expired transfers</text><polygon fill="#A80036" points="119,696.6074,109,700.6074,119,704.6074,115,700.6074" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="113" x2="695" y1="700.6074" y2="700.6074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="125" y="695.8652">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="138" y="695.8652">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="141" x="183" y="695.8652">expiredTransfersList</text><path d="M23,722.6074 L97,722.6074 L97,729.6074 L87,739.6074 L23,739.6074 L23,722.6074 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1565.2832" style="stroke: #000000; stroke-width: 2.0;" width="634" x="23" y="722.6074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="736.1758">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="160" x="112" y="735.2422">[for each transfer in the list]</text><path d="M113,769.918 L113,809.918 L566,809.918 L566,779.918 L556,769.918 L113,769.918 " fill="#D3D3D3" filter="url(#f1oj3ru31ffbab)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M556,769.918 L556,779.918 L566,779.918 L556,769.918 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="119" y="787.4863">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="160" y="787.4863">:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="168" y="787.4863">Red</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="195" y="787.4863">in the bellow messages is to be discussed with the DA</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="119" y="802.7969">during review because at this point the referred data is not available.</text><path d="M33,826.5391 L95,826.5391 L95,833.5391 L85,843.5391 L33,843.5391 L33,826.5391 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1454.3516" style="stroke: #000000; stroke-width: 2.0;" width="614" x="33" y="826.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="48" y="840.1074">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="110" y="839.1738">[transferStateId == 'RECEIVED_PREPARE']</text><path d="M113,848.8496 L113,1485.8496 L517,1485.8496 L517,858.8496 L507,848.8496 L113,848.8496 " fill="#FFFF00" filter="url(#f1oj3ru31ffbab)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M507,848.8496 L507,858.8496 L517,858.8496 L507,848.8496 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="119" y="866.418">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="119" y="881.7285">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="135" y="897.0391">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="135" y="912.3496">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="135" y="927.6602">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="135" y="942.9707">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="135" y="958.2813">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="151" y="973.5918"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="151" y="973.5918">headers:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="208" y="973.5918">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="167" y="988.9023">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="167" y="1004.2129">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="167" y="1019.5234">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="167" y="1034.834">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="167" y="1050.1445">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="167" y="1065.4551">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="167" y="1080.7656">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="167" y="1096.0762">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="167" y="1111.3867">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="167" y="1126.6973">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="151" y="1142.0078">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="151" y="1157.3184">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="171" y="1172.6289">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="187" y="1187.9395">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="187" y="1203.25">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="187" y="1218.5605">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="171" y="1233.8711">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="151" y="1249.1816">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="135" y="1264.4922">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="135" y="1279.8027">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="151" y="1295.1133">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="167" y="1310.4238">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="167" y="1325.7344">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="167" y="1341.0449">action: timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="167" y="1356.3555">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="167" y="1371.666">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="183" y="1386.9766">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="183" y="1402.2871">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="183" y="1417.5977">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="167" y="1432.9082">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="151" y="1448.2188">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="135" y="1463.5293">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="119" y="1478.8398">}</text><polygon fill="#A80036" points="569.5,1512.8926,579.5,1516.8926,569.5,1520.8926,573.5,1516.8926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108" x2="575.5" y1="1516.8926" y2="1516.8926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="115" y="1512.1504">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="128" y="1512.1504">Publish Notification event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="647" y1="1555.8926" y2="1555.8926"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="38" y="1566.5273">[transferStateId == 'RESERVED']</text><path d="M113,1574.8477 L113,2211.8477 L513,2211.8477 L513,1584.8477 L503,1574.8477 L113,1574.8477 " fill="#FFFF00" filter="url(#f1oj3ru31ffbab)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M503,1574.8477 L503,1584.8477 L513,1584.8477 L503,1574.8477 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="119" y="1592.416">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="119" y="1607.7266">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="135" y="1623.0371">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="135" y="1638.3477">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="135" y="1653.6582">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="135" y="1668.9688">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="135" y="1684.2793">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="151" y="1699.5898"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="151" y="1699.5898">headers:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="208" y="1699.5898">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="167" y="1714.9004">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="167" y="1730.2109">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="167" y="1745.5215">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="167" y="1760.832">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="167" y="1776.1426">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="167" y="1791.4531">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="167" y="1806.7637">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="167" y="1822.0742">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="167" y="1837.3848">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="167" y="1852.6953">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="151" y="1868.0059">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="151" y="1883.3164">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="167" y="1898.627">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="183" y="1913.9375">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="183" y="1929.248">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="183" y="1944.5586">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="167" y="1959.8691">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="151" y="1975.1797">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="135" y="1990.4902">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="135" y="2005.8008">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="151" y="2021.1113">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="167" y="2036.4219">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="167" y="2051.7324">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="167" y="2067.043">action: timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="167" y="2082.3535">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="167" y="2097.6641">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="183" y="2112.9746">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="183" y="2128.2852">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="183" y="2143.5957">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="167" y="2158.9063">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="151" y="2174.2168">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="135" y="2189.5273">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="119" y="2204.8379">}</text><polygon fill="#A80036" points="329,2238.8906,339,2242.8906,329,2246.8906,333,2242.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108" x2="335" y1="2242.8906" y2="2242.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="115" y="2238.1484">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="137" y="2238.1484">Route &amp; Publish Position event</text><!--
@startuml
title 2.3.1.a Timeout Prepare Handler 

autonumber


control "Timeout Prepare\nHandler" as TIMEOUT_PREP_HANDLER
collections "topic\ntransfer-position" as TOPIC_TRANSFER_POSITION
collections "topic-\nnotification" as NOTIFICATIONS_TOPIC
collections "topic-event" as EVENT_TOPIC
entity "Timeout DAO" as TIMEOUT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TIMEOUT_PREP_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant NOTIFICATIONS_TOPIC
    participant EVENT_TOPIC
    participant TIMEOUT_DAO
    participant DB
end box


group Timeout Prepare Handler
    activate TIMEOUT_PREP_HANDLER
    group Persist Event Information
        TIMEOUT_PREP_HANDLER -> EVENT_TOPIC: Publish event information
        ref over TIMEOUT_PREP_HANDLER, EVENT_TOPIC :  Event Handler Consume\n
    end

    group Cleanup
        TIMEOUT_PREP_HANDLER -> TIMEOUT_DAO: Cleanup Fulfilled Transfers
        activate TIMEOUT_DAO
        TIMEOUT_DAO -> DB: Delete fuflfilled transfers records
                activate DB
        deactivate DB
        hnote over DB #lightyellow
            DELETE et
            FROM **expiringTransfer** et
            JOIN **transferFulfilment** tf
            ON tf.transferId = et.transferId
        end note
        TIMEOUT_DAO - -> TIMEOUT_PREP_HANDLER: Return success
        deactivate TIMEOUT_DAO
    end

    group List Expired
        TIMEOUT_PREP_HANDLER -> TIMEOUT_DAO: Retrieve Expired Transfers
        activate TIMEOUT_DAO
        TIMEOUT_DAO -> DB: Select using index
        activate DB
        hnote over DB #lightyellow
            SELECT *
            FROM **expiringTransfer**
            WHERE expirationDate < currentTimestamp
        end note
        TIMEOUT_DAO <- - DB: Return expired transfers
        deactivate DB
        TIMEOUT_DAO - -> TIMEOUT_PREP_HANDLER: Return **expiredTransfersList**
        deactivate TIMEOUT_DAO
    end

    loop for each transfer in the list
        |||
        note right of TIMEOUT_PREP_HANDLER #lightgray
            **TODO**: <color #FF0000>Red</color> in the bellow messages is to be discussed with the DA 
            during review because at this point the referred data is not available.
        end note

        alt transferStateId == 'RECEIVED_PREPARE'
            note right of TIMEOUT_PREP_HANDLER #yellow
                Message:
                {
                    id: <transferId>,
                    from: <payerParticipantId>,
                    to: <payeeParticipantId>,
                    type: application/json,
                    content: {
                        <color #FF0000>headers:</color> {
                            Content-Length: <Content-Length>,
                            Content-Type: <Content-Type>,
                            Date: <Date>,
                            X-Forwarded-For: <X-Forwarded-For>,
                            FSPIOP-Source: <FSPIOP-Source>,
                            FSPIOP-Destination: <FSPIOP-Destination>,
                            FSPIOP-Encryption: <FSPIOP-Encryption>,
                            FSPIOP-Signature: <FSPIOP-Signature>,
                            FSPIOP-URI: <FSPIOP-URI>,
                            FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                        },
                        payload: {
                             "errorInformation": {
                                 "errorCode": 3303,
                                 "errorDescription": "Transfer expired",
                                 "extensionList": <transferMessage.extensionList>
                             }
                        }
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            type: notification,
                            action: timeout-received,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <errorInformation.errorCode>
                                description: <errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            TIMEOUT_PREP_HANDLER -> EVENT_TOPIC: Publish Notification event
            activate EVENT_TOPIC
            deactivate EVENT_TOPIC
        else transferStateId == 'RESERVED'
            note right of TIMEOUT_PREP_HANDLER #yellow
                Message:
                {
                    id: <transferId>,
                    from: <payerParticipantId>,
                    to: <payeeParticipantId>,
                    type: application/json,
                    content: {
                        <color #FF0000>headers:</color> {
                            Content-Length: <Content-Length>,
                            Content-Type: <Content-Type>,
                            Date: <Date>,
                            X-Forwarded-For: <X-Forwarded-For>,
                            FSPIOP-Source: <FSPIOP-Source>,
                            FSPIOP-Destination: <FSPIOP-Destination>,
                            FSPIOP-Encryption: <FSPIOP-Encryption>,
                            FSPIOP-Signature: <FSPIOP-Signature>,
                            FSPIOP-URI: <FSPIOP-URI>,
                            FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                        },
                        payload: {
                            "errorInformation": {
                                "errorCode": 3303,
                                "errorDescription": "Transfer expired",
                                "extensionList": <transferMessage.extensionList>
                            }
                        }
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            type: position,
                            action: timeout-reserved,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <errorInformation.errorCode>
                                description: <errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            TIMEOUT_PREP_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event
            activate TOPIC_TRANSFER_POSITION
            deactivate TOPIC_TRANSFER_POSITION
        end

    end

    deactivate TIMEOUT_PREP_HANDLER
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.15.1
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>